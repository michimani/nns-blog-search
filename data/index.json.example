[
  {
    "contents": "Lambda é–¢æ•°ã«å¯¾ã—ã¦ URL ã‚’ç™ºè¡Œã—ã¦å¤–éƒ¨ã‹ã‚‰ HTTP ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ Function URLs ã§ã™ãŒã€ãã®ã¾ã¾ã ã¨è‡ªå‹•ã§ç™ºè¡Œã•ã‚Œã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ä»Šå›ã¯ã€ä»»æ„ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ Function URLs ã‚’åˆ©ç”¨ã™ã‚‹æ§‹æˆã‚’ AWS CDK ã‚’ä½¿ã£ã¦æ§‹ç¯‰ã—ã¦ã¿ãŸè©±ã§ã™ã€‚\næ§‹æˆã«ã¤ã„ã¦ã¯æ§‹æˆå›³ã‚’è¦‹ã‚Œã°ã‚ã‹ã‚‹ã®ã§ã€è¨˜äº‹ã®å†…å®¹ã¨ã—ã¦ã¯ AWS CDK ã§ã®å®Ÿè£…ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¶³ã—ã¦ã„ãã‚ˆã†ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚\nã¾ãˆãŒã æ§‹æˆå›³ AWS CDK ã§ä½œæˆã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ Route 53 Certificate Manager CloudFront Lambda ã¾ã¨ã‚ ã¾ãˆãŒã ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚‚ã‚ã‚‹é€šã‚Šã€ Lambda Function URLs ã‚’ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ä½¿ã†æ§‹æˆã‚’ AWS CDK v2 (Go) ã§æ§‹ç¯‰ã—ã¦ã¿ã¾ã™ã€‚\nAWS CDK: 2.64.0 Go: 1.20 Function URLs ã‚’ä½¿ã£ã¦ Lambda é–¢æ•°ã«å¯¾ã—ã¦ URL ã‚’ç™ºè¡Œã™ã‚‹ã¨ã€ãƒ©ãƒ³ãƒ€ãƒ ãªè‹±æ•°å­—ã‚’å«ã‚“ã ä¸‹è¨˜ã®ã‚ˆã†ãª URL ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚\nhttps://{ãƒ©ãƒ³ãƒ€ãƒ ãªè‹±æ•°å­—}.lambda-url.{ãƒªãƒ¼ã‚¸ãƒ§ãƒ³}.on.aws/ ä»Šå›ã¯ã€ å‰æ®µã« CloudFront ã‚’é…ç½®ã™ã‚‹ã“ã¨ã§ä»»æ„ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ Function URLs ã«ã‚ˆã‚‹ Lambda é–¢æ•°ã®å®Ÿè¡ŒãŒã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚\nã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã«ç½®ã„ã¦ã‚ã‚‹ã®ã§ã€ãŠæ‰‹å…ƒã§ã‚‚è©¦ã—ã¦ã„ãŸã ã‘ã¾ã™ã€‚\naws-cdk-go-examples/lambda-function-urls-with-custom-domain at main Â· michimani/aws-cdk-go-examples æ§‹æˆå›³ æ§‹æˆå›³ã¨ã—ã¦ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\nC4Component Container_Boundary(r53, \"Route 53\") { Component(h, \"HostedZone\", \"hosted zone\",\"imported by HostedZoneID\") Component(r, \"RecordSet\", \"custom domain record\",\"e.g) api.example.com -\u003e xxxxxx.cloudfront.net\") Rel(r, h, \"\") } Container_Boundary(acm, \"Certificate Manager\") { Component(c, \"Certificate\", \"SSL Certificate\", \"imported by ARN\") } Container_Boundary(cf,\"CloudFront\") { Component(oap, \"Origin Access Policy\", \"\", \"\") Component(dist, \"Distribution\", \"\", \"\") Component(cp, \"Cache Policy\", \"\", \"\") Rel_L(dist, cp, \"\", \"\") Rel_L(dist, oap,\"\", \"\") } Container_Boundary(lambda, \"Lambda\") { Component(url1, \"Function URL\", \"\", \"for default behavior\") Component(url2, \"Function URL\", \"\", \"for hello behavior\") Component(url3, \"Function URL\", \"\", \"for bye behavior\") Component(fn1, \"Function\", \"\", \"simple-response-default\") Component(fn2, \"Function\", \"\", \"simple-response-hello\") Component(fn3, \"Function\", \"\", \"simple-response-bye\") Rel(url1, fn1, \"\",\"\") Rel(url2, fn2, \"\",\"\") Rel(url3, fn3, \"\",\"\") } Rel_D(dist, c, \"\", \"\") Rel_D(r, dist, \"\", \"\") Rel_D(dist, url1, \"\",\"default\") Rel_D(dist, url2, \"\",\"/hello pattern\") Rel_D(dist, url3, \"\",\"/bye pattern\") UpdateElementStyle(h, $bgColor=\"grey\") UpdateElementStyle(c, $bgColor=\"grey\") UpdateLayoutConfig($c4ShapeInRow=\"3\", $c4BoundaryInRow=\"1\") Lambda é–¢æ•°ã‚’ 3 ã¤ç”¨æ„ã—ã¦ãã‚Œãã‚Œã« Function URL ã‚’ç™ºè¡Œã€CloudFront ã® Behavior ã§ãã‚Œãã‚Œã® Function URL ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåˆ†é…ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚\nèƒŒæ™¯ãŒæ°´è‰²ã«ãªã£ã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’ AWS CDK ã§æ§‹ç¯‰ã—ã¾ã™ã€‚ç°è‰²ã«ãªã£ã¦ã„ã‚‹ Route53:HostedZone ã¨ CertificateManager:Certificate ã¯ã€ã‚ã‚‰ã‹ã˜ã‚ä½œæˆã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’ HostedZoneID ã¨ ZoneName ãŠã‚ˆã³ ARN ã§ãã‚Œãã‚Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚\nAWS CDK ã§ä½œæˆã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ ä»Šå›ã¯ Route 53, Certificate Manager, CloudFront, Lambda ã«é–¢é€£ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚\nRoute 53 Route 53 é–¢é€£ã§ã¯ã€ ä»»æ„ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ CloudFront ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¯¾ã™ã‚‹ A ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ãªã‚‹ RecordSet ã‚’ä½œæˆã—ã¾ã™ã€‚ãã®éš›ã€ RecordSet ã‚’ç´ä»˜ã‹ã›ã‚‹ HostedZone ãŒå¿…è¦ã«ãªã‚Šã¾ã™ãŒã€ã“ã‚Œã«ã¤ã„ã¦ã¯æ—¢ã«å­˜åœ¨ã—ã¦ã„ã‚‹ HostedZone ã‚’ HostedZoneID ã¨ ZoneName ã‚’ã‚‚ã¨ã«ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚\nhostedZone := awsroute53.HostedZone_FromHostedZoneAttributes(scope, jsii.String(\u0026#34;MyHostedZone\u0026#34;), \u0026amp;awsroute53.HostedZoneAttributes{ HostedZoneId: \u0026amp;hostedZoneID, ZoneName: \u0026amp;zoneName, }) ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸ HostedZone ã‚’ä½¿ã£ã¦ã€ CloudFront ã«å¯¾ã™ã‚‹ A ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚ CloudFront ã«å¯¾ã™ã‚‹ A ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã¤ã„ã¦ã¯ awsroute53targets.NewCloudFrontTarget() ã‚’ä½¿ã£ã¦ä½œæˆã§ãã¾ã™ã€‚\n// scope constructs.Construct // dist awscloudfront.Distribution // subDomain string // ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ Lambda é–¢æ•°ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ aliasTarget := awsroute53.RecordTarget_FromAlias( awsroute53targets.NewCloudFrontTarget(dist), ) props := \u0026amp;awsroute53.RecordSetProps{ RecordName: jsii.String(subDomain), RecordType: awsroute53.RecordType_A, Zone: hostedZone, Target: aliasTarget, } awsroute53.NewRecordSet(scope, jsii.String(\u0026#34;RecordSet\u0026#34;), props) aws-cdk-go-examples/route53.go at main Â· michimani/aws-cdk-go-examples Certificate Manager Certificate Manager ã«ã¤ã„ã¦ã¯ã€æ—¢ã«å­˜åœ¨ã—ã¦ã„ã‚‹ Certificate ã‚’ ARN ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚\nceritificate := awscertificatemanager.Certificate_FromCertificateArn( stack, jsii.String(\u0026#34;ImportedCertificate\u0026#34;), jsii.String(\u0026#34;arn:aws:acm:us-east-1:000000000000:certificate/hoge\u0026#34;)) CloudFront CloudFront é–¢é€£ã§ã¯ã€ CachePolicy, OriginRequestPolicy, Distribution ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚ ãã‚Œãã‚Œç‰¹ã«é›£ã—ã„ã¨ã“ã‚ã¯ãªã„1 ã®ã§ã™ãŒã€ Distribution ã®ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒªã‚¸ãƒ³ã¨ã—ã¦ Function URL ã® ãƒ‰ãƒ¡ã‚¤ãƒ³ ã‚’ã—ã¦ã„ã™ã‚‹ã¨ã“ã‚ã§å°ç´°å·¥ãŒå¿…è¦ã§ã—ãŸã€‚ Distribution ã®ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒªã‚¸ãƒ³ã« Function URL ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã€è¨­å®šã™ã‚‹ã®ã¯ URL ã§ã¯ãªã ãƒ‰ãƒ¡ã‚¤ãƒ³éƒ¨åˆ†ã®ã¿ ã¨ãªã‚Šã¾ã™ã€‚\nCloudFront ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚ªãƒªã‚¸ãƒ³ã¨ã—ã¦ Lambda é–¢æ•° URL ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ã‚ªãƒªã‚¸ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã—ã¦ Lambda é–¢æ•° URL ã®å®Œå…¨ãªãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’æŒ‡å®šã—ã¾ã™ã€‚\nCloudFront ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®ã•ã¾ã–ã¾ãªã‚ªãƒªã‚¸ãƒ³ã®ä½¿ç”¨ - Amazon CloudFront AWS CDK ã«ãŠã„ã¦ Function URL ã«ã¤ã„ã¦ã¯ awslambda.FunctionUrl.Url() ã§å‚ç…§ã§ãã‚‹ã®ã§ã™ãŒã€ Distribution ã¨åŒã˜ scope å†…ã§ FunctionURL ã‚’ä½œæˆã—ã¦ã„ã‚‹å ´åˆã«ã¯ DistributionProps å†…ã§åˆ©ç”¨ã™ã‚‹æ™‚ç‚¹ã§ã¯ã¾ã å€¤ãŒç¢ºå®šã—ã¦ã„ã¾ã›ã‚“ã€‚ãªã®ã§ã€ strings.Replace ãªã©ã‚’ä½¿ã£ã¦ https:// ã‚’å–ã‚Šé™¤ãã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€ CloudFormation ã® Fn ã‚’åˆ©ç”¨ã—ã¦ URL ã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³éƒ¨åˆ†ã®ã¿ã‚’æŠœãå‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ãªé–¢æ•°ã‚’ç”¨æ„ã—ã¦åŠ å·¥ã—ã¾ã—ãŸã€‚\nvar slash string = \u0026#34;/\u0026#34; func functionURLDomain(furl awslambda.FunctionUrl) *string { // function url format: https://hoge.lambda-url.ap-northeast-1.on.aws/ // split: [\u0026#34;https:\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;hoge.lambda-url.ap-northeast-1.on.aws\u0026#34;, \u0026#34;\u0026#34;] splitURL := awscdk.Fn_Split(\u0026amp;slash, furl.Url(), jsii.Number(4)) return (*splitURL)[2] } AWS CDK ã«ã¯ CloudFormation ã® Fn ã‚’å†ç¾ã™ã‚‹ãŸã‚ã®é–¢æ•°ãŒè¦ã•ã‚Œã¦ãŠã‚Šã€ä»Šå›ã¯æ–‡å­—åˆ—ã‚’åˆ†å‰²ã™ã‚‹ Fn_Split ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚\nã“ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€ cdk synth ã‚’å®Ÿè¡Œã—ãŸéš›ã® CFn ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ä¸‹è¨˜ã®ã‚ˆã†ãªå½¢ã§ç”Ÿæˆã•ã‚Œã¾ã™ã€‚\nAWSCDKGoExampleFunctionURLFunctionCFDistribution6BF356B9: Type: AWS::CloudFront::Distribution Properties: DistributionConfig: Origins: - ConnectionAttempts: 1 ConnectionTimeout: 5 CustomOriginConfig: OriginProtocolPolicy: https-only OriginSSLProtocols: - TLSv1.2 DomainName: Fn::Select: - 2 - Fn::Split: - / - Fn::GetAtt: - AwsCdkGoExampleSimpleResponseDefaultUrlB01107C8 - FunctionUrl Id: LambdaFunctionUrlsWithCustomDomainStackAWSCDKGoExampleFunctionURLFunctionCFDistributionOrigin181CAA1CC OriginCustomHeaders: - HeaderName: x-aws-cdk-go-example-from HeaderValue: aws-cdk-go-example-cf ã¾ãŸã€ä»»æ„ã® Origin Custom Header ã‚’è¨­å®šã—ã¦ãŠãã“ã¨ã§ã€å¾Œè¿°ã™ã‚‹ Lambda é–¢æ•°ã®å®Ÿè£…ã«ã¦ç›´æ¥ Function URL ã® URL ã‚’å©ã‹ã‚ŒãŸã¨ãã®å¯¾ç­–ã¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»Šå›ã¯ x-aws-cdk-go-example-from ã¨ã„ã†ãƒ˜ãƒƒãƒ€ã« aws-cdk-go-example-cf ã¨ã„ã†å€¤ã‚’è¨­å®šã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚\ncustomHeaderForFunction := map[string]*string{ \u0026#34;x-aws-cdk-go-example-from\u0026#34;: jsii.String(\u0026#34;aws-cdk-go-example-cf\u0026#34;), } props := \u0026amp;awscloudfront.DistributionProps{ Enabled: jsii.Bool(true), DefaultBehavior: \u0026amp;awscloudfront.BehaviorOptions{ CachePolicy: cachePolicy, OriginRequestPolicy: originRequestPolicy, Origin: awscloudfrontorigins.NewHttpOrigin(defaultFnURLDomain, \u0026amp;awscloudfrontorigins.HttpOriginProps{ ConnectionAttempts: jsii.Number(1), ConnectionTimeout: awscdk.Duration_Seconds(jsii.Number(5)), CustomHeaders: \u0026amp;customHeaderForFunction, ProtocolPolicy: awscloudfront.OriginProtocolPolicy_HTTPS_ONLY, OriginSslProtocols: \u0026amp;[]awscloudfront.OriginSslPolicy{ awscloudfront.OriginSslPolicy(\u0026#34;TLS_V1_2\u0026#34;), }, }), ViewerProtocolPolicy: awscloudfront.ViewerProtocolPolicy_HTTPS_ONLY, }, HttpVersion: awscloudfront.HttpVersion_HTTP2, PriceClass: awscloudfront.PriceClass_PRICE_CLASS_200, EnableLogging: jsii.Bool(false), } aws-cdk-go-examples/cloudfront.go at main Â· michimani/aws-cdk-go-examples Lambda Lambda é–¢é€£ã§ã¯ Function ã¨ Function URL ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ãŒã€ãã‚Œãã‚Œç‰¹ç­†ã™ã‚‹ã¹ãç‚¹ã¯ãªã„ã®ã§ãƒªã‚½ãƒ¼ã‚¹ã®å®šç¾©ã«ã¤ã„ã¦ã¯å‰²æ„›ã—ã¾ã™ã€‚ä¸€æ–¹ã§ã€ Lambda é–¢æ•°ã®å®Ÿè£…ã«ã¤ã„ã¦ã¯å·¥å¤«ã™ã¹ãç‚¹ãŒã‚ã‚Šã¾ã—ãŸã€‚ CloudFront ã®ã¨ã“ã‚ã§ã‚‚æ›¸ãã¾ã—ãŸãŒã€ä»Šå›ã¯ Lambda é–¢æ•°ã‚’Function URL ã§ã¯ãªãä»»æ„ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€ Function URL ã‚’ç›´æ¥å©ã‹ã‚ŒãŸã¨ãã«ã¯ã‚¨ãƒ©ãƒ¼ã«ã—ãŸã„ã§ã™ã€‚ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã¯ã€ Lambda é–¢æ•°å†…ã§ CloudFront ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ä»˜ä¸ã•ã‚Œã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ã‚’æ¤œæŸ»ã—ã¾ã™ã€‚\nfunc handleRequest(ctx context.Context, httpRequest events.APIGatewayProxyRequest) (response, error) { lctx, ok := lambdacontext.FromContext(ctx) if !ok { return jsonResponse(http.StatusInternalServerError, errorBody{Error: \u0026#34;failed to parse lambda context\u0026#34;}, nil) } if !isAvailableAccess(httpRequest) { return jsonResponse(http.StatusForbidden, errorBody{Error: \u0026#34;forbidden\u0026#34;}, nil) } body := okBody{ RequestID: lctx.AwsRequestID, Message: message, Time: time.Now().Format(time.RFC3339Nano), } customHeader := map[string]string{ \u0026#34;x-aws-cdk-example\u0026#34;: \u0026#34;lambda-function-urls-with-custom-domain\u0026#34;, } return jsonResponse(http.StatusOK, body, customHeader) } func isAvailableAccess(req events.APIGatewayProxyRequest) bool { // invoke from specified CloudFront if h, ok := req.Headers[customHeaderKeyFromCloudFront]; !ok { fmt.Printf(\u0026#34;custom header %s does not exists. req:%v\u0026#34;, customHeaderKeyFromCloudFront, req) return false } else if h != customHeaderValueFromCloudFront { fmt.Printf(\u0026#34;custom header value is invalid. req:%v\u0026#34;, req) return false } return true } ãƒãƒ³ãƒ‰ãƒ©é–¢æ•°ã§ events.APIGatewayProxyRequest ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã“ã¨ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã‚’æ¤œæŸ»ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\nä¸Šè¨˜ã®å®Ÿè£…ã§ã‚ã‚Œã°ã€ Function URL ã‚’ç›´æ¥å©ã‹ã‚ŒãŸã¨ã (= ç‰¹å®šã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãŒå«ã¾ã‚Œãªã„ã¨ã) ã¯ 403 ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚\naws-cdk-go-examples/main.go at main Â· michimani/aws-cdk-go-examples ã¾ã¨ã‚ Lambda Function URL ã‚’ä»»æ„ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹æ§‹æˆã‚’ AWS CDK v2 (Golang) ã§æ§‹æˆã—ã¦ã¿ãŸè©±ã§ã—ãŸã€‚\nFunction URL ãŒç™ºè¡¨ã•ã‚ŒãŸã¨ãã¯ ã€Œã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³å¯¾å¿œã—ã¦ãªã„ã®ã‹ãƒ¼ã€ã¨æ€ã£ã¦ã„ã¾ã—ãŸãŒã€å‰æ®µã« CloudFront ã‚’ç½®ã‘ã°å®Ÿç¾å¯èƒ½ã§ã‚ã‚‹ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚\nå‰æ®µã« CloudFront ã‚’ç½®ãã¨ã„ã†ã“ã¨ã¯ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ©æµã‚’å—ã‘ã‚‰ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã€ WAF ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ DDoS æ”»æ’ƒã‚„æ‚ªæ„ã®ã‚ã‚‹ bot ç­‰ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã«ã¤ã„ã¦ã‚‚å¯¾ç­–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\nä»Šå›ã®ã‚ˆã†ã«æ–°ãŸã« CloudFront ã‚’ç”¨æ„ã™ã‚‹ã¨ã“ã‚ã‹ã‚‰ã¨ãªã‚‹ã¨ã¡ã‚‡ã£ã¨å¤§å¤‰ã§ã™ãŒã€æ—¢ã« CloudFront ã‚’åˆ©ç”¨ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹çŠ¶æ…‹ã§ã‚ã‚Œã° Behavior ã®è¿½åŠ ã ã‘ã§å®Ÿç¾ã§ãã‚‹ã“ã¨ã«ãªã‚‹ã®ã§ã€ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã®å®Ÿè£…ã‚’ Lambda ã§ä½œã£ã¦ API ã¨ã—ã¦ä½¿ã†ã¨ã„ã†ã®ãŒã‚µã‚¯ãƒƒã¨ã§ãã¦ã—ã¾ã„ãã†ã§ã™ã€‚\nDistributionProps ã®æ§‹é€ ä½“ãŒãƒ‡ã‚«ã™ãã‚‹å•é¡Œã¯ã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯ CloudFront æ‰±ã†ä¸Šã§ã®å®¿å‘½ãªã®ã§è«¦ã‚ã¾ã™\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n",
    "permalink": "https://michimani.net/post/aws-lambda-function-urls-with-custom-domain/",
    "title": "Lambda Function URLs ã§ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ã†æ§‹æˆã‚’ AWS CDK v2 (Go) ã§æ§‹ç¯‰ã™ã‚‹"
  },
  {
    "contents": "ä½•ã‚‚æ›¸ã‹ãªã„ã®ã¯ã‚ã‚Œãªã®ã§ã€é›‘ã« 2022 å¹´ã®æŒ¯ã‚Šè¿”ã‚Šã‚’ã—ã¦ãŠãã¾ã™ã€‚\nå»å¹´ã®æŒ¯ã‚Šè¿”ã‚Šã®æœ€å¾Œã«æ›¸ã„ã¦ã„ãŸã“ã¨ æ¥å¹´ã“ãã¯ SAP åˆæ ¼ã—ã¾ã™ã€‚ãã‚Œã§ã¯ã¾ãŸæ¥å¹´ğŸ‘‹\nå…·ä½“çš„ãªç›®æ¨™ã¯ã“ã‚Œã ã‘ã§ã—ãŸã€‚\nAWS èªå®šã¾ã‚ã‚Š 2019 å¹´ã® 7 æœˆã« SAAã€ 2019 å¹´ã® 12 æœˆã« SOA ã¨ DVA ã‚’å–å¾—ã—ã¦ã„ãŸã®ã§ã€ãã‚Œã‚‰ã®æœ‰åŠ¹æœŸé™ãŒ 2022 ã«åˆ‡ã‚Œã‚‹ã“ã¨ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚\nèªå®šã‚’ç¶™ç¶šã™ã‚‹ãŸã‚ã«ã¯ãã‚Œãã‚Œå†å–å¾—ã™ã‚‹ã‹ã€ä¸Šä½è³‡æ ¼ã¨ãªã‚‹ SAP ã¨ DOP ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚\nçµè«–ã€ 2022 å¹´ 6 æœˆã« SAPã€ 11 æœˆã« DOP ã‚’ç„¡äº‹ã«å–å¾—ã§ããŸã®ã§ä¸‹ä½è³‡æ ¼ã¨ãªã‚‹ SAA/SOA/DVA ã‚‚å»¶å‘½ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ãªã®ã§ã€å»å¹´ã®çµ‚ã‚ã‚Šã«æ²ã’ãŸç›®æ¨™ã¯é”æˆã§ã™ã€‚\nã“ã‚“ã«ã¡ã¯ã€‚ç§ãŒã‚®ãƒªã‚®ãƒªã‚’ç”Ÿãã‚‹ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã™ã€‚\nä»Šæœˆæœ«ã§å¤±åŠ¹ã™ã‚‹äºˆå®šã ã£ãŸ SAA ã‚‚å»¶å‘½ã§ããŸã®ã§ãƒ¨ã‚·ã€‚ pic.twitter.com/DFNyRQpMNm\n\u0026mdash; michimani Lv.870 (@michimani210) June 13, 2022 ã“ã‚“ã«ã¡ã¯ã€‚ç§ãŒã‚®ãƒªã‚®ãƒªã‚’ç”Ÿãã‚‹ DevOps Engineer ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã™ã€‚\næ¥æœˆå¤±åŠ¹ã™ã‚‹äºˆå®šã ã£ãŸ DVA ã¨ SOA ã‚‚å»¶å‘½ã§ããŸã®ã§ãƒ¨ã‚·ã€‚ pic.twitter.com/fOb7pWKFes\n\u0026mdash; michimani Lv.870 (@michimani210) November 29, 2022 ãã‚Œãã‚Œã‚¹ã‚³ã‚¢ã¯ã‚®ãƒªã‚®ãƒªã§ã—ãŸãŒã€åˆæ ¼ã§ããŸã®ã§ãƒ¨ã‚·ã€‚\nã“ã‚Œã§ AWS èªå®šã¯ 5 ã¤ã«ãªã£ãŸã‚ã‘ã§ã™ã€‚\nå…¨éƒ¨å–ã‚ã†ã¨ã‹ã¯æ€ã£ã¦ãªã„ã§ã™ãŒã€æ¥å¹´ã¯ Specialty ã®èªå®šä¸€ã¤ãã‚‰ã„ã¯æŒ‘æˆ¦ã—ã¦ã¿ãŸã„ã§ã™ã€‚\né–‹ç™ºã¾ã‚ã‚Š (ã–ã£ãã‚Š) å»å¹´ã®æŒ¯ã‚Šè¿”ã‚Šè¨˜äº‹ã§ã€ãµã‚“ã‚ã‚Šã¨ ã€ŒGo ã‚‚å‹‰å¼·ã—ã¾ã™ã€ã¿ãŸã„ãªã“ã¨ã‚’æ›¸ã„ã¦ã¾ã—ãŸã€‚\nå»å¹´ä½œã£ãŸ Twitter API v2 ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚ã‚¹ã‚¿ãƒ¼æ•°ãŒ 66 ã¾ã§å¢—ãˆã¦ã€ ã€Œç›†æ ½ã‚’è‚²ã¦ã‚‹ã‚ˆã†ã«ç´°ã€…ã¨ãƒ¡ãƒ³ãƒ†ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚ã€ ã¨ã„ã†ã®ã¯é”æˆã‹ãªã¨ã€‚åˆ©ç”¨è€…ã‹ã‚‰ issue å ±å‘Šã‚„ PR ãŒé£›ã‚“ã§ããŸã‚Šã‚‚ã—ã¦ã€ã‚ãƒ¼ä½¿ã‚ã‚Œã¦ã‚“ãªãƒ¼æ„Ÿã‚’æ„Ÿã˜ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚\nä»Šå¹´ã¯ã€ Go ä»¥å¤–ã ã¨ Rust ã‚’è§¦ã‚Šå§‹ã‚ã¦ã¿ãŸã‚Šã€ AWS ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã™ã‚‹ã®ã« Terraform ã¨ä»²è‰¯ããªã£ãŸã‚Šã€ã¨ã„ã†ã®ãŒæ–°ã—ã„é ˜åŸŸã ã£ãŸã¨æ€ã„ã¾ã™ã€‚ã“ã®è¾ºã«ã¤ã„ã¦ã¯ã€ä»Šå¹´æ–°ãŸã« GitHub ã«ä½œã£ãŸãƒªãƒã‚¸ãƒˆãƒªã‚’è¦‹ã¦ã„ã£ã¦æŒ¯ã‚Šè¿”ã‚ã†ã¨æ€ã„ã¾ã™ã€‚\nä»Šå¹´ GitHub ã«ä½œã£ãŸãƒªãƒã‚¸ãƒˆãƒª å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã®å–å¾—ã«ã¯ã€ gh ã‚³ãƒãƒ³ãƒ‰ã§å–å¾—ã—ã¾ã—ãŸã€‚\ngh repo list \\ --json name,createdAt,url \\ -q \u0026#39;.[] | select(.createdAt | test(\u0026#34;2022-\u0026#34;))\u0026#39; \\ --visibility public \\ --source \\ | jq --slurp \u0026#39;. | sort_by(.createdAt)\u0026#39; programming-Rust-2nd michimani/programming-Rust-2nd ã“ã‚Œã¯ Rust ã®å‹‰å¼·ã‚’å§‹ã‚ã‚‹ã«ã‚ãŸã£ã¦ O\u0026rsquo;Reilly ã® ã€Œ ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª Rust ç¬¬2ç‰ˆ ã€ ã‚’èª­ã¿ãªãŒã‚‰åŸºæœ¬æ§‹æ–‡ã®ä½¿ã„æ–¹ã¨ã‹ã‚’å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã§æ›¸ã„ã¦ã„ãŸã‚„ã¤ã§ã™ã€‚\nã¨ã‚Šã‚ãˆãšä¸€å‘¨ã—ã¦ã€ãã®å¾Œã¯ Project Euler ã®å•é¡Œã‚’ Rust ã§ã‚„ã£ãŸã‚Šã—ã¦ã¾ã—ãŸã€‚ãŒã€ã¾ã ã¾ã  Rust ãªã«ã‚‚ã‚ã‹ã‚‰ãªã„ã€‚\nmichimani/Project-Euler-Solutions: My solutions for Project Euler. (Python, Go, Rust) go-esa michimani/go-esa: Unofficial esa SDK for the Go programming language. Twitter API v2 ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½œã£ãŸå‹¢ã„ã¨ãã®åçœã‚’æ´»ã‹ãã†ã¨ã—ã¦ä½œã£ãŸã€Go è£½ã® esa API ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚\nesa ã¯ç„¡æ–™æœŸé–“ãŒ 3ãƒ¶æœˆã‚ã‚‹ã®ã§ã€ãã®é–“ã«ä½œã‚Šãã‚Šã¾ã—ãŸã€‚ç„¡æ–™æœŸé–“çµ‚äº†å¾Œã¯ã€å€‹äººã§ã¯ä½¿ã£ã¦ã„ã¾ã›ã‚“ã€‚\ntext-detector michimani/text-detector: This is a library for the Go language to detect text from images. It uses Amazon Rekognition or Google Cloud Vision for text detection. ç”»åƒã«å«ã¾ã‚Œã¦ã„ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºã™ã‚‹ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚æŠ½å‡ºå‡¦ç†ã«ã¯ Amazon Rekognition ã‚‚ã—ãã¯ Google Cloud Vision ã®ã©ã¡ã‚‰ã‹ã‚’é¸ã¹ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚\nREADME ãŒ TBD ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‹ã‚‰ã‚‚ã€çªç™ºçš„ã«ä½œã£ã¦æ”¾ç½®ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚\nelasticsearch-get-started, get-started-opensearch michimani/elasticsearch-get-started michimani/get-started-opensearch: Hello OpenSearch. Elasticsearch ã¨ OpenSearch ã«å…¥é–€ã—ã‚ˆã†ã¨æ€ã£ã¦è§¦ã£ã¦ã¿ãŸã‚„ã¤ã§ã™ã€‚\nOpenSearch ã«ã¤ã„ã¦ã¯å®Œå…¨ã«ç†è§£ã—ãŸæ°—ã§ã„ã¾ã—ãŸãŒã‚‚ã†å®Œå…¨ã«å¿˜ã‚Œã¦ã—ã¾ã£ãŸã®ã§ã€ã‚„ã¯ã‚Šç¶™ç¶šã¯å¤§äº‹ã€‚\namazon-aws michimani/amazon-aws: The quiz \u0026amp;ldquo;Amazon\u0026amp;rdquo; or \u0026amp;ldquo;AWS\u0026amp;rdquo; or neither? ãªã‚“ã¨ãªã React.js ã«å…¥é–€ã™ã‚‹ã‹ãƒ¼ã¨æ€ã£ã¦ä½œã£ãŸç°¡å˜ãªã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒªã§ã™ã€‚\nã“ã¡ã‚‰ã‹ã‚‰éŠã¹ã¾ã™ã€‚\nQuiz Amazon or AWS aws-cdk-go-examples michimani/aws-cdk-go-examples: This is a repository of example implementations of using AWS CDK with Go language. AWS CDK v2 ã® Go è¨€èªã‚µãƒãƒ¼ãƒˆãŒ GA ã•ã‚ŒãŸã®ã§ã€å®Ÿè£…ä¾‹ã‚’é›†ã‚ã¦ã¿ã‚‹ã‹ã€ã¨æ€ã£ã¦ä½œã£ãŸã‚‚ã®ã§ã™ã€‚\nGA ã•ã‚ŒãŸã‚‚ã®ã®ã¾ã ã¾ã æƒ…å ±ãŒå°‘ãªã„ã®ã§ã€è‡ªåˆ†ãŒå›°ã£ãŸã¨ãã®å‚è€ƒã«ãªã‚Œã°ååˆ†ã§ã€ã‚‚ã—ä»–ã®äººã®å‚è€ƒã«ãªã‚Œã°ã¨ã¦ã‚‚å¬‰ã—ã„ã§ã™ã€‚\nget-started-cdk-terraform michimani/get-started-cdk-terraform CDK for Terraform å…¥é–€ç”¨ã«ä½œã£ãŸã‚„ã¤ã§ã™ã€‚\nè§¦ã£ã¦ã¿ãŸçµæœã€ç®¡ç†ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ãŒ AWS ãƒªã‚½ãƒ¼ã‚¹ã«é™ã‚‰ã‚Œã‚‹ã®ã§ã‚ã‚Œã° AWS CDK ã®ã»ã†ãŒè‰¯ã„ãªã€ã¨æ€ã„ã¾ã—ãŸã€‚\njsc michimani/jsc: Joins multiple slack channels to display posts in chronological order. Slack ã§è¤‡æ•°ãƒãƒ£ãƒ³ãƒãƒ«ã® TL ã‚’ãƒãƒ¼ã‚¸ã—ã¦è¦‹ãŸã„ãªã€ã¨æ€ã£ã¦ä½œã£ãŸãƒ„ãƒ¼ãƒ«ã§ã™ã€‚\nsqs-lambda-example michimani/sqs-lambda-example: Example of AWS Lambda functions that invoked by message from Amazon SQS. SQS ã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã™ã‚‹ Lambda é–¢æ•°ã«ã¤ã„ã¦ã€ã‚ã¾ã‚Šã‚ã‹ã£ã¦ã„ãªã‹ã£ãŸã§å®Ÿéš›ã«ç°¡å˜ãªæ§‹æˆã‚’ä½œã£ã¦ã¿ãŸã‚„ã¤ã§ã™ã€‚ãƒªã‚½ãƒ¼ã‚¹ã¯ Terraform ã§å®šç¾©ã€ Event Source Mapping ã® Filter Pattern ã‚’ä½¿ã£ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã”ã¨ã«ç•°ãªã‚‹ Lambda é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ãªæ§‹æˆã«ãªã£ã¦ã„ã¾ã™ã€‚\ncontainer-lambda-cicd michimani/container-lambda-cicd: ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã™ã‚‹ Lambda é–¢æ•°ã® CI/CD ã®ã‚µãƒ³ãƒ—ãƒ«ã€‚ ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹ Lambda é–¢æ•°ã«ã¤ã„ã¦ã€ GitHub Actions ã‚’ä½¿ã£ãŸ CI/CD ã‚’æ•´å‚™ã—ã¦ã¿ãŸã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚\nlambda-parameters-extension michimani/lambda-parameters-extension: Sample code of using Parameter and Secret Lambda Extension. Parameter Store ãŠã‚ˆã³ Secret Manager ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ Lambda Extension ãŒ AWS å…¬å¼ã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸã®ã§ã€ãã‚Œã‚’è©¦ã™ãŸã‚ã«ä½œã£ãŸã‚„ã¤ã§ã™ã€‚\ngenerative-art michimani/generative-art: ã€æ•°å­¦ã‹ã‚‰å‰µã‚‹ã‚¸ã‚§ãƒãƒ©ãƒ†ã‚£ãƒ–ã‚¢ãƒ¼ãƒˆ - Processing ã§å­¦ã¶ ã‹ãŸã¡ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã€ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ Rust ã§æ›¸ã„ãŸã‚‚ã®ã€‚ ãƒªãƒã‚¸ãƒˆãƒªã® description ã«ã‚‚æ›¸ã„ã¦ã¾ã™ãŒ ã€Œ æ•°å­¦ã‹ã‚‰å‰µã‚‹ã‚¸ã‚§ãƒãƒ©ãƒ†ã‚£ãƒ–ã‚¢ãƒ¼ãƒˆ - Processing ã§å­¦ã¶ ã‹ãŸã¡ã®ãƒ‡ã‚¶ã‚¤ãƒ³ ã€ã¨ã„ã†æœ¬ã‚’èˆˆå‘³æœ¬ä½ã§è²·ã£ãŸã®ã§ã€åº•ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹å®Ÿè£…ã‚’ Rust ã§ã‚„ã£ã¦ã¿ã‚ˆã†ã¨æ€ã£ã¦ä½œã£ãŸã‚‚ã®ã§ã™ã€‚ã¨ã‚Šã‚ãˆãšã²ã¨ã¤ã¯å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸãŒã€ãã‚Œä»¥é™ã¯é€²æ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\naws-lambda-api-go michimani/aws-lambda-api-go: This is a client library for Go language to use AWS Lambda\u0026amp;rsquo;s Runtime API, Extension API, Telemetry API, and Logs API. Lambda ã® Runtime API, Extension API, Telemetry API ç”¨ Go è£½ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚Go ã§ Lambda Extension ã‚’ä½œã‚‹ã¨ãã«ä¾¿åˆ©ã«ãªã‚‹æƒ³å®šã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚\nhttp-client-mock michimani/http-client-mock: This is a package to generate a mock of http.Client in Go language. You can easily generate a http. Go ã§ API ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ›¸ã„ã¦ã„ã‚‹ã¨ http.Client ã‚’ãƒ¢ãƒƒã‚¯åŒ–ã—ãŸãƒ†ã‚¹ãƒˆã‚’ãŸãã•ã‚“æ›¸ãæ©Ÿä¼šãŒã‚ã‚Šã€ãã®éƒ¨åˆ†ã‚’ã„ã„æ„Ÿã˜ã«æ›¸ãã‚„ã™ãã™ã‚‹ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œã‚Šã¾ã—ãŸã€‚\nlambda-api-example michimani/lambda-api-example michimani/aws-lambda-api-go ã‚’ä½¿ã£ãŸå®Ÿè£…ä¾‹ã§ã™ã€‚å¤§ã—ãŸå†…å®¹ã§ã¯ãªã„ã®ã§ã€ä½œã£ãŸç†ç”±ãŒã‚ã‹ã‚Šã¾ã›ã‚“ã€‚\ninvocation-history-extension michimani/invocation-history-extension: This is a Extension for AWS Lambda Function that records history of invocation at the same runtime environment. Lamdba ã® Telemetry API ã‚’ä½¿ã† Lambda Extension ã§ã™ã€‚\nè©³ã—ãã¯ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¨˜äº‹ã§æ›¸ã„ã¦ã„ã¾ã™ã€‚\nTelemetry API ã‚’ä½¿ã† Lambda Extension ã‚’ä½œã£ã¦ã¿ãŸ - michimani.net ãã®ä»– æ•°å­¦ç³»ã®æœ¬ã‚’ã„ãã¤ã‹èª­ã‚“ã  Google Analytics 4 ã«ç§»è¡Œã—ãŸ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å‹‰å¼·ä¼šã¯ã‚ã¾ã‚Šå‚åŠ ã§ããªã‹ã£ãŸ (ç¶™ç¶š) ç™»å£‡ã¯ã—ãŸ ä½“é‡ã¯æ¸›ã‚‰ã›ãªã‹ã£ãŸ (ç¶™ç¶š) çµå©šã—ãŸ ã¾ã¨ã‚ é›‘ã«æŒ¯ã‚Šè¿”ã‚Šã€ã¨è¨€ã„ã¤ã¤ GitHub ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ™ãƒ¼ã‚¹ã«æŒ¯ã‚Šè¿”ã£ãŸã ã‘ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚\nå»å¹´ã‚ˆã‚Šã¯å­¦ã³ã¯ã‚ã£ãŸæ°—ã¯ã—ã¤ã¤ã‚‚ã€çµæœ (åå…¥) ã«ã¯çµã³ã¤ã„ã¦ã„ãªã„ã®ã§ã€ 2023 å¹´ã¯çµæœ (åå…¥) ã«ã‚‚æ‹˜ã£ã¦ã„ã‘ãŸã‚‰ã„ã„ãªã¨æ€ã„ã¾ã™ã€‚\nå…·ä½“çš„ãªç›®æ¨™ã‚‚æ›¸ã„ã¦ãŠã‹ãªã„ã¨æŒ¯ã‚Šè¿”ã‚‹ã¨ãã«ä¸ä¾¿ãªã®ã§ã„ãã¤ã‹ã€‚\nAWS èªå®šã® Specialty ç³»ã®è©¦é¨“ã‚’å—ã‘ã‚‹ æ•°ç ”æº–ä¸€ç´šã‚’å—ã‘ã‚‹ 2023 å¹´ã‚‚ãŒã‚“ã°ã‚Šã¾ã—ã‚‡ã† ğŸ‘‹\n",
    "permalink": "https://michimani.net/post/other-retrospect-in-2022/",
    "title": "2022 å¹´ã‚’é›‘ã«æŒ¯ã‚Šè¿”ã‚‹"
  },
  {
    "contents": "AWS Lambda ã® Runtime API ã«ã¤ã„ã¦èª¿ã¹ã¦ã„ãŸã‚‰ Extension APIã€ Telemetry API ã¨ã„ã†ã‚‚ã®ã®å­˜åœ¨ã‚’çŸ¥ã‚Šã€ ã²ã¨ã¤å‰ã®è¨˜äº‹ ã§ã¯ãã‚Œã‚’ä½¿ã£ã¦ç°¡å˜ãª Lambda Extension ã‚’è‡ªä½œã—ã¦ã¿ã¾ã—ãŸã€‚ä»Šå›ã¯ã€ Telemetry API ã‚’ä½¿ã† Lambda Extension ã‚’ä½œã£ã¦ã¿ã¦ã€ Telemetry API ã§ã©ã®ã‚ˆã†ãªæƒ…å ±ãŒå–å¾—ã§ãã‚‹ã®ã‹ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚\nã¯ã˜ã‚ã« Telemetry API ã¨ã¯ Telemetry API ã‚’ä½¿ã† Lambda Extension ã®æ¦‚è¦ Telemetry API ã®è©³ç´° 1. Subscribe API - PUT /telemetry ã«ã¤ã„ã¦ 2. Subscriber ã«å¯¾ã—ã¦é€ä¿¡ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã«ã¤ã„ã¦ Telemetry API ã‚’ä½¿ã† Extension ã‚’ä½œã£ã¦ã¿ã‚‹ Telemetry API ã® Subscriber ã‚’èµ·å‹• Subscribe API ã‚’ã‚³ãƒ¼ãƒ«ã—ã¦ Subscriber ã‚’ç™»éŒ² ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° Lambda é–¢æ•°ã§ä½¿ã£ã¦ã¿ã‚‹ æº–å‚™ Extension ã¨ ãã‚Œã‚’ä½¿ã†é–¢æ•°ã‚’ä½œæˆ å®Ÿè¡Œã—ã¦ãƒ­ã‚°ã‚’ç¢ºèª ã¾ã¨ã‚ ã¯ã˜ã‚ã« ã“ã®è¨˜äº‹ã¯ å¼è­·å£«ãƒ‰ãƒƒãƒˆã‚³ãƒ  Advent Calendar 2022 (ã¨ AWS Lambdaã¨Serverless Advent Calendar 2022 (ãã®2) ) ã® 12 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚\næ˜¨æ—¥ã¯ @talog ã«ã‚ˆã‚‹ ã€Œtextlint ã®ãƒ«ãƒ¼ãƒ«ã‚’ä½œã£ã¦ä»•çµ„ã¿ã‚’ç†è§£ã—ãŸğŸ’ª ã€ ã§ã—ãŸã€‚ã“ã®ãƒ–ãƒ­ã‚°ã«ã‚‚ linter ã‚’å°å…¥ã—ãŸã„\u0026hellip;\nä»Šå›ã®è¨˜äº‹ã§ã¯ã‚¿ã‚¤ãƒˆãƒ«ã®é€šã‚Š Telemetry API ã‚’ä½¿ã£ãŸ Lambda Extension ã«ã¤ã„ã¦æ›¸ãã¾ã™ãŒã€ä¸‹è¨˜ã®è¨˜äº‹ã§ Lambda Extension ãã®ã‚‚ã®ã«ã¤ã„ã¦æ›¸ã„ã¦ã„ã‚‹ã®ã§åˆã‚ã›ã¦èª­ã‚“ã§ã„ãŸã ãã¨ã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚\nAWS Lambda ã® Extension API ã‚’ä½¿ã„ãŸã„ãŒãŸã‚ã« Go ã§ Lambda Extension ã‚’è‡ªä½œã—ã¦ã¿ãŸ - michimani.net Telemetry API ã¨ã¯ 2022å¹´ 11æœˆã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸæ©Ÿèƒ½ã§ã€ Lambda ã®å®Ÿè¡Œç’°å¢ƒã€æ‹¡å¼µæ©Ÿèƒ½ã€é–¢æ•°ã§èµ·ã“ã£ã¦ã„ã‚‹ã“ã¨ã‚’ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ãª API ã®ã“ã¨ã§ã™ã€‚\nAWS Lambda ã«ãŠã„ã¦ã€æ–°ã—ã„ AWS Lambda Telemetry API ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€é–¢æ•°ã®å®Ÿè¡Œã«é–¢ã™ã‚‹å¼·åŒ–ã•ã‚ŒãŸãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŠã‚ˆã³ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ã‚’ã€Lambda æ‹¡å¼µæ©Ÿèƒ½ã§åé›†ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ Telemetry API ã¯ã€ãƒ­ã‚°ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã€é–¢æ•°å‘¼ã³å‡ºã—ãƒ¬ãƒ™ãƒ«ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Lambda ã‹ã‚‰ç›´æ¥å—ã‘å–ã‚‹ãŸã‚ã®ã€æ‹¡å¼µæ©Ÿèƒ½ç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚\nå¼•ç”¨å…ƒ: AWS Lambda ãŒ Telemetry API ã‚’å°å…¥ã—ãŸã“ã¨ã§ Lambda æ‹¡å¼µæ©Ÿèƒ½ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ãŒã•ã‚‰ã«å‘ä¸Š Telemetry API ã®ãƒªãƒªãƒ¼ã‚¹ä»¥å‰ã«ã¯ Logs API ã¨ã„ã†ã‚‚ã®ãŒæä¾›ã•ã‚Œã¦ãŠã‚Šã€ã“ã® API ã§ã¯é–¢æ•°ã§ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¦ã„ã¾ã—ãŸã€‚ Telemetry API ã¯ Logs API ã®ä¸Šä½äº’æ›ã®ã‚ˆã†ãªå­˜åœ¨ã§ã€ä»Šå¾Œã¯ Logs API ã®ä»£ã‚ã‚Šã¨ã—ã¦ Telemetry API ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚\nThe Lambda Telemetry API supersedes the Lambda Logs API. While the Logs API remains fully functional, we recommend using only the Telemetry API going forward.\nå¼•ç”¨å…ƒ: Lambda Telemetry API - AWS Lambda Telemetry API ã‚’ä½¿ã† Lambda Extension ã®æ¦‚è¦ Lambda Extension ã§ Telemetry API ã‚’ä½¿ã†å ´åˆã€ Extension ã®å®Ÿè£…ã¨ã—ã¦ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\nHTTP ã¾ãŸã¯ TCP ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹ã‚µãƒ¼ãƒã‚’æ‰€å®šã®ã‚¢ãƒ‰ãƒ¬ã‚¹ (ãƒãƒ¼ãƒˆã¯ä»»æ„) ã§èµ·å‹•ã™ã‚‹ 1 ã§èµ·å‹•ã—ãŸã‚µãƒ¼ãƒã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ Telemetry API ã® Subscribe API (PUT /telemetry) ã‚’ä½¿ã£ã¦ç™»éŒ²ã™ã‚‹ ä½•ã‹ã—ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸéš›ã« Telemetry API ã‹ã‚‰ 1 ã®ã‚µãƒ¼ãƒã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã‚‹ã®ã§ã€ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¡Œã† ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã§æãã¨ä¸‹è¨˜ã®ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚\nsequenceDiagram participant ls as Lambda Service participant eapi as Extension API participant tapi as Telemetry API participant main as Extension (main) participant sub as Extension (subscriber) alt Init ls -\u003e\u003e main: start (init extensions in /ops/extensions) main -\u003e\u003e eapi: POST /extension/register eapi -\u003e\u003e main: OK + ExtensionIdentifier main -\u003e\u003e sub: Start HTTP (or TCP) server sub -\u003e\u003e main: OK + listenAddress main -\u003e\u003e tapi: PUT /telemetry with ExtensionIdentifier + listenAddress tapi -\u003e\u003e main: OK end loop Repeat main -\u003e\u003e eapi: GET /extension/event/next eapi -\u003e\u003e main: INVOKE/SHUTDOWN event tapi -\u003e\u003e sub: platform/extension/function event sub -\u003e\u003e sub: handle event end ä¸Šè¨˜ã®é€šã‚Šã€Extension ã‹ã‚‰ã‚³ãƒ¼ãƒ«ã™ã‚‹ Telemetry API ã¨ã—ã¦ã¯ PUT /telemetry ã® Subscribe API ã®ã¿ã§ã™ã€‚\nTelemetry API ã®è©³ç´° ã“ã“ã§ã¯ Telemetry API ã®è©³ç´°ã¨ã—ã¦ã€ä¸‹è¨˜ã® 2 ç‚¹ã«ã¤ã„ã¦æ•´ç†ã—ã¾ã™ã€‚\nSubscribe API - PUT /telemetry ã«ã¤ã„ã¦ Subscriber ã«å¯¾ã—ã¦é€ä¿¡ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã«ã¤ã„ã¦ 1. Subscribe API - PUT /telemetry ã«ã¤ã„ã¦ Subscribe API ã¯ã€ Extension ã‹ã‚‰ã‚³ãƒ¼ãƒ«ã™ã‚‹ Telemetry API ã¨ã—ã¦å”¯ä¸€å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ API ã§ã€å„ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹ãŸã‚ã® Subscriber ã®ç™»éŒ²ã‚’è¡Œã† API ã§ã™ã€‚\nä»•æ§˜ã«ã¤ã„ã¦ã¯ä¸‹è¨˜å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ãŒã€ä¸€éƒ¨è¼‰ã£ã¦ã„ãªã„é …ç›®ã‚‚ã‚ã£ãŸã®ã§ã‚ã‚‰ãŸã‚ã¦ã“ã“ã§æ•´ç†ã—ã¾ã™ã€‚\nLambda Telemetry API reference - AWS Lambda ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ\nPUT http://${AWS_LAMBDA_RUNTIME_API}/2022-07-01/telemetry ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€\nContent-Type: application/json Lambda-Extension-Identifier: POST /extension/register ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ã«å«ã¾ã‚Œã‚‹ ExtensionIdentifier ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£\nschemaVersion: 2022-07-01 (required) destination: Subscriber ã¨ã—ã¦èµ·å‹•ã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒã®æƒ…å ± (required) protocol: ãƒ—ãƒ­ãƒˆã‚³ãƒ« (HTTP or TCP) URI: ã‚¢ãƒ‰ãƒ¬ã‚¹ (\u0026ldquo;URI\u0026rdquo; ã¯å°æ–‡å­—ã˜ã‚ƒãªãã¦å¤§æ–‡å­—) types: å—ä¿¡ã—ãŸã„ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ã®é…åˆ— (platform, function, extension) (required) buffering: Telemetry API å´ã§ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°è¨­å®š (option) maxItems: æœ€å¤§ã‚¤ãƒ™ãƒ³ãƒˆæ•° maxBytes: æœ€å¤§ãƒã‚¤ãƒˆæ•° timeoutMs: æœ€å¤§ç§’æ•° (ãƒŸãƒªç§’) ä¾‹ { \u0026#34;schemaVersion\u0026#34;: \u0026#34;2022-07-01\u0026#34;, \u0026#34;types\u0026#34;: [ \u0026#34;platform\u0026#34;, \u0026#34;function\u0026#34;, ], \u0026#34;buffering\u0026#34;: { \u0026#34;maxItems\u0026#34;: 1000, \u0026#34;maxBytes\u0026#34;: 262144, \u0026#34;timeoutMs\u0026#34;: 100 }, \u0026#34;destination\u0026#34;: { \u0026#34;protocol\u0026#34;: \u0026#34;HTTP\u0026#34;, \u0026#34;URI\u0026#34;: \u0026#34;http://sandbox.localdomain:8080\u0026#34; } } Subscribe API ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹éš›ã«æ³¨æ„ã—ãŸã„ã®ã¯ã€ã¾ãš destination.URI ã®å€¤ã¨ã—ã¦ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒ sandbox.localdomain ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œä»¥å¤–ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§æŒ‡å®šã—ãŸå ´åˆã€ä¸‹è¨˜ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚\nstatusCode:403\nerrType:Telemetry.AccessDenied\nerrMessage:Only \u0026lsquo;sandbox.localdomain\u0026rsquo; hostname is supported.\nã¾ãŸã€ä¸Šè¨˜ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ Lambda-Extension-Identifier ã«é–¢ã™ã‚‹è¨˜è¿°ãŒã‚ã‚Šã¾ã›ã‚“ãŒã€è¨­å®šã—ãªã„ ã‚‚ã—ãã¯å€¤ãŒä¸æ­£ãªå ´åˆã¯ä¸‹è¨˜ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚\nstatusCode:403\nerrType:Extension.InvalidExtensionIdentifier\nerrMessage:Invalid Lambda-Extension-Identifier\n2. Subscriber ã«å¯¾ã—ã¦é€ä¿¡ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã«ã¤ã„ã¦ Telemetry API ã‹ã‚‰é€ä¿¡ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€å¤§ããåˆ†ã‘ã¦ Platform event, Function logs, Extension logs ã® 3 ã¤ã®ã‚«ãƒ†ã‚´ãƒªã«åˆ†ã‘ã‚‰ã‚Œã€å„ã‚«ãƒ†ã‚´ãƒªå†…ã§æ›´ã«ã„ã¤ã‹ã® Event type ã«åˆ†é¡ã•ã‚Œã¦ã„ã¾ã™ã€‚\nPlatform event platform.initStart platform.initRuntimeDone platform.initReport platform.start platform.runtimeDone platform.report platform.restoreStart platform.restoreRuntimeDone platform.restoreReport platform.extension platform.telemetrySubscription platform.logsDropped Function logs function Extension logs extension å„ Event type ã”ã¨ã« schema ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ãŒã€ Event å…¨ä½“ã® schema ã¨ã—ã¦ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚\n{ \u0026#34;time\u0026#34;: \u0026#34;ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºç”Ÿæ—¥æ™‚\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;Event type\u0026#34;, \u0026#34;record\u0026#34;: \u0026#34;å„ Event type ã® schema\u0026#34; } ä¾‹ãˆã°ã€ Extension ãŒç™»éŒ²ã•ã‚Œã¦èµ·å‹•çŠ¶æ…‹ã«ãªã£ãŸã“ã¨ã‚’ç¤ºã™ã‚¤ãƒ™ãƒ³ãƒˆ platform.extension ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãªã‚Šã¾ã™ã€‚\n{ \u0026#34;time\u0026#34;: \u0026#34;2022-10-12T00:02:15.000Z\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;platform.extension\u0026#34;, \u0026#34;record\u0026#34;: { \u0026#34;events\u0026#34;: [ \u0026#34;INVOKE\u0026#34;, \u0026#34;SHUTDOWN\u0026#34; ], \u0026#34;name\u0026#34;: \u0026#34;my-telemetry-extension\u0026#34;, \u0026#34;state\u0026#34;: \u0026#34;Ready\u0026#34; } } ãã®ä»–ã€å„ Event type ã® schema ã®è©³ç´°ã«ã¤ã„ã¦ã¯ä¸‹è¨˜ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚\nLambda Telemetry API Event schema reference - AWS Lambda Telemetry API ã‚’ä½¿ã† Extension ã‚’ä½œã£ã¦ã¿ã‚‹ ã§ã¯å®Ÿéš›ã« Telemetry API ã‚’ä½¿ã† Extension ã‚’ä½œã£ã¦ã¿ã¾ã™ã€‚å‰å›ã¨åŒæ§˜ã« Go ã§å®Ÿè£…ã—ã¾ã™ã€‚\nä»Šå›ä½œã‚‹ Extension ã§ã‚„ã‚‹ã“ã¨ã¯ä¸‹è¨˜ã®ã¨ãŠã‚Šã§ã™ã€‚\nplatform ã¨ function ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ Subscribe ã™ã‚‹ å—ã‘å–ã£ãŸã‚¤ãƒ™ãƒ³ãƒˆã®å†…å®¹ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã™ã‚‹ ä»¥ä¸Šã§ã™ã€‚\nExtension ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†ã«ã¤ã„ã¦ã¯å‰å›ã¨å¤§ããå¤‰ã‚ã‚‰ãªã„ã®ã§ã€ Telemetry API ã«é–¢é€£ã™ã‚‹ã¨ã“ã‚ã ã‘æ»ã„æ‘˜ã‚“ã§èª¬æ˜ã—ã¾ã™ã€‚\nå®Ÿè£…ã®è©³ç´°ã«ã¤ã„ã¦ã¯ä¸‹è¨˜ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚\naws-lambda-api-go/_examples/extension-using-telemetry-api at main Â· michimani/aws-lambda-api-go Telemetry API ã® Subscriber ã‚’èµ·å‹• ã¾ãšã¯ã€ Telemetry API ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ã—ã¦ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã® Subscriber ã‚’èµ·å‹•ã—ã¾ã™ã€‚\naws-lambda-api-go/subscriber.go at v0.2.0 Â· michimani/aws-lambda-api-go const defaultSubscriberPort = \u0026#34;1210\u0026#34; const address = \u0026#34;sandbox.localdomain:\u0026#34; + defaultSubscriberPort type TelemetryAPISubscriber struct { httpServer *http.Server logger *logger.Logger } func NewTelemetryAPISubscriber(l *logger.Logger) *TelemetryAPISubscriber { return \u0026amp;TelemetryAPISubscriber{ httpServer: nil, logger: l, } } func (s *TelemetryAPISubscriber) Start() (string, error) { s.logger.Info(\u0026#34;Starting on address:%s\u0026#34;, address) s.httpServer = \u0026amp;http.Server{Addr: address} http.HandleFunc(\u0026#34;/\u0026#34;, s.telemetryEventHandler) go func() { err := s.httpServer.ListenAndServe() if err != http.ErrServerClosed { s.logger.Error(\u0026#34;Unexpected stop on Http Server. err:%v\u0026#34;, err) s.Shutdown() } else { s.logger.Info(\u0026#34;Http Server closed. err:%v\u0026#34;, err) } }() return fmt.Sprintf(\u0026#34;http://%s/\u0026#34;, address), nil } TelemetryAPISubscriber ã‚’è¿”ã™ NewTelemetryAPISubscriber ã¨ã€ TelemetryAPISubscriber ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦ Start ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚\nTelemetryAPISubscriber.Start ã§ã€ sandbox.localdomain:1210 ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ HTTP ã‚µãƒ¼ãƒã‚’èµ·å‹•ã—ã¦ã„ã¾ã™ã€‚HTTP ã‚µãƒ¼ãƒã§ã¯ / ã«å¯¾ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¦ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (Telemetry API ã‹ã‚‰é€ä¿¡ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ) ã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹ TelemetryAPISubscriber.telemetryEventHandler ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚\nã‚µãƒ¼ãƒã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã“ã®ã‚ã¨ã® Subscribe API ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹éš›ã«å¿…è¦ã«ãªã‚‹ã®ã§å‘¼ã³å‡ºã—å…ƒ (= Extension ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†) ã«è¿”ã—ã¾ã™ã€‚\nSubscribe API ã‚’ã‚³ãƒ¼ãƒ«ã—ã¦ Subscriber ã‚’ç™»éŒ² ç¶šã„ã¦ã€èµ·å‹•ã—ãŸ Subscriber ã®æƒ…å ±ã¨å—ä¿¡ã—ãŸã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ Subscribe API ã‚’ä½¿ã£ã¦ç™»éŒ²ã—ã¾ã™ã€‚\naws-lambda-api-go/client.go at v0.2.0 Â· michimani/aws-lambda-api-go func (c *Client) Subscribe(ctx context.Context, exId string, httpURI string) error { var bufTimeoutMs uint64 = 100 out, err := telemetry.Subscribe(ctx, c.alagoClient, \u0026amp;telemetry.SubscribeInput{ LambdaExtensionIdentifier: exId, DestinationProtocol: telemetry.DestinationProtocolHTTP, DestinationURI: httpURI, TelemetryTypes: []telemetry.TelemetryType{ telemetry.TelemetryTypeFunction, telemetry.TelemetryTypePlatform, }, BufferTimeoutMs: \u0026amp;bufTimeoutMs, }) if err != nil { c.logger.Error(\u0026#34;An error occurred at telemetrySubscribe. err:%v\u0026#34;, err) return err } if out.StatusCode != http.StatusOK { return fmt.Errorf(\u0026#34;An error occurred at extension registration. statusCode:%d errType:%s errMessage:%s\u0026#34;, out.StatusCode, out.Error.ErrorType, out.Error.ErrorMessage) } return nil } ä»Šå›ã‚‚ã€ã‚¯ãƒ©ã‚¤ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ aws-lambda-api-go ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚\nå—ä¿¡ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€ platform ã¨ function ã«ã—ã¦ã„ã¾ã™ã€‚ (extension ã¯ã‚¤ãƒ™ãƒ³ãƒˆã®æ•°ãŒå¤šã™ããŸã®ã§é™¤å¤–ã—ã¾ã—ãŸ)\nã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°å‘¼ã³å‡ºã—å…ƒã«è¿”ã™ã€ãŸã ãã‚Œã ã‘ã®å‡¦ç†ã«ãªã£ã¦ã„ã¾ã™ã€‚\nã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° æœ€å¾Œã«ã€Telemetry API ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã§ã™ã€‚\naws-lambda-api-go/subscriber.go at v0.2.0 Â· michimani/aws-lambda-api-go type telemetryAPIEvent struct { Record any `json:\u0026#34;record\u0026#34;` Type string `json:\u0026#34;type\u0026#34;` Time time.Time `json:\u0026#34;time\u0026#34;` } func (s *TelemetryAPISubscriber) telemetryEventHandler(w http.ResponseWriter, r *http.Request) { body, err := io.ReadAll(r.Body) if err != nil { s.logger.Error(\u0026#34;Failed to reading body. err:%v\u0026#34;, err) return } var events []telemetryAPIEvent _ = json.Unmarshal(body, \u0026amp;events) s.logger.Info(\u0026#34;Received %d events.\u0026#34;, len(events)) for i, e := range events { s.logger.Info(\u0026#34;%d: Time:%s Type:%s Record:%v\u0026#34;, i, e.Time.Format(time.RFC3339Nano), e.Type, e.Record) } events = nil } ä»Šå›ã¯ã‚¤ãƒ™ãƒ³ãƒˆã®å¤§æ ã¨ãªã‚‹ schema ã«å¯¾å¿œã™ã‚‹æ§‹é€ ä½“ telemetryAPIEvent ã ã‘ç”¨æ„ã—ã¦ã€å„ã‚¤ãƒ™ãƒ³ãƒˆã”ã¨ã® schema ã«å¯¾å¿œã™ã‚‹æ§‹é€ ä½“ã®å®šç¾©ã«ã¤ã„ã¦ã¯çœç•¥ã—ã¦ã„ã¾ã™ã€‚\nã¾ãŸã€ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨è¨€ã£ã¦ã‚‚ä»Šå›ã¯ãƒ­ã‚°ã«å‡ºåŠ›ã™ã‚‹ã ã‘ãªã®ã§ã€ç‰¹ã«é›£ã—ã„ã“ã¨ã¯ã—ã¦ã„ã¾ã›ã‚“ã€‚\nLambda é–¢æ•°ã§ä½¿ã£ã¦ã¿ã‚‹ å‰å›ã¨åŒæ§˜ã« RIE ã‚’ä½¿ã£ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã§è©¦ãã†ã¨æ€ã£ãŸã‚“ã§ã™ãŒã€ã©ã†ã‚„ã‚‰ Telemetry API ã¯ã¾ã  RIE (ãŒå«ã¾ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸) ã§ã¯å¯¾å¿œã—ã¦ã„ãªã„ã‚ˆã†ã ã£ãŸ1ã®ã§å®Ÿéš›ã®ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚\næº–å‚™ å®Ÿéš›ã« Lambda ã§å®Ÿè¡Œã—ã¦ç¢ºèªã™ã‚‹ã¾ã§ã®æº–å‚™ã¨ã—ã¦ã€ Extension ã¨é–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚\nExtension ã«ã¤ã„ã¦ã¯ Lambda Layer ã¨ã—ã¦ä½œæˆã™ã‚‹ã®ã§ã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ build -\u0026gt; zip åŒ–ã—ã¾ã™ã€‚\nGOOS=linux GOARCH=amd64 go build -o ../bin/extensions/telemetry-api-extension main.go chmod +x bin/extensions/telemetry-api-extension cd bin \u0026amp;\u0026amp; zip -r extension.zip extensions/ Lambda é–¢æ•°ã«ã¤ã„ã¦ã¯ãŸã ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹å‡¦ç†ã ã‘ã‚ã‚Œã°ã‚ˆã•ãã†ãªã®ã§ã€ä¸‹è¨˜ã®ã‚ˆã†ãªå†…å®¹ã§ Python ã§å®Ÿè£…ã—ã¾ã—ãŸã€‚\nimport json import logging def lambda_handler(event, context): logger = logging.getLogger() logger.setLevel(logging.INFO) logger.info(\u0026#39;[%s] Hello Telemetry API!\u0026#39;, context.aws_request_id) return { \u0026#39;statusCode\u0026#39;: 200, \u0026#39;body\u0026#39;: json.dumps(\u0026#39;Hello from Lambda!\u0026#39;) } ã“ã¡ã‚‰ã‚‚ zip åŒ–ã—ã¦ãŠãã¾ã™ã€‚\nzip function.zip main.py ã¾ãŸã€ Lambda é–¢æ•°ã®ä½œæˆæ™‚ã«ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ IAM Role ãŒå¿…è¦ã«ãªã‚‹ã®ã§ã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ä½œæˆã—ã¦ãŠãã¾ã™ã€‚\n# IAM Role ã®ä½œæˆ aws iam create-role \\ --role-name telemetry-api-function-role \\ --assume-role-policy-document \u0026#39;{\u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;,\u0026#34;Statement\u0026#34;: [{ \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: {\u0026#34;Service\u0026#34;: \u0026#34;lambda.amazonaws.com\u0026#34;}, \u0026#34;Action\u0026#34;: \u0026#34;sts:AssumeRole\u0026#34;}]}\u0026#39; \\ --query \u0026#39;Role.Arn\u0026#39; \\ --output text # IAM Policy ã‚’ã‚¢ã‚¿ãƒƒãƒ aws iam attach-role-policy \\ --role-name telemetry-api-function-role \\ --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole Extension ã¨ ãã‚Œã‚’ä½¿ã†é–¢æ•°ã‚’ä½œæˆ æº–å‚™ãŒã§ããŸã®ã§ã€ Extension (Lambda Layer) ã¨ Lambda é–¢æ•°ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚\nExtension ã¯ Lambda Layer ã¨ã—ã¦ä½œæˆã™ã‚‹ã®ã§ã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚\naws lambda publish-layer-version \\ --layer-name \u0026#39;telemetry-api-extension\u0026#39; \\ --zip-file \u0026#39;fileb://bin/extension.zip\u0026#39; \\ --region ap-northeast-1 Lambda é–¢æ•°ã«ã¤ã„ã¦ã¯ã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ä½œæˆã—ã¾ã™ã€‚ä¸­ã§ AWS CLI ã‚³ãƒãƒ³ãƒ‰ã‚’å©ã„ã¦ã„ã¦ã‚„ã‚„ã“ã—ãè¦‹ãˆã¾ã™ãŒã€å„ ARN è¨˜è¿°ã™ã‚‹å¿…è¦ãŒãªãã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ID ã«ä¾å­˜ã—ãªã„å½¢ã«ãªã£ã¦ã„ã¾ã™ã€‚\naws lambda create-function \\ --function-name \u0026#39;function-with-telemetry-api-extension\u0026#39; \\ --runtime \u0026#39;python3.9\u0026#39; \\ --handler \u0026#39;main.lambda_handler\u0026#39; \\ --role $( aws iam get-role \\ --role-name \u0026#39;telemetry-api-function-role\u0026#39; \\ --query \u0026#39;Role.Arn\u0026#39; \\ --output text) \\ --zip-file fileb://function.zip \\ --layers $( aws lambda list-layer-versions \\ --layer-name \u0026#39;telemetry-api-extension\u0026#39; \\ --query \u0026#39;LayerVersions[0].LayerVersionArn\u0026#39; \\ --output text) \\ --region ap-northeast-1 å®Ÿè¡Œã—ã¦ãƒ­ã‚°ã‚’ç¢ºèª Extension ã‚’è¨­å®šã—ãŸ Lambda é–¢æ•°ãŒä½œæˆã§ããŸã®ã§ã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚\naws lambda invoke \\ --function-name \u0026#39;function-with-telemetry-api-extension\u0026#39; \\ --invocation-type \u0026#39;RequestResponse\u0026#39; \\ --cli-binary-format \u0026#39;raw-in-base64-out\u0026#39; \\ --region \u0026#39;ap-northeast-1\u0026#39; \\ --log-type \u0026#39;Tail\u0026#39; \\ /dev/stdout \\ | jq -sr \u0026#39;.[1] | .LogResult\u0026#39; \\ | base64 -d ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ Lambda é–¢æ•°å®Ÿè¡Œæ™‚ã®ãƒ­ã‚°ãŒæ‰‹å…ƒã§ç¢ºèªã§ãã¾ã™ã€‚\n1[Telemetry API Extension Client] INFO: Succeeded to register extension. 2[Telemetry API Subscriber] INFO: Starting on address:sandbox.localdomain:1210 3TELEMETRY Name: telemetry-api-extension State: Subscribed Types: [function,platform] 4[Telemetry API Subscriber] INFO: Received 1 events. 5[Telemetry API Subscriber] INFO: 0: Time:2022-12-11T10:21:53.222Z Type:platform.initStart Record:map[initializationType:on-demand phase:init] 6[Telemetry API Extension Client] INFO: Waiting for next event... 7[Telemetry API Subscriber] INFO: Received 1 events. 8[Telemetry API Subscriber] INFO: 0: Time:2022-12-11T10:21:53.277Z Type:platform.telemetrySubscription Record:map[name:telemetry-api-extension state:Subscribed types:[function platform]] 9EXTENSION Name: telemetry-api-extension State: Ready Events: [SHUTDOWN,INVOKE] 10START RequestId: eded6372-e614-4305-8516-f2697c3acfbc Version: $LATEST 11[Telemetry API Extension Client] INFO: Received invoke event. awsRequestId:eded6372-e614-4305-8516-f2697c3acfbc invokedAt:2022-12-11 10:21:53.381772081 +0000 UTC 12[Telemetry API Extension Client] INFO: Waiting for next event... 13[INFO] 2022-12-11T10:21:53.382Z eded6372-e614-4305-8516-f2697c3acfbc [eded6372-e614-4305-8516-f2697c3acfbc] Hello Telemetry API! 14END RequestId: eded6372-e614-4305-8516-f2697c3acfbc 15REPORT RequestId: eded6372-e614-4305-8516-f2697c3acfbc Duration: 17.38 ms Billed Duration: 18 ms Memory Size: 128 MB Max Memory Used: 45 MB Init Duration: 157.98 ms ãªã‚“ã¨ãªãå†’é ­ã«æ›¸ã„ãŸã‚ˆã†ãªé †ç•ªã§å‡¦ç†ãŒã•ã‚Œã¦ãã†ãªã“ã¨ãŒã‚ã‹ã‚‹ã¨æ€ã„ã¾ã™ã€‚\nä¾‹ãˆã°ã€ 1 è¡Œç›®ã®\n[Telemetry API Extension Client] INFO: Succeeded to register extension.\nã§ã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç¤ºã™ã¨ãŠã‚Š Extension ã®ç™»éŒ²ãŒå®Œäº†ã—ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚\nã¾ãŸã€ 4-5 è¡Œç›®ã®\n[Telemetry API Subscriber] INFO: Received 1 events. [Telemetry API Subscriber] INFO: 0: Time:2022-12-11T10:21:53.222Z Type:platform.initStart Record:map\nã§ã¯ã€ Telemetry API ã‹ã‚‰ Platform ã«é–¢ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚\nã¨ã¯è¨€ãˆã€ä¸€åº¦é–¢æ•°ã‚’å®Ÿè¡Œã—ãŸã ã‘ã§ã¯é›°å›²æ°—ãŒæ´ã¿ã¥ã‚‰ã„ã¨æ€ã†ã®ã§ã€ä½•åº¦ã‹ invoke-function ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸå¾Œã«ã€ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§ CloudWatch Logs ã«å‡ºåŠ›ã•ã‚ŒãŸãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚\naws logs get-log-events \\ --log-group-name /aws/lambda/function-with-telemetry-api-extension \\ --log-stream-name \u0026#34;$( aws logs describe-log-streams \\ --log-group-name /aws/lambda/function-with-telemetry-api-extension \\ --query \u0026#39;max_by(logStreams[], \u0026amp;lastEventTimestamp).logStreamName\u0026#39; \\ --output text)\u0026#34; \\ --limit 100 \\ --query \u0026#39;events[].message\u0026#39; \\ --output text å¾—ã‚‰ã‚Œã‚‹å‡ºåŠ›ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\n1[Telemetry API Extension Client] INFO: Succeeded to register extension. 2[Telemetry API Subscriber] INFO: Starting on address:sandbox.localdomain:1210 3TELEMETRY\tName: telemetry-api-extension\tState: Subscribed\tTypes: [function,platform] 4[Telemetry API Extension Client] INFO: Waiting for next event... 5[Telemetry API Subscriber] INFO: Received 1 events. 6[Telemetry API Subscriber] INFO: 0: Time:2022-12-11T10:32:46.331Z Type:platform.initStart Record:map[initializationType:on-demand phase:init] 7[Telemetry API Subscriber] INFO: Received 1 events. 8[Telemetry API Subscriber] INFO: 0: Time:2022-12-11T10:32:46.389Z Type:platform.telemetrySubscription Record:map[name:telemetry-api-extension state:Subscribed types:[function platform]] 9EXTENSION\tName: telemetry-api-extension\tState: Ready\tEvents: [SHUTDOWN,INVOKE] 10START RequestId: e63295fe-c7a1-48c2-ada2-c7044c697c12 Version: $LATEST 11[Telemetry API Extension Client] INFO: Received invoke event. awsRequestId:e63295fe-c7a1-48c2-ada2-c7044c697c12 invokedAt:2022-12-11 10:32:46.510767828 +0000 UTC 12[Telemetry API Extension Client] INFO: Waiting for next event... 13[INFO]\t2022-12-11T10:32:46.511Z\te63295fe-c7a1-48c2-ada2-c7044c697c12\t[e63295fe-c7a1-48c2-ada2-c7044c697c12] Hello Telemetry API! 14END RequestId: e63295fe-c7a1-48c2-ada2-c7044c697c12 15REPORT RequestId: e63295fe-c7a1-48c2-ada2-c7044c697c12\tDuration: 16.30 ms\tBilled Duration: 17 ms\tMemory Size: 128 MB\tMax Memory Used: 46 MB\tInit Duration: 177.38 ms 16[Telemetry API Subscriber] INFO: Received 7 events. 17[Telemetry API Subscriber] INFO: 0: Time:2022-12-11T10:32:46.507Z Type:platform.initRuntimeDone Record:map[initializationType:on-demand phase:init status:success] 18[Telemetry API Subscriber] INFO: 1: Time:2022-12-11T10:32:46.508Z Type:platform.extension Record:map[events:[SHUTDOWN INVOKE] name:telemetry-api-extension state:Ready] 19[Telemetry API Subscriber] INFO: 2: Time:2022-12-11T10:32:46.508Z Type:platform.initReport Record:map[initializationType:on-demand metrics:map[durationMs:176.689] phase:init] 20[Telemetry API Subscriber] INFO: 3: Time:2022-12-11T10:32:46.51Z Type:platform.start Record:map[requestId:e63295fe-c7a1-48c2-ada2-c7044c697c12 version:$LATEST] 21[Telemetry API Subscriber] INFO: 4: Time:2022-12-11T10:32:46.511Z Type:function Record:[INFO]\t2022-12-11T10:32:46.511Z\te63295fe-c7a1-48c2-ada2-c7044c697c12\t[e63295fe-c7a1-48c2-ada2-c7044c697c12] Hello Telemetry API! 22[Telemetry API Subscriber] INFO: 5: Time:2022-12-11T10:32:46.526Z Type:platform.runtimeDone Record:map[metrics:map[durationMs:15.686 producedBytes:53] requestId:e63295fe-c7a1-48c2-ada2-c7044c697c12 spans:[map[durationMs:1.26 name:responseLatency start:2022-12-11T10:32:46.510Z] map[durationMs:0.021 name:responseDuration start:2022-12-11T10:32:46.511Z]] status:success] 23[Telemetry API Subscriber] INFO: 6: Time:2022-12-11T10:32:46.532Z Type:platform.report Record:map[metrics:map[billedDurationMs:17 durationMs:16.295 initDurationMs:177.377 maxMemoryUsedMB:46 memorySizeMB:128] requestId:e63295fe-c7a1-48c2-ada2-c7044c697c12 status:success] 24START RequestId: 29fffe63-ae9a-4dce-ad28-0a2bd117e5fe Version: $LATEST 25[Telemetry API Extension Client] INFO: Received invoke event. awsRequestId:29fffe63-ae9a-4dce-ad28-0a2bd117e5fe invokedAt:2022-12-11 10:32:49.885648337 +0000 UTC 26[Telemetry API Extension Client] INFO: Waiting for next event... 27[INFO]\t2022-12-11T10:32:49.885Z\t29fffe63-ae9a-4dce-ad28-0a2bd117e5fe\t[29fffe63-ae9a-4dce-ad28-0a2bd117e5fe] Hello Telemetry API! 28END RequestId: 29fffe63-ae9a-4dce-ad28-0a2bd117e5fe 29REPORT RequestId: 29fffe63-ae9a-4dce-ad28-0a2bd117e5fe\tDuration: 1.30 ms\tBilled Duration: 2 ms\tMemory Size: 128 MB\tMax Memory Used: 46 MB 30[Telemetry API Subscriber] INFO: Received 4 events. 31[Telemetry API Subscriber] INFO: 0: Time:2022-12-11T10:32:49.885Z Type:platform.start Record:map[requestId:29fffe63-ae9a-4dce-ad28-0a2bd117e5fe version:$LATEST] 32[Telemetry API Subscriber] INFO: 1: Time:2022-12-11T10:32:49.886Z Type:function Record:[INFO]\t2022-12-11T10:32:49.885Z\t29fffe63-ae9a-4dce-ad28-0a2bd117e5fe\t[29fffe63-ae9a-4dce-ad28-0a2bd117e5fe] Hello Telemetry API! 33[Telemetry API Subscriber] INFO: 2: Time:2022-12-11T10:32:49.886Z Type:platform.runtimeDone Record:map[metrics:map[durationMs:1.065 producedBytes:53] requestId:29fffe63-ae9a-4dce-ad28-0a2bd117e5fe spans:[map[durationMs:0.791 name:responseLatency start:2022-12-11T10:32:49.885Z] map[durationMs:0.032 name:responseDuration start:2022-12-11T10:32:49.886Z]] status:success] 34[Telemetry API Subscriber] INFO: 3: Time:2022-12-11T10:32:49.887Z Type:platform.report Record:map[metrics:map[billedDurationMs:2 durationMs:1.3 maxMemoryUsedMB:46 memorySizeMB:128] requestId:29fffe63-ae9a-4dce-ad28-0a2bd117e5fe status:success] 35[Telemetry API Extension Client] INFO: Received shutdown event. reason:spindown Telemetry API ã‹ã‚‰é€ä¿¡ã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã¯ Subscribe API ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹ã¨ãã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«ã‚»ãƒƒãƒˆã™ã‚‹ buffering ã®è¨­å®šã«å¾“ã£ã¦ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ãŸã‚å®Ÿéš›ã®ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ã¨ã¯å¤šå°‘ã®ãƒ©ã‚°ãŒã‚ã‚Šã¾ã™ã€‚ãŸã ã€ 24-34 è¡Œç›®ã‚ãŸã‚Šã¯æ™®æ®µã® Lambda é–¢æ•°å®Ÿè¡Œæ™‚ã«å‡ºåŠ›ã•ã‚Œã‚‹ãƒ­ã‚°ã¨ã€Telemetry API ã®ã‚¤ãƒ™ãƒ³ãƒˆã¨ãŒã‚ã‹ã‚Šã‚„ã™ã„ã‹ã¨æ€ã„ã¾ã™ã€‚\n24START RequestId: 29fffe63-ae9a-4dce-ad28-0a2bd117e5fe Version: $LATEST 25[Telemetry API Extension Client] INFO: Received invoke event. awsRequestId:29fffe63-ae9a-4dce-ad28-0a2bd117e5fe invokedAt:2022-12-11 10:32:49.885648337 +0000 UTC 26[Telemetry API Extension Client] INFO: Waiting for next event... 27[INFO]\t2022-12-11T10:32:49.885Z\t29fffe63-ae9a-4dce-ad28-0a2bd117e5fe\t[29fffe63-ae9a-4dce-ad28-0a2bd117e5fe] Hello Telemetry API! 28END RequestId: 29fffe63-ae9a-4dce-ad28-0a2bd117e5fe 29REPORT RequestId: 29fffe63-ae9a-4dce-ad28-0a2bd117e5fe\tDuration: 1.30 ms\tBilled Duration: 2 ms\tMemory Size: 128 MB\tMax Memory Used: 46 MB 30[Telemetry API Subscriber] INFO: Received 4 events. 31[Telemetry API Subscriber] INFO: 0: Time:2022-12-11T10:32:49.885Z Type:platform.start Record:map[requestId:29fffe63-ae9a-4dce-ad28-0a2bd117e5fe version:$LATEST] 32[Telemetry API Subscriber] INFO: 1: Time:2022-12-11T10:32:49.886Z Type:function Record:[INFO]\t2022-12-11T10:32:49.885Z\t29fffe63-ae9a-4dce-ad28-0a2bd117e5fe\t[29fffe63-ae9a-4dce-ad28-0a2bd117e5fe] Hello Telemetry API! 33[Telemetry API Subscriber] INFO: 2: Time:2022-12-11T10:32:49.886Z Type:platform.runtimeDone Record:map[metrics:map[durationMs:1.065 producedBytes:53] requestId:29fffe63-ae9a-4dce-ad28-0a2bd117e5fe spans:[map[durationMs:0.791 name:responseLatency start:2022-12-11T10:32:49.885Z] map[durationMs:0.032 name:responseDuration start:2022-12-11T10:32:49.886Z]] status:success] 34[Telemetry API Subscriber] INFO: 3: Time:2022-12-11T10:32:49.887Z Type:platform.report Record:map[metrics:map[billedDurationMs:2 durationMs:1.3 maxMemoryUsedMB:46 memorySizeMB:128] requestId:29fffe63-ae9a-4dce-ad28-0a2bd117e5fe status:success] å„è¡Œã®ãƒ­ã‚°ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªæƒ…å ±ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚\nLambda é–¢æ•°ãŒ Invoke ã•ã‚ŒãŸ Extension API ã® GET /extension/event/next ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦ INVOKE ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾— å†åº¦ Extension API ã® GET /extension/event/next ã‚’ã‚³ãƒ¼ãƒ«ã—ã¦æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…æ©Ÿ Lambda é–¢æ•°ã® logger.info() ãŒå‡ºåŠ›ã—ã¦ã„ã‚‹ãƒ­ã‚° Lambda é–¢æ•°ã®çµ‚äº† Lambda é–¢æ•°ã®å®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ Subscriber ãŒ Telemetry API ã‹ã‚‰ã€ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ãŸ 4 ã¤ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ã—ãŸ platform.start ã‚¤ãƒ™ãƒ³ãƒˆ (24 è¡Œç›®: Lambda é–¢æ•°ã® Invoke ã«å¯¾å¿œ) function ã‚¤ãƒ™ãƒ³ãƒˆ (27 è¡Œç›®: Lambda é–¢æ•°å†…ã§ã®ãƒ­ã‚°å‡ºåŠ›ã«å¯¾å¿œ) platform.runtimeDone ã‚¤ãƒ™ãƒ³ãƒˆ (28 è¡Œç›®: Lambda é–¢æ•°ã®çµ‚äº†ã«å¯¾å¿œ) platform.report ã‚¤ãƒ™ãƒ³ãƒˆ (29 è¡Œç›®: Lambda é–¢æ•°ã®å®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆã«å¯¾å¿œ) ä»¥ä¸Šã§ã€ Telemetry API ã«ã‚ˆã£ã¦ã©ã®ã‚ˆã†ãªã‚¤ãƒ™ãƒ³ãƒˆãŒå–å¾—ã§ãã‚‹ã®ã‹ã€å®Ÿéš›ã® Lambda é–¢æ•°ã®å®Ÿè¡Œã¨åˆã‚ã›ã¦ç¢ºèªãŒã§ãã¾ã—ãŸã€‚\nã¾ã¨ã‚ AWS Lambda ã® Telemetry API ã‚’ä½¿ã£ãŸ Lambda Extension ã‚’ä½œã£ã¦ã¿ãŸè©±ã§ã—ãŸã€‚\nTelemetry API ã®ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’è¦‹ãŸã¨ãã¯ã€ŒãŠã€ãªã‚“ã‹å‡„ãã†ï¼Ÿã€ã¨ã„ã†æ„Ÿæƒ³ã ã‘ã§ã—ãŸãŒã€å®Ÿéš›ã«ã“ã‚Œã‚’ä½¿ã† Extension ã‚’ä½œã£ã¦ã¿ã¦ã©ã®ã‚ˆã†ãªæŒ™å‹•ã‚’ã™ã‚‹ã‚‚ã®ãªã®ã‹ã€ç†è§£ãŒã§ããŸæ°—ãŒã—ã¾ã™ã€‚\nä»Šå›ã¯ãŸã å—ã‘å–ã£ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ­ã‚°ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã ã‘ã§ã—ãŸãŒã€ä¾‹ãˆã° function ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã—ã¦ Lambda é–¢æ•°ãŒå‡ºåŠ›ã—ã¦ã„ã‚‹ãƒ­ã‚°ã®æ–‡å­—åˆ—ã‚’è§£æã—ã¦ç‹¬è‡ªã®ãƒ¬ãƒãƒ¼ãƒˆã‚’å‡ºåŠ›ã™ã‚‹ ã¿ãŸã„ãªã“ã¨ã‚’ã‚„ã‚‹ã¨é¢ç™½ãã†ã ãªã¨æ€ã„ã¾ã™ã€‚\nå¼è­·å£«ãƒ‰ãƒƒãƒˆã‚³ãƒ  Advent Calendar 2022 ã€æ˜æ—¥ã®æ‹…å½“ã¯ @shellme ã§ã™ã€‚ãŠæ¥½ã—ã¿ã«ã€‚\nSubscribe API ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹ã¨ã“ã‚ã§ 404 Page Not Found ãŒè¿”ã£ã¦ãã¾ã—ãŸ\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n",
    "permalink": "https://michimani.net/post/aws-lambda-extension-using-telemetry-api/",
    "title": "Telemetry API ã‚’ä½¿ã† Lambda Extension ã‚’ä½œã£ã¦ã¿ãŸ"
  },
  {
    "contents": "ã“ã®è¨˜äº‹ã¯ AWS Lambdaã¨Serverless Advent Calendar 2022 7 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚\næœ€è¿‘ Lambda ã® Runtime API ã«ã¤ã„ã¦èª¿ã¹ã¦ã„ãŸã¨ã“ã‚ã§ Extension API ã¨ã„ã†ã‚‚ã®ã‚‚ã‚ã‚‹äº‹ã«æ°—ã¥ãã¾ã—ãŸã€‚ã©ã†ã‚„ã‚‰ Lambda Extension ã‚’è‡ªä½œã™ã‚‹ã¨ãã«ä½¿ã† API ã®ã‚ˆã†ã ã£ãŸã®ã§ã€ãã® API ã‚’ä½¿ã„ãŸã„ãŒãŸã‚ã«å®Ÿéš›ã« Lambda Extension ã‚’è‡ªä½œã—ã¦ã¿ã¾ã—ãŸã€‚\nLambda Extension ã¨ã¯ å®Ÿè¡Œç’°å¢ƒã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã¨ Extension Init Invoke Shutdown Go ã§ Lambda Extension ã‚’ä½œã£ã¦ã¿ã‚‹ è‡ªä½œã™ã‚‹ Extension ã®æ¦‚è¦ å®Ÿè£… Extension ã®ãƒ¡ã‚¤ãƒ³å‡¦ç† POST /extension/register ã§å®Ÿè¡Œç’°å¢ƒã« Extension ã‚’ç™»éŒ² GET /extension/event/next ã§æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ãƒ»ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° è‡ªä½œã—ãŸ Extension ã‚’ Lambda é–¢æ•°ã§ä½¿ã† Extension ã®å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ Lambda é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ Dockerfile ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ã—ã¦ invoke ã¾ã¨ã‚ Lambda Extension ã¨ã¯ Lambda Extension (ä»¥ä¸‹ã€ Extension) ã¯ã€ Lambda é–¢æ•°ã® Runtime ã®ä¸€éƒ¨ã€ã‚‚ã—ãã¯å®Ÿè¡Œç’°å¢ƒå†…ã§ç‹¬ç«‹ã—ãŸãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦æ§˜ã€…ãªæ©Ÿèƒ½ã‚’å®Ÿè¡Œã§ãã‚‹æ©Ÿèƒ½ã§ã™ã€‚ãã‚Œãã‚Œã€å‰è€…ã¯å†…éƒ¨æ‹¡å¼µæ©Ÿèƒ½ã€å¾Œè€…ã¯å¤–éƒ¨æ‹¡å¼µæ©Ÿèƒ½ã¨å‘¼ã°ã‚Œã€ã“ã®è¨˜äº‹å†…ã§è§¦ã‚Œã‚‹ Extension ã¯å¾Œè€…ã®å¤–éƒ¨æ‹¡å¼µæ©Ÿèƒ½ã‚’æŒ‡ã™ã‚‚ã®ã¨ã—ã¾ã™ã€‚\nExtension ã¯ã€ AWS ãŒæä¾›ã—ã¦ã„ã‚‹ã‚‚ã®ã€ AWS Lambda ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ 1 ãŒæä¾›ã—ã¦ã„ã‚‹ã‚‚ã®ã€ãŠã‚ˆã³ä»Šå›ç´¹ä»‹ã™ã‚‹ã‚ˆã†ã«ç‹¬è‡ªã® Extension ã‚’ä½œæˆã—ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ æœ€è¿‘ã ã¨ AWS ã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ AWS Parameters and Secrets Lambda Extension 2 3 ãŒæ³¨ç›®ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚\nLambda ã¯å®Ÿè¡Œç’°å¢ƒä¸Šã§é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ãŒã€ Extension ã¯ãã®å®Ÿè¡Œç’°å¢ƒãŒä½œæˆã•ã‚Œã‚‹éš›ã«é–‹å§‹ã•ã‚Œã¾ã™ã€‚\nãã—ã¦ã€é–¢æ•°ã¨åŒã˜å®Ÿè¡Œç’°å¢ƒä¸Šã§èµ·å‹•ã™ã‚‹ãŸã‚ Extension è‡ªä½“ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ (åˆæœŸåŒ–ã«ã‹ã‹ã‚‹æ™‚é–“ã€å‡¦ç†æ™‚é–“ã€ãƒ¡ãƒ¢ãƒªæ¶ˆè²»é‡ãªã©) ã¯é–¢æ•°ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«ã‚‚å½±éŸ¿ã—ã¾ã™ã€‚ãã®ãŸã‚ã€ Extension ã‚’è‡ªä½œã™ã‚‹éš›ã«ã¯ã€ãã®ã‚ãŸã‚Šã«ã‚‚æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚\nå‚è€ƒ: Lambda extensions - AWS Lambda å®Ÿè¡Œç’°å¢ƒã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã¨ Extension Lambda ã®å®Ÿè¡Œç’°å¢ƒã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã«ã¯ã€ Init ã€ Invoke ã€ Shutdown ã¨ã„ã† 3 ã¤ã®ãƒ•ã‚§ãƒ¼ã‚ºãŒã‚ã‚Šã¾ã™ã€‚å„ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯å®Ÿè¡Œç’°å¢ƒã®ä½œæˆã‚„é–¢æ•°ã® Invokeã€å®Ÿè¡Œç’°å¢ƒã®ç ´æ£„ãªã©ã‚’è¡Œã„ã€ Extension ã¯å„ãƒ•ã‚§ãƒ¼ã‚ºã§ Extension API ã‚’ä½¿ç”¨ã—ã¦ Runtime ã¸ã®ç™»éŒ²ã‚„å®Ÿè¡Œç’°å¢ƒã§ç™ºç”Ÿã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã®æ¤œçŸ¥ã‚’è¡Œã„ã€ Extension ã¨ã—ã¦ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\nsequenceDiagram participant c as Client participant ls as Lambda Service participant r as Runtime participant e as Extension alt Init ls -\u003e\u003e e: init extensions in /ops/extensions e -\u003e\u003e ls: POST /extension/register e -\u003e\u003e ls: GET /extension/event/next end loop alt Invoke c -\u003e\u003e ls: invoke ls -\u003e\u003e r: invoke ls -\u003e\u003e e: response of GET /extension/event/next (INVOKE event) r -\u003e\u003e ls: /response (Runtime API) ls -\u003e\u003e c: response e -\u003e\u003e ls: GET /extension/event/next end end alt Shutdown ls -\u003e\u003e r: SIGTERM ls -\u003e\u003e e: response of GET /extension/event/next (SHUTDOWN event) end Init å®Ÿè¡Œç’°å¢ƒã®ä½œæˆ é–¢æ•°ã®ãƒãƒ³ãƒ‰ãƒ©å¤–éƒ¨ã«ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œ æ‰€è¬‚ã€€\u0026ldquo;ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆ\u0026rdquo;ã€€æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒ•ã‚§ãƒ¼ã‚º Extension ã¨ã®é–¢ä¿‚ /opt/extensions ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«ã‚ã‚‹å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Extension ã¨ã—ã¦è§£é‡ˆã—ã€ãã‚Œã‚‰ã‚’ä¸¦åˆ—ã§å®Ÿè¡Œ (é–‹å§‹) é–‹å§‹ã•ã‚ŒãŸ Extension ã¯ Extension POST /extension/register Extension API ã‚’ã‚³ãƒ¼ãƒ«ã—ã¦ Runtime ã« Extension ã‚’ç™»éŒ² Invoke é–¢æ•°ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’å‘¼ã³å‡ºã™ = é–¢æ•°ã®å®Ÿè¡Œ Extension ã¨ã®é–¢ä¿‚ GET /extension/event/next Extension API ã‚’ã‚³ãƒ¼ãƒ«ã—ã¦ Invoke ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾— Shutdown ä¸€å®šæœŸé–“ Invoke ã•ã‚Œãªã‹ã£ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒ•ã‚§ãƒ¼ã‚º ç‹¬ç«‹ã—ãŸãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦å‹•ã Extension ã‚’åœæ­¢ã•ã›ãŸä¸Šã§ã€å®Ÿè¡Œç’°å¢ƒã‚’ç ´æ£„ Extension ã¨ã®é–¢ä¿‚ GET /extension/event/next Extension API ã‚’ã‚³ãƒ¼ãƒ«ã—ã¦ Shutdown ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾— å‚è€ƒ: Lambda Extensions API - AWS Lambda Go ã§ Lambda Extension ã‚’ä½œã£ã¦ã¿ã‚‹ ã“ã‚Œã¾ã§ã®å†…å®¹ã‚’è¸ã¾ãˆã¦ã€å®Ÿéš›ã« Extension ã‚’ä½œã£ã¦ã¿ã¾ã™ã€‚\nExtension ã¯é–¢æ•°ã¨ã¯ç‹¬ç«‹ã—ãŸãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€å®Ÿè£…ã™ã‚‹éš›ã«ä½¿ç”¨ã™ã‚‹è¨€èªã¯é–¢æ•°ã¨åˆã‚ã›ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä»Šå›ã¯ä¸‹è¨˜ãƒªãƒã‚¸ãƒˆãƒªã®å®Ÿè£…ä¾‹ã‚’å‚è€ƒã«ã—ã¦ Go ã§å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚\naws-samples/aws-lambda-extensions: A collection of sample extensions to help you get started with AWS Lambda Extensions è‡ªä½œã™ã‚‹ Extension ã®æ¦‚è¦ ä»Šå›å®Ÿè£…ã™ã‚‹ Extension ã§ã‚„ã‚ŠãŸã„ã“ã¨ã¯ã€ä¸‹è¨˜ã®ã¨ãŠã‚Šã§ã™ã€‚\nåŒä¸€å®Ÿè¡Œç’°å¢ƒã§ Invoke ã•ã‚ŒãŸé–¢æ•°ã«å¯¾å¿œã™ã‚‹ Request ID ã‚’ãƒ¡ãƒ¢ãƒªä¸Šã«ä¿æŒã™ã‚‹ é–¢æ•°ã‹ã‚‰ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ Extension ã«å¯¾ã—ã¦ GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ã§ã€ä¿æŒã—ã¦ã„ã‚‹ Request ID ã®ä¸€è¦§ã‚’å–å¾—ã§ãã‚‹ 1 ã¯ã€ Lambda ã® Invoke ãƒ•ã‚§ãƒ¼ã‚ºã«ã¦ Invoke ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œçŸ¥ã—ã¦ã€ãã®ã‚¤ãƒ™ãƒ³ãƒˆå†…ã«å«ã¾ã‚Œã‚‹ Request ID ã‚’ãƒ¡ãƒ¢ãƒªä¸Šã«ä¿æŒã—ã¾ã™ã€‚\n2 ã¯ã€ Extension ã®ã‚µãƒ–ãƒ—ãƒ­ã‚»ã‚¹ (goroutine) ã¨ã—ã¦ HTTP API ã‚µãƒ¼ãƒã‚’èµ·å‹•ã—ã€ ç‰¹å®šã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦ãƒ¡ãƒ¢ãƒªä¸Šã«ä¿æŒã—ã¦ã„ã‚‹ Request ID ã®ãƒªã‚¹ãƒˆã‚’ JSON å½¢å¼ã§è¿”ã—ã¾ã™ã€‚\nã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã«ã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚\nsequenceDiagram participant c as Client participant ls as Lambda Service participant r as Runtime participant f as Function participant e as Extension participant m as On Memory participant s as Extension's HTTP API Server alt Init ls -\u003e\u003e e: init e -\u003e\u003e ls: POST /extension/register e -\u003e\u003e s: start e -\u003e\u003e m: init invocation history e -\u003e\u003e ls: GET /extension/event/next end loop alt Invoke c -\u003e\u003e ls: invoke ls -\u003e\u003e r: invoke ls -\u003e\u003e e: response of GET /extension/event/next (INVOKE event) e -\u003e\u003e m: save Request ID to history e -\u003e\u003e ls: GET /extension/event/next r -\u003e\u003e f: execute main handler f -\u003e\u003e s: GET localhost:1203/invocations s -\u003e\u003e m: read history m -\u003e\u003e s: s -\u003e\u003e f: {\"invocations\": [{\"awsRequestId\":\"id1\", \"invocatedAt\":\"2022-12-04T00:15:06.992783032Z\"}]} f -\u003e\u003e r: r -\u003e\u003e ls: /response (Runtime API) ls -\u003e\u003e c: response end end alt Shutdown ls -\u003e\u003e r: SIGTERM ls -\u003e\u003e e: response of GET /extension/event/next (SHUTDOWN event) end å®Ÿè£… å®Ÿè£…ã—ãŸã‚‚ã®ã¯ä¸‹è¨˜ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã„ã¦ã„ã¾ã™ã€‚\nmichimani/invocation-history-extension: This is a Extension for AWS Lambda Function that records history of invocation at the same runtime environment. ã“ã®è¨˜äº‹å†…ã§ã¯ã€ä¸»ã« Extension API ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã“ã‚ã«ã¤ã„ã¦è§¦ã‚Œã¾ã™ã€‚\nExtension ã®ãƒ¡ã‚¤ãƒ³å‡¦ç† main.go#main ã§ã¯ä¸‹è¨˜ã®å‡¦ç†ã‚’é †ã«å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚\nExtension API ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã® Context ã‚’ç”Ÿæˆ ã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç”¨ã® goroutine ã‚’èµ·å‹• Extension API POST /extension/register ã‚’ã‚³ãƒ¼ãƒ«ã—ã¦å®Ÿè¡Œç’°å¢ƒã« Extension ã‚’ç™»éŒ² Invocation ã®å±¥æ­´ã‚’è¿”ã™ HTTP API ã‚µãƒ¼ãƒã‚’èµ·å‹• Extension API GET /extension/event/next ã‚’ã‚³ãƒ¼ãƒ«ã—ã¦å„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹å‡¦ç†ã‚’é–‹å§‹ 1,2,4 ã¯ç‰¹ã«ç›®æ–°ã—ã„ãƒã‚¤ãƒ³ãƒˆã¯ãªã„ã®ã§ã€ 3 ã¨ 4 ã«ã¤ã„ã¦ å„ Extension API ã®ä»•æ§˜ã¨ã¨ã‚‚ã«å®Ÿè£…ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚\nPOST /extension/register ã§å®Ÿè¡Œç’°å¢ƒã« Extension ã‚’ç™»éŒ² å®Ÿè¡Œç’°å¢ƒã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã¨ Extension ã®é–¢ä¿‚ã®ã¨ã“ã‚ã§æ›¸ã„ãŸã¨ãŠã‚Šã€ Extension ã®ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚ŒãŸã¨ãã« Extension API ã® /extension/register ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã« POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ã§ Extension ã‚’ç™»éŒ²ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\nã“ã® API ã§ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãŠã‚ˆã³ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«å¿…é ˆã®é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚\nã¾ãšã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã® Lambda-Extension-Name ã«ã¯ Extension ã®åå‰ã‚’ã‚»ãƒƒãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚»ãƒƒãƒˆã™ã‚‹å€¤ã¯ã€ Extension ã®å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«åã§ã™ã€‚ä»Šå›ã® Extension ã®å ´åˆã€ invocation-history-extension ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«åã§ /opt/extensions é…ä¸‹ã«å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã®ã§ invocation-history-extension ã‚’å€¤ã¨ã—ã¦ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚\næ¬¡ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã§ã™ãŒã€ã“ã® Extension ã§ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ãŸã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’é…åˆ—ã§æŒ‡å®šã—ã¾ã™ã€‚ ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ã¯ INVOKE ã¨ SHUTDOWN ã®ã¿ã§ã€ä»Šå›ã¯ä¸¡æ–¹ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ãŸã„ã®ã§ä¸¡æ–¹æŒ‡å®šã—ã¾ã™ã€‚\nAPI ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ Lambda-Extension-Identifier ã«ã¯ç™»éŒ²ãŒå®Œäº†ã—ãŸçµæœã¨ã—ã¦ä¸€æ„ãªå€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®å€¤ã¯å¾Œã«ã‚³ãƒ¼ãƒ«ã™ã‚‹ API ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã«ã‚»ãƒƒãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ä¿æŒã—ã¦ãŠãã¾ã™ã€‚\nExtension API ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯å˜ç´”ã« HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚Œã°ã‚ˆã„ã®ã§ã™ãŒã€ä»Šå›ã¯ãã®éƒ¨åˆ†ã‚’ aws-lambda-api-go ã¨ã„ã†ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ è‡ªä½œ ä½¿ç”¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚\nmichimani/aws-lambda-api-go: This is a client library for Go language to use AWS Lambda\u0026amp;rsquo;s Runtime API, Extension API, Telemetry API, and Logs API. import ( \u0026#34;context\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;time\u0026#34; \u0026#34;github.com/michimani/aws-lambda-api-go/alago\u0026#34; \u0026#34;github.com/michimani/aws-lambda-api-go/extension\u0026#34; ) type Client struct { alagoClient *alago.Client logger *Logger extensionIdentifier string } func (c *Client) Register(ctx context.Context, extensionName string) error { out, err := extension.Register(ctx, c.alagoClient, \u0026amp;extension.RegisterInput{ LambdaExtensionName: extensionName, Events: []extension.EventType{ extension.EventTypeInvoke, extension.EventTypeShutdown, }, }) if err != nil { return fmt.Errorf(\u0026#34;An expected error occurred at extension registration. err:%v\u0026#34;, err) } if out.StatusCode != http.StatusOK { return fmt.Errorf(\u0026#34;An error occurred at extension registration. statusCode:%d errType:%s errMessage:%s\u0026#34;, out.StatusCode, out.Error.ErrorType, out.Error.ErrorMessage) } c.logger.Info(\u0026#34;Succeeded to register extension.\u0026#34;) c.extensionIdentifier = out.LambdaExtensionIdentifier return nil } ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã® extension.Register é–¢æ•°ã«å¯¾ã—ã¦ extension.RegisterInput ã« Extension ã®åå‰ã¨ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ãŸã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆã—ã¦æ¸¡ã™ã ã‘ã§ POST /extension/register API ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ç°¡å˜ã§ã™ã­ã€‚\nAPI ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ extension.RegisterOutput ã¨ã—ã¦å–å¾—ã§ãã‚‹ã®ã§ã€ RegisterOutput.LambdaExtensionIdentifier ã®å€¤ã‚’ä¿æŒã—ã¦ãŠãã¾ã™ã€‚\nå‚è€ƒ: Lambda Extensions API | Register - AWS Lambda GET /extension/event/next ã§æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ãƒ»ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° å®Ÿè¡Œç’°å¢ƒã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã¨ Extension ã®é–¢ä¿‚ã®ã¨ã“ã‚ã§æ›¸ã„ãŸã¨ãŠã‚Šã€ Lambda ã®å®Ÿè¡Œç’°å¢ƒã¯é–¢æ•°ã® invoke ãŠã‚ˆã³å®Ÿè¡Œç’°å¢ƒã®ç ´æ£„æ™‚ã«ãã‚Œãã‚Œ INVOKE ã¨ SHUTDOWN ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã—ã¾ã™ã€‚ç™ºè¡Œã—ã¾ã™ã€ã¨æ›¸ãã¾ã—ãŸãŒã€å®Ÿéš›ã«ã¯ GET /extension/event/next API ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã€å®Ÿè¡Œç’°å¢ƒã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºè¡Œã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ã¨ã„ã†å‹•ãã«ãªã‚Šã¾ã™ã€‚ãªã®ã§ã€ã“ã® API ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã® http.Client ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯é•·ã‚ (ã‚‚ã—ãã¯ 0) ã«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\nã“ã® API ã¯ã€ Register API ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ Lambda-Extension-Identifier ã«å«ã¾ã‚Œã¦ã„ãŸå€¤ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ Lambda-Extension-Identifier ã«ã‚»ãƒƒãƒˆã—ã¦ã‚³ãƒ¼ãƒ«ã—ã¾ã™ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã¯ä¸è¦ã§ã™ã€‚\nã“ã¡ã‚‰ã‚‚ Register ã¨åŒã˜ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨åˆã‚ã›ã¦ä¸‹è¨˜ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚\nfunc (c *Client) PollingEvent(ctx context.Context) (bool, error) { c.logger.Info(\u0026#34;Waiting for next event...\u0026#34;) out, err := extension.EventNext(ctx, c.alagoClient, \u0026amp;extension.EventNextInput{ LambdaExtensionIdentifier: c.extensionIdentifier, }) if err != nil { return false, err } if out.StatusCode != http.StatusOK { return false, fmt.Errorf(\u0026#34;An error occurred at calling /extension/event/next API. statusCode:%d errType:%s errMessage:%s\u0026#34;, out.StatusCode, out.Error.ErrorType, out.Error.ErrorMessage) } switch out.EventType { case eventTypeInvoke: now := time.Now().UTC() saveInvocationHistory(out.RequestID, \u0026amp;now) c.logger.Info(\u0026#34;Succeeded to save new history. awsRequestId:%s invokedAt:%v\u0026#34;, out.RequestID, now) case eventTypeShutdown: c.logger.Info(\u0026#34;Received shutdown event. reason:%s\u0026#34;, out.ShutdownReason) c.logger.Info(\u0026#34;Truncate invocation history.\u0026#34;) for _, h := range History.Invocations { c.logger.Info(\u0026#34;%+v\u0026#34;, *h) } return false, nil default: return false, fmt.Errorf(\u0026#34;Cannot handle event. eventType:%s\u0026#34;, out.EventType) } return true, nil } ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ãŒ INVOKE ã®ã¨ãã¯ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œã‚‹ Request ID ã‚’ãƒ¡ãƒ¢ãƒªä¸Šã«ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚ ä¸€æ–¹ã€ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ãŒ SHUTDOWN ã®ã¨ãã¯ã€ãã‚Œã¾ã§ã«ä¿å­˜ã—ã¦ã„ãŸ Request ID ã‚’ã™ã¹ã¦ãƒ­ã‚°ã«å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚\nãƒ¡ã‚½ãƒƒãƒ‰åã«ã‚‚ã‚ã‚‹ã‚ˆã†ã«ã€å®Ÿè³ªã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã¦ã„ã‚‹ã‚ˆã†ãªå‡¦ç†ã«ãªã‚‹ã®ã§ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿”ã‚Šå€¤ã¨ã—ã¦ã¯ bool ã¨ error ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¦ã„ã¦ã€ bool ãŒ true ã§ã‚ã‚Œã°å‘¼ã³å‡ºã—å…ƒ (ä»Šå›ã§ã‚ã‚Œã° main.go#processEvents) ã§å†åº¦ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’å§‹ã‚ã‚‹ã‚ˆã†ãªå½¢ã«ã—ã¦ã„ã¾ã™ã€‚\nå‚è€ƒ: Lambda Extensions API | Next - AWS Lambda è‡ªä½œã—ãŸ Extension ã‚’ Lambda é–¢æ•°ã§ä½¿ã† ã§ã¯ã€è‡ªä½œã—ãŸ Extension ã‚’å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã¾ã™ã€‚\nExtension ã®åˆ©ç”¨æ–¹æ³•ã¨ã—ã¦ã¯ä¸‹è¨˜ã® 3 é€šã‚ŠãŒã‚ã‚Šã¾ã™ã€‚\nLambda Layer ã¨ã—ã¦ publish ã—ã¦ä½¿ã† Lambda é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã¨ä¸€ç·’ã« zip ã«åŒæ¢±ã—ã¦ä½¿ã† ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«åŒæ¢±ã—ã¦ä½¿ã† ä»Šå›ã¯ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«åŒæ¢±ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§è‡ªä½œ Extension ã‚’ä½¿ã£ã¦ã¿ã¾ã™ã€‚ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã™ã‚‹ã“ã¨ã§ RIE ã‚’ä½¿ã£ã¦ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã‚‚å®Ÿéš›ã® Lambda ã®å®Ÿè¡Œç’°å¢ƒã«è¿‘ã„å½¢ã§å‹•ä½œç¢ºèªãŒã§ãã¾ã™ã€‚4\nExtension ã®å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ ã¾ãšã¯ Extension ã‚’å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ç”¨æ„ã—ã¾ã™ã€‚\nä»Šå›ã¯ Go ã§å®Ÿè£…ã—ãŸã®ã§ã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ãƒ“ãƒ«ãƒ‰ã—ã¦å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ zip åŒ–ã—ã¾ã™ã€‚\nGOOS=linux GOARCH=amd64 go build -o bin/extensions/invocation-history-extension main.go \\ \u0026amp;\u0026amp; chmod +x bin/extensions/invocation-history-extension \\ \u0026amp;\u0026amp; cd bin \\ \u0026amp;\u0026amp; zip -r extension.zip extensions/ ã‚‚ã—ãã¯ã€ä»Šå›å®Ÿè£…ã—ãŸ Extension ã«ã¤ã„ã¦ã¯ GitHub ã® Releases ã‹ã‚‰ zip ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã®ã§ã€ãã¡ã‚‰ã‹ã‚‰å–å¾—ã—ã¦ãã¾ã™ã€‚\nReleases Â· michimani/invocation-history-extension Lambda é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ ä»Šå›å®Ÿè£…ã—ãŸ Extension ã¯ localhost:1203 ã§ HTTP API ã‚µãƒ¼ãƒã‚’èµ·å‹•ã—ã¦ã„ã‚‹ã®ã§ã€ãã“ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ãã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é–¢æ•°ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã™ã‚‹ã‚ˆã†ãª Lambda é–¢æ•°ã‚’ç”¨æ„ã—ã¾ã™ã€‚\npackage main import ( \u0026#34;bytes\u0026#34; \u0026#34;context\u0026#34; \u0026#34;encoding/json\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;time\u0026#34; runtime \u0026#34;github.com/aws/aws-lambda-go/lambda\u0026#34; \u0026#34;github.com/aws/aws-lambda-go/lambdacontext\u0026#34; ) type Response struct { Message string `json:\u0026#34;message\u0026#34;` Invocations []invocation `json:\u0026#34;invocations\u0026#34;` } func handleRequest(ctx context.Context) (*Response, error) { log.Println(\u0026#34;start handler\u0026#34;) defer log.Println(\u0026#34;end handler\u0026#34;) lc, ok := lambdacontext.FromContext(ctx) if !ok { return nil, fmt.Errorf(\u0026#34;Failed to get Lambda context from context.\u0026#34;) } history, err := getInvocationHistory() if err != nil { return nil, err } return \u0026amp;Response{ Message: fmt.Sprintf(\u0026#34;Current request ID is %s\u0026#34;, lc.AwsRequestID), Invocations: history, }, nil } func init() { log.Println(\u0026#34;cold start\u0026#34;) } func main() { runtime.Start(handleRequest) } // Struct of response from Invocation History Extension - GET /invocations API type resultFromExtension struct { Invocations []invocation `json:\u0026#34;invocations\u0026#34;` } type invocation struct { AWSRequestID string `json:\u0026#34;awsRequestId\u0026#34;` InvocatedAt *time.Time `json:\u0026#34;invocatedAt\u0026#34;` } const invocationsEndpoint = \u0026#34;http://localhost:1203/invocations\u0026#34; // Get invocation history from Invocation History Extension IPC. func getInvocationHistory() ([]invocation, error) { req, err := http.NewRequestWithContext(context.Background(), \u0026#34;GET\u0026#34;, invocationsEndpoint, nil) if err != nil { return nil, err } // call Extension API client := http.Client{} res, err := client.Do(req) if err != nil { return nil, err } defer res.Body.Close() buf := new(bytes.Buffer) if _, err := buf.ReadFrom(res.Body); err != nil { return nil, err } bodyString := buf.String() if res.StatusCode != http.StatusOK { return nil, fmt.Errorf(\u0026#34;Failed to get invocation history by using extension. statusCode:%d body:%s\u0026#34;, res.StatusCode, bodyString) } exRes := resultFromExtension{} if err := json.Unmarshal([]byte(bodyString), \u0026amp;exRes); err != nil { return nil, err } return exRes.Invocations, nil } åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã§èµ·å‹•ã—ã¦ã„ã‚‹ Extension ã® HTTP API ã‚µãƒ¼ãƒã« GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ãã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ç¾åœ¨ã® Request ID ã‚’ä»˜ä¸ã—ãŸã‚‚ã®ã‚’é–¢æ•°ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã™ã‚ˆã†ãªå®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹ã¯ã“ã®ã‚ã¨ç¢ºèªã—ã¾ã™ã€‚\nDockerfile Extension ã‚’ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«åŒæ¢±ã™ã‚‹å ´åˆã¯ Extension ã®å®Ÿè¡Œå¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã® /opt/extensions ä»¥ä¸‹ã«é…ç½®ã™ã‚Œã°ã‚ˆã„ã®ã§ã€ä¸‹è¨˜ã®ã‚ˆã†ãª Dockerfile ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ Extension ã‚’åŒæ¢±ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\nFROM public.ecr.aws/lambda/provided:al2 as build RUN yum install -y golang unzip RUN go env -w GOPROXY=direct ADD go.mod go.sum ./ RUN go mod download ADD . . RUN go build -o /main RUN mkdir -p /opt ## ã“ã“ã¯ GitHub ã‹ã‚‰ç›´æ¥å–å¾—ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã‚‚ã‚ˆã„ # ADD https://github.com/michimani/invocation-history-extension/releases/download/v0.2.0/extension.zip ./ ADD ./bin/extension.zip ./ RUN unzip extension.zip -d /opt RUN rm extension.zip FROM public.ecr.aws/lambda/provided:al2 COPY --from=build /main /main COPY entry.sh / RUN chmod 755 /entry.sh RUN mkdir -p /opt/extensions WORKDIR /opt/extensions COPY --from=build /opt/extensions . ENTRYPOINT [ \u0026#34;/entry.sh\u0026#34; ] CMD [\u0026#34;/main\u0026#34;] AWS ã‚„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‹ã‚‰æä¾›ã•ã‚Œã¦ã„ã‚‹ Extension ã§å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ãã®ã‚‚ã®ãŒå…¬é–‹ã•ã‚Œã¦ã„ãªã„å ´åˆã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ãˆã°ã‚ˆãã¦ã€ Lambda Layer ã¨ã—ã¦å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã«ã¤ã„ã¦ã¯ä¸‹è¨˜ã® AWS CLI ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ zip å½¢å¼ã§ Extension ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ (AWS Parameters And Secrets Lambda Extension ã®å ´åˆ)\ncurl $( aws lambda get-layer-version-by-arn \\ --arn \u0026#39;arn:aws:lambda:ap-northeast-1:133490724326:layer:AWS-Parameters-and-Secrets-Lambda-Extension:2\u0026#39; \\ --query \u0026#39;Content.Location\u0026#39; \\ --output text ) --output extension.zip ãã®å¾Œ unzip ã—ã¦å®Ÿè¡Œå¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«åŒæ¢±ã™ã‚Œã°ã€è‡ªä½œã—ãŸ Extension ã¨åŒæ§˜ã«ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã§ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\nãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ã—ã¦ invoke Dockerfile ã®æº–å‚™ã‚‚ã§ããŸã®ã§ã€ã‚ã¨ã¯ docker build ã—ã¦ docker run ã™ã‚Œã°ãƒ­ãƒ¼ã‚«ãƒ«ã§ Lambda ã®å®Ÿè¡Œç’°å¢ƒãŒèµ·å‹•ã—ã¾ã™ã€‚\ndocker build -t invocation-history-ex-func:local . \\ \u0026amp;\u0026amp; docker run \\ --rm \\ -p 9000:8080 \\ invocation-history-ex-func:local ã“ã‚Œã§ localhost:9000 ã§ Lambda ã®å®Ÿè¡Œç’°å¢ƒãŒèµ·å‹•ã—ã¦ã„ã‚‹ã®ã§ã€ãã“ã«å¯¾ã—ã¦ curl ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ invoke ã—ã¾ã™ã€‚\ncurl \\ -H \u0026#39;Content-Type: application/json\u0026#39; \\ http://localhost:9000/2015-03-31/functions/function/invocations ã™ã‚‹ã¨ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚\n{ \u0026#34;message\u0026#34;: \u0026#34;Current request ID is e65d6f55-2335-47e9-88f9-a851e7d539d5\u0026#34;, \u0026#34;invocations\u0026#34;: [ { \u0026#34;awsRequestId\u0026#34;: \u0026#34;e65d6f55-2335-47e9-88f9-a851e7d539d5\u0026#34;, \u0026#34;invocatedAt\u0026#34;: \u0026#34;2022-12-06T13:25:52.447847893Z\u0026#34; } ] } ç¶šã‘ã¦ invoke ã™ã‚‹ã¨\n{ \u0026#34;message\u0026#34;: \u0026#34;Current request ID is 4a61a5dc-7bbf-43cb-abd0-67ed0388cf5f\u0026#34;, \u0026#34;invocations\u0026#34;: [ { \u0026#34;awsRequestId\u0026#34;: \u0026#34;e65d6f55-2335-47e9-88f9-a851e7d539d5\u0026#34;, \u0026#34;invocatedAt\u0026#34;: \u0026#34;2022-12-06T13:25:52.447847893Z\u0026#34; }, { \u0026#34;awsRequestId\u0026#34;: \u0026#34;4a61a5dc-7bbf-43cb-abd0-67ed0388cf5f\u0026#34;, \u0026#34;invocatedAt\u0026#34;: \u0026#34;2022-12-06T13:27:17.244096344Z\u0026#34; } ] } ãã‚Œã¾ã§ã«åŒã˜å®Ÿè¡Œç’°å¢ƒã§ invoke ã•ã‚ŒãŸéš›ã® Request ID ãŒå±¥æ­´ã¨ãªã£ã¦ä¿æŒã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚\nLambda ã®å®Ÿè¡Œç’°å¢ƒãŒå‡ºåŠ›ã—ã¦ã„ã‚‹ãƒ­ã‚°ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚\n1START RequestId: e65d6f55-2335-47e9-88f9-a851e7d539d5 Version: $LATEST 206 Dec 2022 13:25:52,433 [INFO] (rapid) External agent invocation-history-extension (c96c9db2-076e-4ac7-9572-f98d4091d0e8) registered, subscribed to [INVOKE SHUTDOWN] 3[Invocation History Extension] INFO: Succeeded to register extension. 4[Invocation History Extension] INFO: Waiting for next event... 52022/12/06 13:25:52 cold start 62022/12/06 13:25:52 start handler 7[Invocation History Extension] INFO: Succeeded to save new history. awsRequestId:e65d6f55-2335-47e9-88f9-a851e7d539d5 invokedAt:2022-12-06 13:25:52.447847893 +0000 UTC 8[Invocation History Extension] INFO: Waiting for next event... 92022/12/06 13:25:52 end handler 10END RequestId: e65d6f55-2335-47e9-88f9-a851e7d539d5 11REPORT RequestId: e65d6f55-2335-47e9-88f9-a851e7d539d5 Init Duration: 0.22 ms Duration: 28.23 ms Billed Duration: 29 ms Memory Size: 3008 MB Max Memory Used: 3008 MB 12START RequestId: 4a61a5dc-7bbf-43cb-abd0-67ed0388cf5f Version: $LATEST 132022/12/06 13:27:17 start handler 14[Invocation History Extension] INFO: Succeeded to save new history. awsRequestId:4a61a5dc-7bbf-43cb-abd0-67ed0388cf5f invokedAt:2022-12-06 13:27:17.244096344 +0000 UTC 15[Invocation History Extension] INFO: Waiting for next event... 162022/12/06 13:27:17 end handler 17END RequestId: 4a61a5dc-7bbf-43cb-abd0-67ed0388cf5f 18REPORT RequestId: 4a61a5dc-7bbf-43cb-abd0-67ed0388cf5f Duration: 1.53 ms Billed Duration: 2 ms Memory Size: 3008 MB Max Memory Used: 3008 MB 1 ã€œ 11 è¡Œç›®ãŒ 1 å›ç›®ã® invoke ã«ã‚ˆã‚‹ãƒ­ã‚°ã§ã€ã“ã®ã¨ãã®ã¿ Register API ã‚’å®Ÿè¡Œã—ãŸãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚\nã“ã®çŠ¶æ…‹ã‹ã‚‰ ctr + C ã§å®Ÿè¡Œç’°å¢ƒã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†ã•ã›ã‚‹ã¨ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚\n^C06 Dec 2022 13:31:54,898 [INFO] (rapid) Received signal signal=interrupt 06 Dec 2022 13:31:54,898 [INFO] (rapid) Shutting down... 06 Dec 2022 13:31:54,898 [WARNING] (rapid) Reset initiated: SandboxTerminated [Invocation History Extension] INFO: Received shutdown event. reason:SandboxTerminated [Invocation History Extension] INFO: Truncate invocation history. [Invocation History Extension] INFO: {AWSRequestID:e65d6f55-2335-47e9-88f9-a851e7d539d5 InvocatedAt:2022-12-06 13:25:52.447847893 +0000 UTC} [Invocation History Extension] INFO: {AWSRequestID:4a61a5dc-7bbf-43cb-abd0-67ed0388cf5f InvocatedAt:2022-12-06 13:27:17.244096344 +0000 UTC} 06 Dec 2022 13:31:54,899 [INFO] (rapid) runtime exited ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº† = å®Ÿè¡Œç’°å¢ƒã®ç ´æ£„ã¨ãªã‚Šã¾ã™ã€‚å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ãƒ­ã‚°ã‹ã‚‰ã‚‚ã€ SHUTDOWN ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã£ã¦ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚\nã¾ã¨ã‚ AWS Lambda ã® Extension API ã‚’ä½¿ã£ã¦ã¿ãŸã„ãŒãŸã‚ã« Lambda Extension ã‚’è‡ªä½œã—ã¦ã¿ãŸè©±ã§ã—ãŸã€‚\nLambda Extension ã‚’è‡ªä½œã—ã¦ã¿ã¦ Extension API ãŒã‚„ã£ã¦ã„ã‚‹ã“ã¨ã€ Lambda ã®å®Ÿè¡Œç’°å¢ƒä¸Šã§ã® Extension ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã€ Lambda ãã®ã‚‚ã®ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã«ã¤ã„ã¦å®Œå…¨ã«ç†è§£ã§ããŸæ°—ãŒã—ã¾ã™ã€‚\nã¨è¨€ã£ã¦ã‚‚ Extension API ã«ã¯ã¾ã  Init Error API ã¨ Exit Error API ãŒã‚ã‚Šã€ä»Šå›ã¯ãã‚Œã‚‰ã‚’ä½¿ã£ã¦ã„ã¾ã›ã‚“ã€‚ã¾ãŸã€ Lambda ã«ã¯ Extension API ã®ä»–ã«ã‚‚ Runtime APIã€ Telemetry API (Logs API) ã‚‚ã‚ã‚Šã€ã¾ã ã¾ã ä½•ã‚‚ã‚ã‹ã‚‰ãªã„éƒ¨åˆ†ãŒãŸãã•ã‚“ã‚ã‚Šãã†ã§ã™ã€‚\nå€‹äººçš„ã«ä¸€æ™‚æœŸ Lambda ç†±ãŒå†·ã‚ã¦ã„ãŸã‚“ã§ã™ãŒã€æœ€è¿‘ã¾ãŸæ¸©ã¾ã£ã¦ããŸã®ã§ä»Šå¾Œã¯ã“ã®ã‚ãŸã‚Šã® API ç¾¤ã‚’è¿½ã£ã¦ã„ã“ã†ã‹ãªã¨æ€ã„ã¾ã™ã€‚\nAWS Lambda æ‹¡å¼µæ©Ÿèƒ½ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ - AWS Lambda \u0026#160;\u0026#x21a9;\u0026#xfe0e;\nAWS Parameters and Secrets Lambda Extension ã‚’ç™ºè¡¨ \u0026#160;\u0026#x21a9;\u0026#xfe0e;\nSSM Parameter Store ãŠã‚ˆã³ Secrets Manager ã¸ã®å•ã„åˆã‚ã›ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã§å†å–å¾—æ™‚ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ãŠã‚ˆã³ã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›ã§ãã‚‹ã¨ã„ã†æ©Ÿèƒ½\u0026#160;\u0026#x21a9;\u0026#xfe0e;\nã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ãŸ Lambda é–¢æ•°ã®ã‚ã‚Œã“ã‚Œ - michimani.net \u0026#160;\u0026#x21a9;\u0026#xfe0e;\n",
    "permalink": "https://michimani.net/post/aws-lambda-extension-written-in-go/",
    "title": "AWS Lambda ã® Extension API ã‚’ä½¿ã„ãŸã„ãŒãŸã‚ã« Go ã§ Lambda Extension ã‚’è‡ªä½œã—ã¦ã¿ãŸ"
  },
  {
    "contents": "Lambda é–¢æ•°ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã¨ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã‹ã‚‰ã‚‚ã† 2 å¹´ãŒçµŒã¨ã†ã¨ã—ã¦ã„ã¾ã™ã€‚æœ€è¿‘ã«ãªã£ã¦ã¡ã‚ƒã‚“ã¨è§¦ã‚‹ã‚ˆã†ã«ãªã£ã¦è‰²ã€…ã‚ã‹ã£ã¦ããŸã“ã¨ãŒã‚ã‚‹ã®ã§ã€ã‚„ã£ãŸã“ã¨ã‚’ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚\nã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ãŸ Lambda é–¢æ•°ã®æ¦‚è¦ Dockerfile AWS ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã† ä»£æ›¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã† ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®å®Ÿè¡Œ RIE ã«ã‚ˆã‚‹ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å®Ÿè¡Œ ã‚¤ãƒ™ãƒ³ãƒˆã®å†ç¾ ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã¨ã‚¦ã‚©ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ Lambda Runtime API ã®åˆ©ç”¨ Lambda Layer (Extension) ã®åˆ©ç”¨ CI/CD åŸºæœ¬çš„ãªæ›´æ–°æ–¹æ³• CI/CD ã‚’æ§‹ç¯‰ã™ã‚‹éš›ã®æ³¨æ„ç‚¹ GitHub Actions ã«ã‚ˆã‚‹ CI/CD Lambda Layer (Extension) ã®ä½¿ã„æ–¹ æ¦‚è¦ Parameter and Secret Lambda Extension ã‚’ä½¿ã£ãŸã‚µãƒ³ãƒ—ãƒ« Extension ã®ãƒã‚¤ãƒŠãƒªå–å¾— ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä½œæˆ å®Ÿè£… Extension ã‚’ä½¿ã£ãŸå ´åˆã®ãƒ­ã‚° ã¾ã¨ã‚ ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ãŸ Lambda é–¢æ•°ã®æ¦‚è¦ ã¾ãšã¯æ¦‚è¦ã§ã™ã€‚\nã¨è¨€ã£ã¦ã‚‚é›£ã—ã„ã“ã¨ã¯ãªãã€\nãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã¨ã—ã¦ Image ã‚’ã€ ImageURI ã¨ã—ã¦ ECR Repository ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ URI ã‚’æŒ‡å®šã—ã¾ã™ ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†å ´åˆã¯ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯æŒ‡å®šã—ã¾ã›ã‚“ æŒ‡å®šã§ãã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®æœ€å¤§ã‚µã‚¤ã‚ºã¯ 10 GB ã¨ãªã£ã¦ã„ã¾ã™ ãã‚‰ã„ã§ã™ã€‚\nãã®ä»–ã® Lambda é–¢æ•°ã®æ©Ÿèƒ½ (ç’°å¢ƒå¤‰æ•°ã€ Layer (Extension) ãªã©) ã«ã¤ã„ã¦ã¯ã€å¾“æ¥ã® Lambda é–¢æ•°ã¨åŒç­‰ã§ã™ã€‚\nDockerfile Lambda é–¢æ•°ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹éš›ã€ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ AWS ãŒæä¾›ã—ã¦ã„ã‚‹ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†æ–¹æ³•ã¨ã€ alpine ãªã©ã®ä»£æ›¿ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œãã‚Œãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚‹ã®ã§ç°¡å˜ã«ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚\nã¾ãŸã€ä»Šå›ã¯å‰æã¨ã—ã¦ Go ã§å®Ÿè£…ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ã‚‚ã¨ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚ãªã®ã§ã€ä¸‹è¨˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¨ main.go ãŒå­˜åœ¨ã—ã¦ã„ã‚‹ã“ã¨ã¨ã—ã¾ã™ã€‚\n. â”œâ”€â”€ Dockerfile â”œâ”€â”€ entry.sh â”œâ”€â”€ go.mod â”œâ”€â”€ go.sum â””â”€â”€ main.go package main import ( \u0026#34;log\u0026#34; runtime \u0026#34;github.com/aws/aws-lambda-go/lambda\u0026#34; ) type Response struct { Message string `json:\u0026#34;message\u0026#34;` } func handleRequest() (Response, error) { log.Println(\u0026#34;start handler\u0026#34;) defer log.Println(\u0026#34;end handler\u0026#34;) return Response{ Message: \u0026#34;Hello AWS Lambda\u0026#34;, }, nil } func init() { log.Println(\u0026#34;cold start\u0026#34;) } func main() { runtime.Start(handleRequest) } AWS ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã† AWS ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†å ´åˆã¯ä¸‹è¨˜ã®ã‚ˆã†ãª Dockerfile ã«ãªã‚Šã¾ã™ã€‚\nFROM public.ecr.aws/lambda/provided:al2 as build RUN yum install -y golang RUN go env -w GOPROXY=direct ADD go.mod go.sum ./ RUN go mod download ADD . . RUN go build -o /main FROM public.ecr.aws/lambda/provided:al2 COPY --from=build /main /main ENTRYPOINT [\u0026#34;/main\u0026#34;] AWS ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ ECR Public ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ docker build ã™ã‚‹ã«ã¯ ECR ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\nAWS ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã¯ã€ Lambda Layer (Extension) ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®æ©Ÿæ§‹ã‚„ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã™ã‚‹ãŸã‚ã® RIE (Runtime Interface Emulator) ã‚‚å«ã¾ã‚Œã¦ãŠã‚Šã€ãƒ“ãƒ«ãƒ‰å¾Œã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã¯å¤§ãããªã‚Šã¾ã™ã€‚\nå¾Œè¿°ã—ã¾ã™ãŒã€ RIE ã ã‘ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã«å«ã‚ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã®ã§ã€ AWS ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã¯ Lambda Layer (Extension) ã‚’ä½¿ã„ãŸã„å ´é¢ã¨ãªã‚Šãã†ã§ã™ã€‚\nä»£æ›¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã† ä»£æ›¿ã®ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ (ä»Šå›ã¯ alpine) ã‚’ä½¿ã†å ´åˆã¯ä¸‹è¨˜ã®ã‚ˆã†ãª Dockerfile ã«ãªã‚Šã¾ã™ã€‚\nFROM alpine as build RUN apk add go git RUN go env -w GOPROXY=direct ADD go.mod go.sum ./ RUN go mod download ADD . . RUN go build -o /main FROM alpine COPY --from=build /main /main ENTRYPOINT [ \u0026#34;/main\u0026#34; ] ãƒ™ãƒ¼ã‚¹ã«ä½¿ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚µã‚¤ã‚ºã«ã‚‚ã‚ˆã‚Šã¾ã™ãŒã€å¿…è¦æœ€ä½é™ã®æ§‹æˆã¨ãªã‚‹ãŸã‚ AWS ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†å ´åˆã¨æ¯”è¼ƒã—ã¦ãƒ“ãƒ«ãƒ‰å¾Œã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã¯å°ã•ããªã‚Šã¾ã™ã€‚\nã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºãŒå°ã•ããªã‚‹åˆ†ã€ Lambda Layer (Extension) ã¯ä½¿ç”¨ã§ããšã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å®Ÿè¡Œã‚‚ã§ãã¾ã›ã‚“ã€‚\nLambda Layer (Extension) ã‚’ä½¿ç”¨ã—ãªã„å ´åˆã€AWS ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä»£ã‚ã‚Šã«ä»£æ›¿ã¨ãªã‚‹ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†ã“ã¨ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’å°ã•ãã§ãã¾ã™ã€‚\nã¨ã¯ã„ãˆãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å®Ÿè¡Œã¯ã§ããŸã»ã†ãŒå¬‰ã—ã„ã®ã§ã€ãã®å ´åˆã¯ä¸‹è¨˜ã®ã‚ˆã†ã« RIE ã ã‘ã‚’è¿½åŠ ã™ã‚‹ã‚ˆã†ãª Dockerfile ã‚’ç”¨æ„ã—ã¾ã™ã€‚\nFROM alpine as build RUN apk add go git RUN go env -w GOPROXY=direct ADD go.mod go.sum ./ RUN go mod download ADD . . RUN go build -o /main FROM alpine COPY --from=build /main /main ADD https://github.com/aws/aws-lambda-runtime-interface-emulator/releases/latest/download/aws-lambda-rie /usr/bin/aws-lambda-rie RUN chmod 755 /usr/bin/aws-lambda-rie COPY entry.sh / RUN chmod 755 /entry.sh ENTRYPOINT [ \u0026#34;/entry.sh\u0026#34; ] CMD [ \u0026#34;/main\u0026#34; ] ã“ã“ã§å‡ºã¦ãã‚‹ entry.sh ã¯ä¸‹è¨˜ã®å†…å®¹ã¨ã—ã¾ã™ã€‚\n#!/bin/sh if [ -z \u0026#34;${AWS_LAMBDA_RUNTIME_API}\u0026#34; ]; then exec /usr/bin/aws-lambda-rie \u0026#34;$@\u0026#34; else exec \u0026#34;$@\u0026#34; fi ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®å®Ÿè¡Œ ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ãŸ Lambda é–¢æ•°ã¯ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®å®Ÿè¡Œã‚‚å®¹æ˜“ã§ã™ã€‚\nRIE ã«ã‚ˆã‚‹ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å®Ÿè¡Œ ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®å®Ÿè¡Œã«ã¯ RIE (Runtime Interface Emulator) ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚\nå‰é …ã§æ›¸ã„ãŸã‚ˆã†ã« AWS ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€ä»£æ›¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã« RIE ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ Lambda é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\nã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã« RIE ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ä¸‹è¨˜ã®æ‰‹é †ã§ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®èµ·å‹•ãƒ»å®Ÿè¡ŒãŒå¯èƒ½ã§ã™ã€‚\ndocker build\ndocker build -t container-lambda-function:local . docker run\ndocker run \\ --rm \\ -p 9000:8080 \\ container-lambda-function:local (ãƒãƒ¼ãƒˆã¯ä»»æ„)\nã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹ã¨ã€ Lambda é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã®ã§ã¯ãªãã€å®Ÿè¡Œå¯èƒ½ãªçŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚\næ¨™æº–å‡ºåŠ›ã«ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚\n03 Nov 2022 13:39:12,623 [INFO] (rapid) exec \u0026#39;/main\u0026#39; (cwd=/var/task, handler=) invoke\nå®Ÿéš›ã« Lambda é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€\nhttp://localhost:9000/2015-03-31/functions/function/invocations ã«å¯¾ã—ã¦ GET ã‚‚ã—ãã¯ POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã™ã€‚\ncurl \u0026#39;http://localhost:9000/2015-03-31/functions/function/invocations\u0026#39; curl ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªå‡ºåŠ›ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚\n{\u0026#34;message\u0026#34;:\u0026#34;Hello AWS Lambda\u0026#34;} ã¾ãŸã€èµ·å‹•ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®æ¨™æº–å‡ºåŠ›ã§ã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ãªå‡ºåŠ›ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚\nSTART RequestId: b8a7e4ed-381d-4925-8a7a-48a90a4dd2e4 Version: $LATEST 2022/11/03 13:44:08 cold start 2022/11/03 13:44:08 start handler 2022/11/03 13:44:08 end handler END RequestId: b8a7e4ed-381d-4925-8a7a-48a90a4dd2e4 REPORT RequestId: b8a7e4ed-381d-4925-8a7a-48a90a4dd2e4 Init Duration: 0.34 msDuration: 10.43 ms Billed Duration: 11 ms Memory Size: 3008 MB Max Memory Used: 3008 MB ã“ã‚Œã¯å®Ÿéš›ã® Lambda é–¢æ•°ãŒå‡ºåŠ›ã™ã‚‹ãƒ­ã‚°ã¨åŒç­‰ã®å†…å®¹ã«ãªã£ã¦ã„ã¾ã™ã€‚\nä¸€æ–¹ã§ã€ RIE ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã«å«ã‚ãšã«ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚1 ãŸã ã€é–‹ç™ºè€…ã®ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã« RIE ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚‚ã‚‰ã†ã®ã¯é¢å€’ãªã®ã§ã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã«å«ã‚ã¦ã—ã¾ã†ã®ãŒè‰¯ã„ã‹ãªã¨æ€ã„ã¾ã™ã€‚\nãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã« RIE ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã‚Œã‚’ä½¿ã†å ´åˆã€ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã®ã‚³ãƒãƒ³ãƒ‰ãŒä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\ndocker run -d -v ~/.aws-lambda-rie/aws-lambda \\ --entrypoint /aws-lambda/aws-lambda-rie \\ -p 9000:8080 \\ container-lambda-function:local ã‚¤ãƒ™ãƒ³ãƒˆã®å†ç¾ Lambda é–¢æ•°ã®å®Ÿè¡Œæ™‚ã«ã¯ API Gateway ã‹ã‚‰ã® Payloadã€ S3 ã‚„ SQS ç­‰ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚\nãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ãã‚Œã‚‰ã®å—ã‘å–ã‚Šã‚’å†ç¾ã™ã‚‹ã«ã¯ã€ curl ã§ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ POST ã«ã€ã‚¤ãƒ™ãƒ³ãƒˆã® JSON ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«å…¥ã‚Œã‚‹ã“ã¨ã§å†ç¾ã§ãã¾ã™ã€‚\nä¾‹ãˆã°ã€ SQS é§†å‹•ã® Lambda é–¢æ•°ã‚’å†ç¾ã—ãŸã„å ´åˆã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã™ã€‚\ncurl -X POST \\ -H \u0026#39;Content-Type: application/json\u0026#39; \\ -d \u0026#39;{\u0026#34;Records\u0026#34;: [{\u0026#34;messageId\u0026#34;: \u0026#34;message-id\u0026#34;, \u0026#34;eventSource\u0026#34;: \u0026#34;event-source\u0026#34;, \u0026#34;body\u0026#34;: \u0026#34;{\\\u0026#34;key\\\u0026#34;: \\\u0026#34;value\\\u0026#34;}\u0026#34;}]}\u0026#39; \\ \u0026#39;http://localhost:9000/2015-03-31/functions/function/invocations\u0026#39; SQS é§†å‹•ã® Lambda é–¢æ•°ã®å®Ÿè£…ä¾‹ã¯ã“ã¡ã‚‰ã€‚\nsqs-lambda-example/lambda at main Â· michimani/sqs-lambda-example ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã¨ã‚¦ã‚©ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ Lambda é–¢æ•°ã®ç‰¹å¾´ã¨ã—ã¦ã€ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã¨ã‚¦ã‚©ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚\nã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ãŸ Lambda é–¢æ•°ã®ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã§ã¯ã“ã‚Œã‚‰ã®å†ç¾ã‚‚å¯èƒ½ã§ã™ã€‚\nå…·ä½“çš„ãªå‹•ä½œã¨ã—ã¦ã¯ã€ docker run ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¦ã‹ã‚‰æœ€åˆã« curl ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ã£ãŸéš›ã®å®Ÿè¡Œã¯ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã¨ãªã‚Šã€ãã‚Œä»¥é™ã¯ã‚¦ã‚©ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆã®æŒ™å‹•ã¨ãªã‚Šã¾ã™ã€‚èµ·å‹•ä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã—ã¦èµ·å‹•ã—ãªãŠã›ã°ã€ã¾ãŸã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã®æŒ™å‹•ã‚’ç¢ºèªã§ãã¾ã™ã€‚\nä¾‹ã§ã‚ã’ã¦ã„ã‚‹ Go ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã®ã¿ init() é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã€ãã‚Œä»¥é™ã¯å®Ÿè¡Œã•ã‚Œãªã„ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚\nã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã®ãƒ­ã‚°ã€‚\nSTART RequestId: b8a7e4ed-381d-4925-8a7a-48a90a4dd2e4 Version: $LATEST 2022/11/03 13:44:08 cold start 2022/11/03 13:44:08 start handler 2022/11/03 13:44:08 end handler END RequestId: b8a7e4ed-381d-4925-8a7a-48a90a4dd2e4 REPORT RequestId: b8a7e4ed-381d-4925-8a7a-48a90a4dd2e4 Init Duration: 0.34 msDuration: 10.43 ms Billed Duration: 11 ms Memory Size: 3008 MB Max Memory Used: 3008 MB ã‚¦ã‚©ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã®ãƒ­ã‚°ã€‚\nSTART RequestId: d5016f63-3648-423c-bb7a-597548b83da1 Version: $LATEST 2022/11/03 14:00:20 start handler 2022/11/03 14:00:20 end handler END RequestId: d5016f63-3648-423c-bb7a-597548b83da1 REPORT RequestId: d5016f63-3648-423c-bb7a-597548b83da1 Duration: 1.41 ms Billed Duration: 2 ms Memory Size: 3008 MB Max Memory Used: 3008 MB ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«ã¯ init() é–¢æ•°å†…ã§å‡ºåŠ›ã—ã¦ã„ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã€ã•ã‚‰ã« Init Duration ã®æƒ…å ±ã‚‚å‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã‚¦ã‚©ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«ã¯ãã‚Œã‚‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nLambda é–¢æ•°ã®ã“ã®æŒ™å‹•ã«ã‚ˆã£ã¦ DB ã¸ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒå¢—ãˆç¶šã‘ã‚‹ç½ ãŒã‚ã‚Šã¾ã™ãŒã€ãã‚Œã«ã¤ã„ã¦ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å†ç¾ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\nmichimani/lambda-rdb-test: In this repository, you can try to see how the number of DB connections changes depending on the implementation method when connecting to RDB from Lambda functions implemented in Go. Lambda Runtime API ã®åˆ©ç”¨ Lambda ã«ã¯ Lambda Runtime API 2 ã¨ã„ã†ã‚‚ã®ãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€å®Ÿè¡Œä¸­ã® Lambda é–¢æ•°ã«é–¢ã™ã‚‹æƒ…å ±ã‚’å–å¾—ã—ãŸã‚Šã€å‹•ä½œã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ RIE ã‚’ä½¿ã£ãŸãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã§ã¯ã€Lambda Runtime API ã®æŒ™å‹•ã«ã¤ã„ã¦ã‚‚ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\nLambda Runtime API ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã€Lambda é–¢æ•°å®Ÿè¡Œæ™‚ã«è‡ªå‹•çš„ã«è¨­å®šã•ã‚Œã‚‹ AWS_LAMBDA_RUNTIME_API ã¨ã„ã†ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã•ã‚Œã¦ãŠã‚Šã€ RIE ã‚’ä½¿ã£ãŸãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œæ™‚ã«ã‚‚ã“ã®ç’°å¢ƒå¤‰æ•°ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚\nGo ã§ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªå®Ÿè£…ã«ã‚ˆã£ã¦ã€å®Ÿè¡Œä¸­ã® Lambda é–¢æ•°ã® Request ID ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\nconst ( runtimeAPIEnvKey = \u0026#34;AWS_LAMBDA_RUNTIME_API\u0026#34; runtimeRequestIDHeaderName = \u0026#34;Lambda-Runtime-Aws-Request-Id\u0026#34; ) func getRequestID(client *http.Client) (string, error) { host := os.Getenv(runtimeAPIEnvKey) if host == \u0026#34;\u0026#34; { return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;host is empty\u0026#34;) } url := fmt.Sprintf(\u0026#34;http://%s/2018-06-01/runtime/invocation/next\u0026#34;, host) req, err := http.NewRequestWithContext(context.Background(), \u0026#34;GET\u0026#34;, url, nil) if err != nil { return \u0026#34;\u0026#34;, err } res, err := client.Do(req) if err != nil { return \u0026#34;\u0026#34;, err } rHeader := res.Header rIds, exists := rHeader[runtimeRequestIDHeaderName] if !exists { return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;\u0026#39;%s\u0026#39; header does not exists.\u0026#34;, runtimeRequestIDHeaderName) } if len(rIds) == 0 { return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;Value of \u0026#39;%s\u0026#39; header is empty.\u0026#34;, runtimeRequestIDHeaderName) } return rIds[0], nil } é–¢æ•°å…¨ä½“ã®å®Ÿè£…ã¯ã“ã¡ã‚‰ã€‚\nbase-of-lambda-container-image/main.go at main Â· michimani/base-of-lambda-container-image Lambda Layer (Extension) ã®åˆ©ç”¨ Lambda ã«ã¯ Lambda Layer (Extension) ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã§ã¯ã“ã®æ©Ÿèƒ½ã®æŒ™å‹•ã‚‚ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«é–¢ã—ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚\nCI/CD ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ãŸ Lambda é–¢æ•°ã® CI/CD ã«ã¤ã„ã¦è€ƒãˆã¦ã¿ã¾ã™ã€‚\nå¾“æ¥ã® Lambda é–¢æ•°ã§ã‚ã‚Œã°ã€è©²å½“ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰ä¸€å¼ã‚’ zip åŒ–ã—ã¦ S3 Bucket ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ lambda update-function-code ã«ã¦ã‚½ãƒ¼ã‚¹ã¨ãªã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ã—ã¦ã„\nåŸºæœ¬çš„ãªæ›´æ–°æ–¹æ³• å¾“æ¥ã® Lambda é–¢æ•°ã§ã‚ã‚Œã°ã€è©²å½“ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰ä¸€å¼ã‚’ zip åŒ–ã—ã¦æ›´æ–°ã€ã‚‚ã—ãã¯ zip ã‚’ S3 Bucket ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦æ›´æ–°ã—ã¦ã„ã¾ã—ãŸãŒã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ãŸ Lambda ã®å ´åˆã¯ãƒ•ãƒ­ãƒ¼ãŒç•°ãªã‚Šã¾ã™ã€‚\nã¾ãšã€å¤‰æ›´å¾Œã®ã‚³ãƒ¼ãƒ‰ã§ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã€ ECR Repository ã« push ã—ã¾ã™ã€‚ ãã—ã¦ã€ lambda update-function-code ã§ ImageURI ã‚’æ›´æ–°ã—ã¾ã™ã€‚\nã“ã®ã¨ãã® URI ã¯ãƒãƒƒã‚·ãƒ¥ä»˜ã URI ã§ã‚‚ã‚ˆã„ã§ã™ãŒã€ latest ç­‰ã®ã‚¿ã‚°ä»˜ã URI ã§ã‚‚å¯ã§ã™ã€‚ã‚€ã—ã‚ã€ã‚¿ã‚°ä»˜ã URI ã‚’ä½¿ã£ã¦æ›´æ–°ã—ãŸã»ã†ãŒã€ãƒªã‚½ãƒ¼ã‚¹ã‚’ CFn ã‚„ Terraform ã§ç®¡ç†ã—ã¦ã„ã‚‹å ´åˆã«ã¯å·®åˆ†ãŒç™ºç”Ÿã—ãªã„ã®ã§ãŠã™ã™ã‚ã§ã™ã€‚\nã‚¿ã‚°ä»˜ã URI ã§æ›´æ–°ã—ãŸå ´åˆã§ã‚‚ã€å®Ÿéš›ã«åˆ©ç”¨ã•ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒãƒƒã‚·ãƒ¥ä»˜ã URI ã«ã¤ã„ã¦ã¯ lambda get-function ã§ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\naws lambda get-function \\ --function-name \u0026#39;lambda-parameters-extension-function\u0026#39; \\ --query \u0026#39;Code\u0026#39; | grep Uri \u0026#34;ImageUri\u0026#34;: \u0026#34;000000000000.dkr.ecr.ap-northeast-1.amazonaws.com/container-lambda-function:latest\u0026#34;, \u0026#34;ResolvedImageUri\u0026#34;: \u0026#34;000000000000.dkr.ecr.ap-northeast-1.amazonaws.com/container-lambda-function@sha256:c0b63302fa2ad2a78e6da8b37b8d4394c1b231a0963d82abd06d37dd4fd66277\u0026#34; æ›´æ–°ã—ãŸã‚ã¨ã¯ã€å®Ÿè¡ŒåŸºç›¤ãŒå¤‰ã‚ã£ã¦ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã¨ãªã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‹ã‚‰æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã§ã®å®Ÿè¡Œã¨ãªã‚Šã¾ã™ã€‚\nCI/CD ã‚’æ§‹ç¯‰ã™ã‚‹éš›ã®æ³¨æ„ç‚¹ ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ãŸ Lambda é–¢æ•°é–¢é€£ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã™ã‚‹éš›ã«ã¯ã€ã„ãã¤ã‹ä¾å­˜é–¢ä¿‚ãŒã‚ã‚Šãƒªã‚½ãƒ¼ã‚¹ä½œæˆã«é–¢ã—ã¦ã¯ä¸‹è¨˜ã®é †åºã§å®Ÿæ–½ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\nECR Repository ã‚’ä½œæˆ Lambda é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£… ECR Repository ã« push Lambda é–¢æ•°ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ (å¯¾è±¡ã¨ãªã‚‹ ECR Repository ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå­˜åœ¨ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚) CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã™ã‚‹éš›ã«ã‚‚ä¸Šè¨˜ã«æ³¨æ„ã—ãªãŒã‚‰é †ç•ªã«ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¦ã„ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ã¾ãšã¯ ECR ã« push ã™ã‚‹ã¨ã“ã‚ã¾ã§ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œã£ã¦ä¸€åº¦å®Ÿè¡Œã—ã€ãã®å¾Œã«é–¢æ•°ã‚’æ›´æ–°ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã™ã‚‹ã€ã¨ã„ã£ãŸæ®µéšã‚’è¸ã‚€ã“ã¨ã«ãªã‚Šã¾ã™ã€‚\nGitHub Actions ã«ã‚ˆã‚‹ CI/CD ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ãŸ Lambda é–¢æ•°ã®æ›´æ–°ã‚’ GitHub Actions ã§å®Ÿæ–½ã™ã‚‹å ´åˆã®å®Ÿè£…ä¾‹ã§ã™ã€‚\ndev ãƒ–ãƒ©ãƒ³ãƒã¸ã® push ã§ dev ç’°å¢ƒç”¨ã® Lambda é–¢æ•°ã‚’ã€ main ãƒ–ãƒ©ãƒ³ãƒã¸ã® push ã§ production ç’°å¢ƒç”¨ã® Lambda é–¢æ•°ã‚’ã€ãã‚Œãã‚Œæ›´æ–°ã™ã‚‹ã‚ˆã†ãªã‚µãƒ³ãƒ—ãƒ«ã«ãªã£ã¦ã„ã¾ã™ã€‚\nmichimani/container-lambda-cicd: ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã™ã‚‹ Lambda é–¢æ•°ã® CI/CD ã®ã‚µãƒ³ãƒ—ãƒ«ã€‚ èªè¨¼æƒ…å ±ã«ã¤ã„ã¦ã¯ã€äºˆã‚ä½œæˆã—ã¦ãŠã„ãŸ IAM Role ã® ARN ã®ãƒªãƒã‚¸ãƒˆãƒªã® Secrets ã«è¨­å®šã—ã¦ãŠã„ã¦ã€ yaml å†…ã§ã¯ ${{ secrets.ASSUME_ROLE_ARN }} ã§ä½¿ç”¨ã—ã¾ã™ã€‚å¤–éƒ¨ã‹ã‚‰è¨­å®šãŒå¿…è¦ãªæƒ…å ±ã¯ãã‚Œã ã‘ã§ã™ã€‚\nLambda Layer (Extension) ã®ä½¿ã„æ–¹ ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ãŸ Lambda é–¢æ•°ã§ã® Lambda Layer (Extension) ã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ã§ã™ã€‚\næ¦‚è¦ å¾“æ¥ã® Lambda é–¢æ•°ã§ã¯ã€ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ Layer ã‚’é¸æŠã€ã‚‚ã—ãã¯ Lambda ãƒªã‚½ãƒ¼ã‚¹å†…ã® Layers ã«ä½¿ç”¨ã—ãŸã„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æŒ‡å®šã™ã‚Œã°ã‚ˆã‹ã£ãŸã§ã™ãŒã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ãŸ Lambda é–¢æ•°ã§ã¯ã“ã®æ–¹æ³•ã§ã¯ä½¿ãˆã¾ã›ã‚“ã€‚\næ–¹æ³•ã¨ã—ã¦ã¯ã€ä½¿ç”¨ã—ãŸã„ Layer (Extension) ã®ãƒã‚¤ãƒŠãƒªã‚’ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«å«ã‚ã‚‹ã“ã¨ã§å®Ÿç¾ã—ã¾ã™ã€‚ é…ç½®ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚æ±ºã¾ã£ã¦ãŠã‚Šã€ /opt/extensions é…ä¸‹ã«ãƒã‚¤ãƒŠãƒªã‚’é…ç½®ã—ã¾ã™ã€‚\nLayer (Extension) ã«ã¤ã„ã¦ã¯ AWS å…¬å¼/3rd party å•ã‚ãšã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ãŒã€å…¬é–‹ã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ã€‚ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦å…¬é–‹ã•ã‚Œã¦ã„ãªã„ AWS å…¬å¼ã® Layer (Extension) ã«é–¢ã—ã¦ã¯ã€å¯¾å‡¦ã® Layer (Extension) ã® ARN ã‚’ã‚‚ã¨ã« lambda get-layer-version-by-arn ã§å–å¾—ã§ãã¾ã™ã€‚\nä»–ã®æ³¨æ„ç‚¹ã¨ã—ã¦ã€ Dockerfile ã®ã¨ã“ã‚ã§ã‚‚è§¦ã‚Œã¾ã—ãŸãŒã€ Layer (Extension) ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ AWS ãŒæä¾›ã—ã¦ã„ã‚‹ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\nå…·ä½“çš„ãªæ–¹æ³•ã«ã¤ã„ã¦ã¯ä¸‹è¨˜ã® AWS å…¬å¼ãƒ–ãƒ­ã‚°ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚\nã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã§Lambda ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨æ‹¡å¼µæ©Ÿèƒ½ã‚’å‹•ä½œã•ã›ã‚‹ | Amazon Web Services ãƒ–ãƒ­ã‚° Parameter and Secret Lambda Extension ã‚’ä½¿ã£ãŸã‚µãƒ³ãƒ—ãƒ« ä¾‹ã¨ã—ã¦ã€å…ˆæ—¥ç™ºè¡¨ã•ã‚Œã¦ã„ãŸ Parameter and Secret Lambda Extension ã‚’ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹ Lambda é–¢æ•°ã§ä½¿ã†å ´åˆã‚’è€ƒãˆã¾ã™ã€‚\nExtension ã®ãƒã‚¤ãƒŠãƒªå–å¾— ã¾ãšã¯ Extension ã®ãƒã‚¤ãƒŠãƒªã‚’å–å¾—ã—ã¾ã™ã€‚\nParameter and Secret Lambda Extension ã® ARN ã«ã¤ã„ã¦ã¯ä¸‹è¨˜ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚\nUse AWS Secrets Manager secrets in AWS Lambda functions - AWS Secrets Manager æ±äº¬ (ap-northeast-1) ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã® ARN ã¯\narn:aws:lambda:ap-northeast-1:133490724326:layer:AWS-Parameters-and-Secrets-Lambda-Extension:2\nãªã®ã§ã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ zip å½¢å¼ã® Extension ã‚’å–å¾—ã—ã¾ã™ã€‚\ncurl $( aws lambda get-layer-version-by-arn \\ --arn \u0026#39;arn:aws:lambda:ap-northeast-1:133490724326:layer:AWS-Parameters-and-Secrets-Lambda-Extension:2\u0026#39; \\ --query \u0026#39;Content.Location\u0026#39; --output text ) --output ps-ex.zip AWS å…¬å¼ãƒ–ãƒ­ã‚°å†…ã§ã¯ Dockerfile å†…ã«è¨˜è¿°ã•ã‚Œã¦ã„ã¾ã—ãŸãŒã€ ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ Dockerfile å†…ã«è¨˜è¿°ã—ãŸã‚Šç’°å¢ƒå¤‰æ•°ã§æ¸¡ã—ãŸã‚Šã™ã‚‹ã®ãŒé¢å€’ã ã£ãŸ (ç›´çƒ) ã®ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã‚‹æ–¹æ³•ã‚’ã¨ã£ã¦ã„ã¾ã™ã€‚\nã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä½œæˆ ä¸‹è¨˜ã®ã‚ˆã†ãª Dockerfile ã§ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚ã¾ãšã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å®Ÿè¡Œã‚’æƒ³å®šã—ã¦ã„ã‚‹ãŸã‚ entry.sh ã‚’å«ã‚ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚\n1FROM public.ecr.aws/lambda/provided:al2 as build 2RUN yum install -y golang unzip 3RUN go env -w GOPROXY=direct 4ADD go.mod go.sum ./ 5RUN go mod download 6ADD . . 7RUN go build -o /main 8RUN mkdir -p /opt 9ADD ./ps-ex.zip ./ 10RUN unzip ps-ex.zip -d /opt 11RUN rm ps-ex.zip 12 13FROM public.ecr.aws/lambda/provided:al2 14COPY --from=build /main /main 15COPY entry.sh / 16RUN chmod 755 /entry.sh 17RUN mkdir -p /opt/extensions 18WORKDIR /opt/extensions 19COPY --from=build /opt/extensions . 20ENTRYPOINT [ \u0026#34;/entry.sh\u0026#34; ] 21CMD [\u0026#34;/main\u0026#34;] 8-11 è¡Œç›®ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ Extension ã® zip ã‚’ãƒ“ãƒ«ãƒ‰ç”¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«è¿½åŠ ã— unzip ã—ã¦ã„ã¾ã™ã€‚\nãã—ã¦ 18-19 è¡Œç›®ã§ã€æœ€çµ‚çš„ã«ä½œæˆã•ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã® /opt/extensions ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« Extension ã®ãƒã‚¤ãƒŠãƒªã‚’é…ç½®ã—ã¦ã„ã¾ã™ã€‚\nå®Ÿè£… Parameter and Secret Lambda Extension ã¯ http://localhost:2773 ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¦ã„ã‚‹ã®ã§ã€ä¸‹è¨˜ã®ã‚ˆã†ãªå®Ÿè£…ã§åˆ©ç”¨ã—ã¾ã™ã€‚\nconst ( // Endpoint for getting parameter by Parameters and Secrets Lambda Extension. exGetParameterEndpoint = \u0026#34;http://localhost:2773/systemsmanager/parameters/get\u0026#34; // Header key of secret token secretTokenHeaderKey = \u0026#34;X-Aws-Parameters-Secrets-Token\u0026#34; // Query parameter key queryParameterKeyForName = \u0026#34;name\u0026#34; queryParameterKeyForVersion = \u0026#34;version\u0026#34; ) // Struct of response from AWSParametersAndSecretsLambdaExtension API type resultFromExtension struct { Parameter struct { ARN string DateType string LastModifiedDate time.Time Name string Selector string SourceResult *string Type string Value string Version int } ResultMetadata any } // Get a value using Parameters and Secrets Lambda Extension. func getValueByUsingExtension(key string, version int) (string, error) { // Get a value from extension // https://docs.aws.amazon.com/systems-manager/latest/userguide/ps-integration-lambda-extensions.html query := url.Values{} query.Add(queryParameterKeyForName, key) query.Add(queryParameterKeyForVersion, fmt.Sprintf(\u0026#34;%d\u0026#34;, version)) queryStr := query.Encode() url := fmt.Sprintf(\u0026#34;%s?%s\u0026#34;, exGetParameterEndpoint, queryStr) req, err := http.NewRequestWithContext(context.Background(), \u0026#34;GET\u0026#34;, url, nil) if err != nil { return \u0026#34;\u0026#34;, err } // set X-Aws-Parameters-Secrets-Token header req.Header.Add(secretTokenHeaderKey, os.Getenv(\u0026#34;AWS_SESSION_TOKEN\u0026#34;)) // call Extension API client := http.Client{} res, err := client.Do(req) if err != nil { return \u0026#34;\u0026#34;, err } defer res.Body.Close() buf := new(bytes.Buffer) if _, err := buf.ReadFrom(res.Body); err != nil { return \u0026#34;\u0026#34;, err } bodyString := buf.String() if res.StatusCode != http.StatusOK { return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;Failed to get parameter by using extension. statusCode:%d body:%s\u0026#34;, res.StatusCode, bodyString) } exRes := resultFromExtension{} if err := json.Unmarshal([]byte(bodyString), \u0026amp;exRes); err != nil { return \u0026#34;\u0026#34;, err } return exRes.Parameter.Value, nil } Extension ã‚’ä½¿ã£ãŸå ´åˆã®ãƒ­ã‚° Extension ã‚’ä½¿ã£ãŸå ´åˆã€ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ­ã‚°ãŒç¢ºèªã§ãã¾ã™ã€‚\n[AWS Parameters and Secrets Lambda Extension] 2022/11/03 15:20:32 PARAMETERS_SECRETS_EXTENSION_LOG_LEVEL is not present. Log level set to info. [AWS Parameters and Secrets Lambda Extension] 2022/11/03 15:20:32 INFO Systems Manager Parameter Store and Secrets Manager Lambda Extension 1.0.94 [AWS Parameters and Secrets Lambda Extension] 2022/11/03 15:20:32 INFO Serving on port 2773 è©³ç´°ãªå®Ÿè£…ã‚µãƒ³ãƒ—ãƒ«ã«ã¤ã„ã¦ã¯ã“ã¡ã‚‰ã€‚\nmichimani/lambda-parameters-extension: Sample code of using Parameter and Secret Lambda Extension. ã¾ã¨ã‚ ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ãŸ Lambda é–¢æ•°ã«ã¤ã„ã¦ã€æœ€è¿‘è§¦ã£ã¦ã„ã¦ã‚ã‹ã£ãŸã“ã¨ãªã©ã‚’ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚\nLambda é–¢æ•°ã¯ä¾¿åˆ©ã§åˆ©ç”¨ã§ãã‚‹å ´é¢ã‚‚å¤šã„åé¢ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å‹•ä½œç¢ºèªãŒ (SAM ç­‰ã®ãƒ„ãƒ¼ãƒ«ã‚’åˆ¥é€”ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã‚Šã§) é¢å€’ãªå°è±¡ã§ã—ãŸã€‚\nãã‚ŒãŒã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†ã“ã¨ã§ (å®Ÿéš›ã«ã¯ RIE ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§) å®Ÿéš›ã®ç’°å¢ƒã¨ã»ã¼åŒã˜ã‚ˆã†ãªæŒ™å‹•ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨ã„ã†ç‚¹ãŒã€å€‹äººçš„ã«ã¯ä¸€ç•ªå¬‰ã—ã„ã§ã™ã€‚\nã“ã®ä¸€ç‚¹ã ã‘ã§ã‚‚ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ Lambda ã‚’ä½¿ã†ä¾¡å€¤ã¯ã‚ã‚‹ã‹ãªã¨æ€ã£ã¦ã„ã¾ã™ã€‚\nä»–ã«ã¯ã€CI/CD ã«é–¢ã—ã¦ã‚‚ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ ECR ã« push ã™ã‚‹ã¨ã“ã‚ã¾ã§ã¯ ECS ã‚¿ã‚¹ã‚¯ã®å ´åˆã¨åŒã˜ãªã®ã§ã€ãã®ã‚ãŸã‚Šã®å…±é€šåŒ– (ã‚‚ã—ãã¯ã»ã¼æµç”¨) ãŒã§ãã‚‹ã¨ã„ã†ã®ã‚‚å¬‰ã—ã„ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚\nã¨ã„ã†ã“ã¨ã§ã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ãŸ Lambda é–¢æ•°ã¯ã„ã„ãã€‚\nã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ Go Lambda é–¢æ•°ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ - AWS Lambda \u0026#160;\u0026#x21a9;\u0026#xfe0e;\nAWS Lambda ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  API - AWS Lambda \u0026#160;\u0026#x21a9;\u0026#xfe0e;\n",
    "permalink": "https://michimani.net/post/aws-lambda-function-with-container-image/",
    "title": "ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã£ãŸ Lambda é–¢æ•°ã®ã‚ã‚Œã“ã‚Œ"
  },
  {
    "contents": "CloudFront ã‹ã‚‰ S3 ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹æ–¹æ³•ã¨ã—ã¦ Origin Access Identity (OAI) ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã—ãŸãŒã€ãã‚Œã«ä»£ã‚ã‚‹æ©Ÿèƒ½ã¨ã—ã¦ Origin Access Control (OAC) ã¨ã„ã†æ©Ÿèƒ½ãŒç™ºè¡¨ã•ã‚Œã¾ã—ãŸã€‚ä»Šå›ã¯ã€ AWS CLI ã‚’ä½¿ã£ã¦ OAI ã‚’åˆ©ç”¨ã—ã¦ã„ãŸã‚‚ã®ã‚’ OAC ã«ç§»è¡Œã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚\nç§»è¡Œæ–¹æ³• AWS CLI ã§ã‚„ã£ã¦ã„ã 1. å¯¾è±¡ã® S3 Bucket ã® Bucket Policy ã«ã€ Origin Access Identity ã® Statement ã‚’æ®‹ã—ãŸã¾ã¾ Origin Access Control ã® Statement ã‚’è¿½è¨˜ã™ã‚‹ ç¾åœ¨ã® Bucket Policy ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ Origin Access Control ã«ã‚ˆã‚‹åˆ¶å¾¡ã® Statement ã‚’è¿½è¨˜ã™ã‚‹ Bucket Policy ã‚’æ›´æ–°ã™ã‚‹ 2. Origin Access Control ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ always (æ¨å¥¨è¨­å®š) never no-override 3. å¯¾è±¡ã® Distribution ã«è¨­å®šã™ã‚‹ 4. å¯¾è±¡ã® S3 Bucket ã® Bucket Policy ã‹ã‚‰ Origin Access Identity ã® Statement ã‚’å‰Šé™¤ã™ã‚‹ 5. ä¸è¦ã«ãªã£ãŸ Origin Access Identity ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹ ã¾ã¨ã‚ ç§»è¡Œæ–¹æ³• åŸºæœ¬çš„ã«ã¯ä¸‹è¨˜ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ²¿ã£ã¦ç§»è¡Œã—ã¦ã„ãã¾ã™ã€‚\nRestricting access to an Amazon S3 origin - Amazon CloudFront å…·ä½“çš„ãªæ‰‹é †ã¨ã—ã¦ã¯ã€\nå¯¾è±¡ã® S3 Bucket ã® Bucket Policy ã«ã€ Origin Access Identity ã® Statement ã‚’æ®‹ã—ãŸã¾ã¾ Origin Access Control ã® Statement ã‚’è¿½è¨˜ã™ã‚‹ Origin Access Control ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ å¯¾è±¡ã® Distribution ã«è¨­å®šã™ã‚‹ å¯¾è±¡ã® S3 Bucket ã® Bucket Policy ã‹ã‚‰ Origin Access Identity ã® Statement ã‚’å‰Šé™¤ã™ã‚‹ ä¸è¦ã«ãªã£ãŸ Origin Access Identity ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹ ã¨ãªã‚Šã¾ã™ã€‚\nAWS CLI ã§ã‚„ã£ã¦ã„ã ä»Šå›ã¯ã€ä¸Šè¨˜ã®æ‰‹é †ã‚’ AWS CLI ã‚’ä½¿ã£ã¦ã‚„ã£ã¦ã¿ã¾ã™ã€‚\nå¿…è¦ãª AWS CLI ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€ v1 ã¯ 1.25.60 ä»¥é™ã€ v2 ã¯ 2.7.27 ä»¥é™ã§ã™ã€‚ä»Šå›ã¯ v2 ã‚’ä½¿ã„ã¾ã™ã€‚\nâ¯ aws --version aws-cli/2.7.27 Python/3.9.11 Darwin/21.6.0 exe/x86_64 prompt/off ä½œæ¥­ã™ã‚‹ã«ã‚ãŸã£ã¦ã¯ã€å¯¾è±¡ã® S3 Bucket ã®åå‰ã¨ CloudFront ã® Distribution ID ãŒå¿…è¦ãªã®ã§ã€ãã‚Œãã‚Œç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¦ãŠãã¾ã™ã€‚\nBUCKET_NAME=\u0026#39;your-bucket-name\u0026#39; DIST_ID=\u0026#39;your-distribution-id\u0026#39; 1. å¯¾è±¡ã® S3 Bucket ã® Bucket Policy ã«ã€ Origin Access Identity ã® Statement ã‚’æ®‹ã—ãŸã¾ã¾ Origin Access Control ã® Statement ã‚’è¿½è¨˜ã™ã‚‹ ç¾åœ¨ã® Bucket Policy ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ aws s3api get-bucket-policy \\ --bucket \u0026#34;${BUCKET_NAME}\u0026#34; \\ --output text \\ | jq . \u0026gt; bucket-policy.json OAI ã«ã‚ˆã‚‹åˆ¶å¾¡ã® Statement ã¨ã—ã¦ä¸‹è¨˜ã®ã‚ˆã†ãªè¨­å®šãŒã•ã‚Œã¦ã„ã¾ã™ã€‚\n{ \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Sid\u0026#34;: \u0026#34;OriginAccessIdentityStatement\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;AWS\u0026#34;: \u0026#34;arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity your-distribution-id\u0026#34; }, \u0026#34;Action\u0026#34;: [ \u0026#34;s3:GetObject\u0026#34;, \u0026#34;s3:ListBucket\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:s3:::your-bucket-name/*\u0026#34;, \u0026#34;arn:aws:s3:::your-bucket-name\u0026#34; ] } ] } Origin Access Control ã«ã‚ˆã‚‹åˆ¶å¾¡ã® Statement ã‚’è¿½è¨˜ã™ã‚‹ ä¸Šè¨˜ã® JSON ã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«ç·¨é›†ã—ã¾ã™ã€‚(Distribution ARN ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ID ã¯èª­ã¿æ›¿ãˆã¦ãã ã•ã„)\n{ \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ + { + \u0026#34;Sid\u0026#34;: \u0026#34;OriginAccessControlStatement\u0026#34;, + \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, + \u0026#34;Principal\u0026#34;: { + \u0026#34;Service\u0026#34;: \u0026#34;cloudfront.amazonaws.com\u0026#34; + }, + \u0026#34;Action\u0026#34;: [ + \u0026#34;s3:GetObject\u0026#34;, + \u0026#34;s3:ListBucket\u0026#34; + ], + \u0026#34;Resource\u0026#34;: [ + \u0026#34;arn:aws:s3:::your-bucket-name/*\u0026#34;, + \u0026#34;arn:aws:s3:::your-bucket-name\u0026#34; + ], + \u0026#34;Condition\u0026#34;: { + \u0026#34;StringEquals\u0026#34;: { + \u0026#34;AWS:SourceArn\u0026#34;: \u0026#34;arn:aws:cloudfront::000000000000:distribution/your-distribution-id\u0026#34; + } + } + }, { \u0026#34;Sid\u0026#34;: \u0026#34;OriginAccessIdentityStatement\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;AWS\u0026#34;: \u0026#34;arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity your-origin-access-identity-id\u0026#34; }, \u0026#34;Action\u0026#34;: [ \u0026#34;s3:GetObject\u0026#34;, \u0026#34;s3:ListBucket\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:s3:::your-bucket-name/*\u0026#34;, \u0026#34;arn:aws:s3:::your-bucket-name\u0026#34; ] } ] } Bucket Policy ã‚’æ›´æ–°ã™ã‚‹ aws s3api put-bucket-policy \\ --bucket \u0026#34;${BUCKET_NAME}\u0026#34; \\ --policy file://bucket-policy.json å•é¡Œãªã„ã¯ãšã§ã™ãŒã€ä¸€å¿œã“ã®æ™‚ç‚¹ã§ã¡ã‚ƒã‚“ã¨ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚\n2. Origin Access Control ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ Origin Access Control ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆã«ã¯ã€æ–°ãŸã«è¿½åŠ ã•ã‚ŒãŸ cloudfront ã‚³ãƒãƒ³ãƒ‰ã® create-origin-access-control ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã„ã¾ã™ã€‚\nâ¯ aws cloudfront create-origin-access-control help ... SYNOPSIS create-origin-access-control --origin-access-control-config \u0026lt;value\u0026gt; [--cli-input-json | --cli-input-yaml] [--generate-cli-skeleton \u0026lt;value\u0026gt;] [--debug] [--endpoint-url \u0026lt;value\u0026gt;] [--no-verify-ssl] [--no-paginate] [--output \u0026lt;value\u0026gt;] [--query \u0026lt;value\u0026gt;] [--profile \u0026lt;value\u0026gt;] [--region \u0026lt;value\u0026gt;] [--version \u0026lt;value\u0026gt;] [--color \u0026lt;value\u0026gt;] [--no-sign-request] [--ca-bundle \u0026lt;value\u0026gt;] [--cli-read-timeout \u0026lt;value\u0026gt;] [--cli-connect-timeout \u0026lt;value\u0026gt;] [--cli-binary-format \u0026lt;value\u0026gt;] [--no-cli-pager] [--cli-auto-prompt] [--no-cli-auto-prompt] ... ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ yaml ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ã¦ --cli-input-yaml ã§æ¸¡ã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œã£ã¦ã¿ã¾ã™ã€‚\nãã®ãŸã‚ã«ã€ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ yaml ã‚’ç”Ÿæˆã—ã¾ã™ã€‚\naws cloudfront create-origin-access-control \\ --generate-cli-skeleton yaml-input \u0026gt; oac.yaml ä¸­èº«ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã€å¿…é ˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã¿è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚\nOriginAccessControlConfig: # [REQUIRED] Contains the origin access control. Name: \u0026#39;\u0026#39; # [REQUIRED] A name to identify the origin access control. Description: \u0026#39;\u0026#39; # [REQUIRED] A description of the origin access control. SigningProtocol: sigv4 # [REQUIRED] The signing protocol of the origin access control, which determines how CloudFront signs (authenticates) requests. Valid values are: sigv4. SigningBehavior: never # [REQUIRED] Specifies which requests CloudFront signs (adds authentication information to). Valid values are: never, always, no-override. OriginAccessControlOriginType: s3 # [REQUIRED] The type of origin that this origin access control is for. Valid values are: s3. ãªã®ã§ã€ä¸­èº«ã‚’åŸ‹ã‚ã¾ã™ã€‚\nOriginAccessControlConfig: Name: \u0026#39;OriginAccessControlForMyBlog\u0026#39; Description: \u0026#39;Origin Access Control for my blog.\u0026#39; SigningProtocol: sigv4 SigningBehavior: always OriginAccessControlOriginType: s3 Name, Description ã«ã¤ã„ã¦ã¯ä»»æ„ã®æ–‡å­—åˆ—ã‚’å…¥ã‚Œã¾ã™ã€‚\nSigningProtocol ã«ã¯ãã®ã¾ã¾ sigv4 ã‚’ã€ OriginAccessControlOriginType ã«ã‚‚ãã®ã¾ã¾ s3 ã‚’å…¥ã‚Œã¾ã™ã€‚\nSigningBehavior ã«ã¤ã„ã¦ã¯ã€ä¸‹è¨˜å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® Advanced settings for origin access control ã®éƒ¨åˆ†ã‚’ç¢ºèªã—ã€ always, never, no-override ã®ã„ãšã‚Œã‹ã‚’å…¥ã‚Œã¾ã™ã€‚\nRestricting access to an Amazon S3 origin | Advanced settings for origin access control - Amazon CloudFront ãã‚Œãã‚Œã®è¨­å®šã«ã¤ã„ã¦ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã‚’è¦ç´„ã—ã¦ã¿ã¾ã™ã€‚\nalways (æ¨å¥¨è¨­å®š) CloudFront ãŒ Origin (S3 Bucket) ã«é€ä¿¡ã™ã‚‹ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ç½²åã—ã¾ã™ã€‚\nnever CloudFront ãŒ Origin (S3 Bucket) ã«é€ä¿¡ã™ã‚‹ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ç½²åã—ã¾ã›ã‚“ã€‚ã“ã‚Œã¯ã¤ã¾ã‚Šã€ã“ã® Origin Access Control ã‚’ä½¿ç”¨ã™ã‚‹ Distribution ã®ã™ã¹ã¦ã® Origin ã«å¯¾ã—ã¦ ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ã‚ªãƒ•ã«ã—ã¾ã™ã€‚\nã“ã®è¨­å®šã‚’ã™ã‚‹å ´åˆã€ Originã¨ãªã‚‹ S3 Bucket ã«ã¯ Public ã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å…¬é–‹ã•ã‚Œã¦ã„ãªã„ Bucket ã«å¯¾ã—ã¦ã“ã®è¨­å®šã‚’è¡Œã†ã¨ã€ CloudFront ã¯ Origin ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããšã€ Viewer ã«ã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã™ã€‚\nno-override Viewer ãƒªã‚¯ã‚¨ã‚¹ãƒˆã« Authorization ãƒ˜ãƒƒãƒ€ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ Origin ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä½¿ç”¨ã—ã€å«ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ CloudFront ãŒç½²åã—ã¾ã™ã€‚\nã“ã®è¨­å®šã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ Viewer ã‹ã‚‰ã® Authorization ãƒ˜ãƒƒãƒ€ã‚’ Origin ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒªã‚·ãƒ¼ã§ Authorization ãƒ˜ãƒƒãƒ€ã‚’è¨±å¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\nä»¥ä¸Šã‹ã‚‰ã€åŸºæœ¬çš„ã«ã¯ always ã§è¨­å®šã—ã¦ãŠã‘ã°è‰¯ã•ãã†ã§ã™ã€‚\nä½œã£ãŸ yaml ã‚’ã‚‚ã¨ã«ã€ Origin Access Control ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚ä½œæˆçµæœã¨ã—ã¦ ID ãŒå¾Œã«å¿…è¦ã«ãªã‚‹ã®ã§æ§ãˆã¦ãŠãã¾ã™ã€‚\naws cloudfront create-origin-access-control \\ --cli-input-yaml file://oac.yaml \\ --query \u0026#39;OriginAccessControl.Id\u0026#39; \\ --output text 3. å¯¾è±¡ã® Distribution ã«è¨­å®šã™ã‚‹ ç¶šã„ã¦ã€ä½œæˆã—ãŸ Origin Access Control ã‚’ Distribution ã«è¨­å®šã—ã¾ã™ã€‚ ã“ã‚Œã¯ cloudfront ã® update-distribution ã¨ã„ã†ã€ã©ãƒ‡ã‚«ã‚¤æ›´æ–°ã‚’è¡Œã†ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿæ–½ã—ã¾ã™ã€‚\nã¾ãšã¯ç¾çŠ¶ã® Distribution ã®è¨­å®šã‚’ yaml ã§å–å¾—ã—ã€ä¸­èº«ã‚’å¤‰æ›´ã—ã¦ update-distribution ã§æŠ•ã’ã¾ã™ã€‚\naws cloudfront get-distribution-config \\ --id \u0026#34;${DIST_ID}\u0026#34; \\ --output yaml \\ \u0026gt; dist-config.yaml 100 è¡Œã‚’è¶…ãˆã‚‹ yaml ãŒç”Ÿæˆã•ã‚Œã‚‹ã®ã§ã€ãã®ä¸­ã® Origins ã®è¨­å®šã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚ã“ã®ã¨ãã€ Origin Access Identity ã®ãƒªã‚½ãƒ¼ã‚¹ã¯å¾Œã«å‰Šé™¤ã™ã‚‹ã®ã§ã€ your-oai-id ã®éƒ¨åˆ†ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¦ãŠãã¾ã™ã€‚ (OAI_ID='your-oai-id')\n+ OriginAccessControlId: your-oac-id S3OriginConfig: - OriginAccessIdentity: origin-access-identity/cloudfront/your-oai-id + OriginAccessIdentity: \u0026#39;\u0026#39; ã¾ãŸã€ ETag ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã® å€¤ã¯ãã®ã¾ã¾ã§ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’ IfMatch ã«å¤‰æ›´ã—ã¾ã™ã€‚\n- ETag: HOGEHOGEVALUE + IfMatch: HOGEHOGEVALUE ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§æ›´æ–°ã—ã¾ã™ã€‚\naws cloudfront update-distribution \\ --id \u0026#34;${DIST_ID}\u0026#34; \\ --cli-input-yaml file://dist-config.yaml ã“ã®æ™‚ç‚¹ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦ã„ã‚Œã°ã€æ—¢ã« Origin Access Control ã«ã‚ˆã‚‹åˆ¶å¾¡ã¸ã®ç§»è¡Œã¯æˆåŠŸã—ã¦ã„ã¾ã™ã€‚\n4. å¯¾è±¡ã® S3 Bucket ã® Bucket Policy ã‹ã‚‰ Origin Access Identity ã® Statement ã‚’å‰Šé™¤ã™ã‚‹ Bucket Policy å†…ã® Origin Access Identity ã® Statement ã¯ä¸è¦ã«ãªã£ãŸã®ã§å‰Šé™¤ã—ã¾ã™ã€‚\n1 ã®æ‰‹é †ã§ä½¿ã£ãŸ bucket-policy.json ã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«å¤‰æ›´ã—ã€ put-bucket-policy ã§æ›´æ–°ã—ã¾ã™ã€‚\n{ \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Sid\u0026#34;: \u0026#34;OriginAccessControlStatement\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;cloudfront.amazonaws.com\u0026#34; }, \u0026#34;Action\u0026#34;: [ \u0026#34;s3:GetObject\u0026#34;, \u0026#34;s3:ListBucket\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:s3:::your-bucket-name/*\u0026#34;, \u0026#34;arn:aws:s3:::your-bucket-name\u0026#34; ], \u0026#34;Condition\u0026#34;: { \u0026#34;StringEquals\u0026#34;: { \u0026#34;AWS:SourceArn\u0026#34;: \u0026#34;arn:aws:cloudfront::000000000000:distribution/your-distribution-id\u0026#34; } } - }, - { - \u0026#34;Sid\u0026#34;: \u0026#34;OriginAccessIdentityStatement\u0026#34;, - \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, - \u0026#34;Principal\u0026#34;: { - \u0026#34;AWS\u0026#34;: \u0026#34;arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity your-origin-access-identity-id\u0026#34; - }, - \u0026#34;Action\u0026#34;: [ - \u0026#34;s3:GetObject\u0026#34;, - \u0026#34;s3:ListBucket\u0026#34; - ], - \u0026#34;Resource\u0026#34;: [ - \u0026#34;arn:aws:s3:::your-bucket-name/*\u0026#34;, - \u0026#34;arn:aws:s3:::your-bucket-name\u0026#34; - ] } ] } aws s3api put-bucket-policy \\ --bucket \u0026#34;${BUCKET_NAME}\u0026#34; \\ --policy file://bucket-policy.json 5. ä¸è¦ã«ãªã£ãŸ Origin Access Identity ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹ ä¸è¦ã«ãªã£ãŸ Origin Access Identity ã®ãƒªã‚½ãƒ¼ã‚¹ã¯ cloudfront ã‚³ãƒãƒ³ãƒ‰ã® delete-cloud-front-origin-access-identity ã‚³ãƒãƒ³ãƒ‰ã§å‰Šé™¤ã—ã¾ã™ã€‚\naws cloudfront delete-cloud-front-origin-access-identity \\ --id \u0026#34;${OAI_ID}\u0026#34; \\ --if-match $( aws cloudfront get-cloud-front-origin-access-identity \\ --id ${OAI_ID} \\ --query \u0026#39;ETag\u0026#39; \\ --output text) ã¾ã¨ã‚ Amazon CloudFront ã®æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½ã§ã‚ã‚‹ Origin Access Control ã¸ã®ç§»è¡Œã‚’ AWS CLI ã§ã‚„ã£ã¦ã¿ãŸè©±ã§ã—ãŸã€‚\nTerraform ã‚‚æ¬¡ã® 4.29.0 ã§å¯¾å¿œã•ã‚Œãã†ãªã®ã§ã€å¯¾å¿œã•ã‚ŒãŸã‚‰è©¦ã—ã¦ã¿ã¾ã™ã€‚\n",
    "permalink": "https://michimani.net/post/aws-migrate-cloudfront-oai-to-oac/",
    "title": "AWS CLI ã§ CloudFront ã® OAI ã‚’ OAC ã«ç§»è¡Œã™ã‚‹"
  },
  {
    "contents": "æœ€è¿‘ Go è¨€èªã§ AWS CDK ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€ L1 Constructs (low-level constructs) ã§ã®è¨˜è¿°ã«é–¢ã™ã‚‹æƒ…å ±ãŒè¦‹ã¤ã‘ã‚‰ã‚Œãšè‹¦æˆ¦ã—ãŸã®ã§ã€ãƒ¡ãƒ¢ã¨ã—ã¦æ®‹ã—ã¦ãŠãã¾ã™ã€‚\nç›®æ¬¡ å‰æ L1 Constructs ãŒå¿…è¦ãªç†ç”± ãƒªã‚½ãƒ¼ã‚¹æŒ‡å®šã—ãªã„ã€ã¾ãŸã¯å›ºå®šå€¤ã§æŒ‡å®šã™ã‚‹å ´åˆ ç‰¹å®šã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒã¤ Stack ã‚’å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹ã¨ã™ã‚‹å ´åˆ L1 Constructs ã‚’ä½¿ç”¨ã—ãŸãƒªã‚½ãƒ¼ã‚¹ã®å®šç¾©æ–¹æ³• ã¾ã¨ã‚ å‰æ ä»Šå›ã¯ã€å…ˆæ—¥ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ CloudFormation Stack ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ SNS çµŒç”±ã§ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã™ã‚‹æ§‹æˆã‚’ AWS CDK v2 (Go) ã§æ§‹ç¯‰ã—ã¦ã¿ã¾ã™ã€‚\nä½œæˆã™ã‚‹ä¸»ãªãƒªã‚½ãƒ¼ã‚¹ã¯ä¸‹è¨˜ã®ã¨ãŠã‚Šã§ã™ã€‚\nSNS::Topic SNS::TopicPolicy Events::Rule ã¾ãŸã€é€šçŸ¥ã•ã‚Œã‚‹ã®ã¯ ç‰¹å®šã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒã¤ Stack ã®ã¿ ã‚’å¯¾è±¡ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚\nL1 Constructs ãŒå¿…è¦ãªç†ç”± ä»Šå›ã®æ§‹æˆã§ L1 Constructs ãŒå¿…è¦ã«ãªã‚‹ç†ç”±ã¯ã€ EventPattern ã§ Resources ã‚’æŒ‡å®šã™ã‚‹éš›ã«ã€ prefix æ¼”ç®—å­ã‚’ä½¿ç”¨ã—ãŸã„ã‹ã‚‰ã§ã™ã€‚\nEventPattern ã§ã¯ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ (*) ã«ã‚ˆã‚‹å€¤ã®ãƒãƒƒãƒãŒã§ããš1ã€ä»Šå›ã®è¦ä»¶ã§ã‚ã‚‹ ç‰¹å®šã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒã¤ Stack ã®ã¿ ã‚’å¯¾è±¡ã¨ã—ãŸã„å ´åˆã¯ prefix æ¼”ç®—å­ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚2 ã“ã® prefix æ¼”ç®—å­ã‚’ä½¿ç”¨ã™ã‚‹ã‹å¦ã‹ã§ã€ L1 Constructs ã«ã‚ˆã‚‹å®Ÿè£…ãŒå¿…è¦ã‹å¦ã‹ãŒæ±ºã¾ã‚Šã¾ã™ã€‚\nå…·ä½“çš„ã«ã©ã®ã‚ˆã†ãªé•ã„ã«ãªã‚‹ã®ã‹è¦‹ã¦ã„ãã¾ã™ã€‚\nãƒªã‚½ãƒ¼ã‚¹æŒ‡å®šã—ãªã„ã€ã¾ãŸã¯å›ºå®šå€¤ã§æŒ‡å®šã™ã‚‹å ´åˆ ã¾ãšã€ EventPattern ã¨ã—ã¦æŒ‡å®šã™ã‚‹ JSON ã®ã‚¹ã‚­ãƒ¼ãƒãŠã‚ˆã³è¨˜è¿°æ–¹æ³•ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\n{ \u0026#34;detail-type\u0026#34;: [ \u0026#34;CloudFormation Resource Status Change\u0026#34;, \u0026#34;CloudFormation Stack Status Change\u0026#34;, \u0026#34;CloudFormation Drift Detection Status Change\u0026#34; ], \u0026#34;resources\u0026#34;: [ \u0026#34;arn:aws:cloudformation:ap-northeast-1:000000000000:stack/TestStack_Red\u0026#34;, \u0026#34;arn:aws:cloudformation:ap-northeast-1:000000000000:stack/TestStack_Green\u0026#34;, \u0026#34;arn:aws:cloudformation:ap-northeast-1:000000000000:stack/TestStack_Blue\u0026#34; ] } ä¸€æ–¹ã€ AWS CDK (Go) ã® L2 Constructs ã§ EventPattern ã®å®šç¾©ã«ä½¿ç”¨ã™ã‚‹ awsevents.EventPattern æ§‹é€ ä½“ã®å®šç¾©ã¯ä¸‹è¨˜ã®ã¨ãŠã‚Šã§ã™ã€‚(ä¸Šè¨˜ã® JSON ã¨å¯¾å¿œã™ã‚‹éƒ¨åˆ†ã®ã¿ã€‚å…¨ä½“ã¯ pkg.go.dev ã‚’å‚ç…§ã€‚)\ntype EventPattern struct { DetailType *[]*string `field:\u0026#34;optional\u0026#34; json:\u0026#34;detailType\u0026#34; yaml:\u0026#34;detailType\u0026#34;` Resources *[]*string `field:\u0026#34;optional\u0026#34; json:\u0026#34;resources\u0026#34; yaml:\u0026#34;resources\u0026#34;` } Resources ã¯ *string ã®ã‚¹ãƒ©ã‚¤ã‚¹ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€è¨­å®šã—ãŸã„ JSON ã®ã‚¹ã‚­ãƒ¼ãƒã¨ä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚ãªã®ã§ã€å›ºå®šã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å¯¾è±¡ã¨ã™ã‚‹ã€ã‚‚ã—ãã¯ãƒªã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®šã—ãªã„å ´åˆã¯ L2 Constructs ã§å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ (å¯¾è±¡ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®šã—ãªã„å ´åˆã¯ EventPattern.Resources ã‚’çœç•¥ã™ã‚Œã°ã‚ˆã„ã ã‘ã§ã™)\nç‰¹å®šã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒã¤ Stack ã‚’å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹ã¨ã™ã‚‹å ´åˆ ç‰¹å®šã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒã¤ Stack ã‚’å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹ã¨ã™ã‚‹å ´åˆã€ EventPattern ã® JSON ã¯ prefix æ¼”ç®—å­ã‚’ä½¿ç”¨ã—ã¦ä¸‹è¨˜ã®ã‚ˆã†ãªè¨˜è¿°ã«ãªã‚Šã¾ã™ã€‚\n{ \u0026#34;detail-type\u0026#34;: [ \u0026#34;CloudFormation Resource Status Change\u0026#34;, \u0026#34;CloudFormation Stack Status Change\u0026#34;, \u0026#34;CloudFormation Drift Detection Status Change\u0026#34; ], \u0026#34;resources\u0026#34;: [ { \u0026#34;prefix\u0026#34;: \u0026#34;arn:aws:cloudformation:ap-northeast-1:000000000000:stack/TestStack\u0026#34; } ] } prefix æ¼”ç®—å­ã‚’ä½¿ã‚ãªã„å ´åˆã¨ã¯ç•°ãªã‚Šã€ resources é…åˆ—ã®ä¸­èº«ãŒæ–‡å­—åˆ—ã§ã¯ãªãã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãªã£ã¦ã„ã¾ã™ã€‚ãªã®ã§ã€ L2 Constructs ã§ã¯ã“ã® JSON ã‚’è¡¨ç¾ã™ã‚‹ã“ã¨ãŒã§ããšã€ L1 Constructs ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒå‡ºã¦ãã¾ã™ã€‚\nL1 Constructs ã‚’ä½¿ç”¨ã—ãŸãƒªã‚½ãƒ¼ã‚¹ã®å®šç¾©æ–¹æ³• ã§ã¯ã“ã“ã§æœ¬é¡Œã®ã€ AWS CDK (Go) ã§ L1 Constructs ã‚’ä½¿ç”¨ã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è¦‹ã¦ã„ãã¾ã™ã€‚\nçµè«–ã¨ã—ã¦ã€ *map[string]interface{} å‹ã§å®šç¾©ã—ã¾ã™ã€‚\nå…ˆã»ã©ã® prefix æ¼”ç®—å­ã‚’ä½¿ç”¨ã—ãŸ JSON ã‚’è¡¨ç¾ã™ã‚‹ã«ã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ã« EventPattern ã‚’å®šç¾©ã—ã¾ã™ã€‚\neventPattern := \u0026amp;map[string]interface{}{ \u0026#34;detail-type\u0026#34;: \u0026amp;[]*string{ jsii.String(\u0026#34;CloudFormation Resource Status Change\u0026#34;), jsii.String(\u0026#34;CloudFormation Stack Status Change\u0026#34;), jsii.String(\u0026#34;CloudFormation Drift Detection Status Change\u0026#34;), }, \u0026#34;resources\u0026#34;: \u0026amp;[]interface{}{ \u0026amp;map[string]*string{ \u0026#34;prefix\u0026#34;: jsii.String(\u0026#34;arn:aws:cloudformation:ap-northeast-1:000000000000:stack/TestStack\u0026#34;), }, }, } L1 Constructs ã ã¨ awsevents.CfnRuleProps.EventPattern ãŒ interface{} å‹ã«ãªã‚‹ã®ã§ã€ *map[string]interface{} å‹ã®ã‚¹ãƒ©ã‚¤ã‚¹ã¨ã—ã¦å®Ÿè£…ã™ã‚‹ã“ã¨ã§å˜ç´”ãªæ–‡å­—åˆ—ã‚„ prefix ãªã©ã®æ¼”ç®—å­ã‚’ä½¿ç”¨ã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã§ã®æŒ‡å®šãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚\nã“ã‚Œã‚’ awsevents.CfnRule ã®å®šç¾©ã¨åˆã‚ã›ã‚‹ã¨ã€ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\nawsevents.NewCfnRule(scope, jsii.String(\u0026#34;CloudFormationEventsRule\u0026#34;), \u0026amp;awsevents.CfnRuleProps{ Name: jsii.String(util.ToKebabCase(\u0026#34;cloud-formation-events-rule\u0026#34;)), EventBusName: jsii.String(\u0026#34;default\u0026#34;), State: jsii.String(\u0026#34;ENABLED\u0026#34;), EventPattern: \u0026amp;map[string]interface{}{ \u0026#34;detail-type\u0026#34;: \u0026amp;[]*string{ jsii.String(\u0026#34;CloudFormation Resource Status Change\u0026#34;), jsii.String(\u0026#34;CloudFormation Stack Status Change\u0026#34;), jsii.String(\u0026#34;CloudFormation Drift Detection Status Change\u0026#34;), }, \u0026#34;region\u0026#34;: \u0026amp;[]*string{ region, }, \u0026#34;resources\u0026#34;: \u0026amp;[]interface{}{ \u0026amp;map[string]*string{ \u0026#34;prefix\u0026#34;: jsii.String(\u0026#34;arn:aws:cloudformation:ap-northeast-1:000000000000:stack/TestStack\u0026#34;), }, }, }, Targets: \u0026amp;[]interface{}{ \u0026amp;map[string]*string{ \u0026#34;arn\u0026#34;: jsii.String(\u0026#34;arn:aws:sns:ap-northeast-1:000000000000:TestTopic\u0026#34;), \u0026#34;id\u0026#34;: jsii.String(\u0026#34;Target0\u0026#34;), }, }, }) ã¾ã¨ã‚ AWS CDK v2 ã§ Go è¨€èªã‚’ä½¿ç”¨ã—ãŸå ´åˆã® L1 Constructs ã«ã‚ˆã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®å®šç¾©æ–¹æ³•ã«ã¤ã„ã¦æ›¸ãã¾ã—ãŸã€‚\nv2 ã§ Go ãŒã‚µãƒãƒ¼ãƒˆã•ã‚ŒãŸã¨ã¯ã„ãˆ TypeScript ã§ã®åˆ©ç”¨ãŒå¤§å¤šæ•°ã®ã‚ˆã†ã§ã€ãªã‹ãªã‹ Go ã‚’åˆ©ç”¨ã—ãŸå ´åˆã®æƒ…å ±ãŒãªãå¤§å¤‰ã ã£ãŸã‚“ã§ã™ãŒã€å®Œå…¨ã«ç†è§£ã—ãŸæ°—ãŒã—ã¾ã™ã€‚\nä»Šå›ã®å†…å®¹ã‚’ä½¿ã£ãŸãã®ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã‚‚åˆã‚ã›ãŸå®Ÿè£…ä¾‹ã¯ä¸‹è¨˜ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã„ã¦ã„ã¾ã™ã®ã§ã€å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚\naws-cdk-go-examples/cloudformation-events-to-slack at main Â· michimani/aws-cdk-go-examples EventBridge ãƒ«ãƒ¼ãƒ«ç”¨ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½œæˆã™ã‚‹ \u0026#160;\u0026#x21a9;\u0026#xfe0e;\nä»–ã«ã‚‚æ•°å€¤ã®ç¯„å›²ã«ã‚ˆã‚‹ãƒãƒƒãƒãªã©ãŒå¯èƒ½ Amazon EventBridge ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ - Amazon EventBridge \u0026#160;\u0026#x21a9;\u0026#xfe0e;\n",
    "permalink": "https://michimani.net/post/aws-use-aws-cdk-l1-constructs-with-golang/",
    "title": "AWS CDK v2 (Go) ã§ L1 Constructs ã‚’ä½¿ã†"
  },
  {
    "contents": "Terraform ã¨OpenSearch CLI ã§ OpenSearch Service ã«å…¥é–€ã—ã¦ã¿ãŸã®ã§ã€ãã®ãƒ¡ãƒ¢ã§ã™ã€‚\nç›®æ¬¡ ã‚„ã‚‹ã“ã¨ ã¨ã‚Šã‚ãˆãšè©¦ã—ãŸã„ Terraform ã§ OpenSearch Service ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å®šç¾©ã™ã‚‹ ãƒ‰ãƒ¡ã‚¤ãƒ³ ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ variables.tf ã‚’ä½œæˆã—ã¦ apply OpenSearch CLI ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã‚‹ OpenSearch CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š Read Only ãªãƒ­ãƒ¼ãƒ«ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã‚‹ Write ã‚‚è¨±å¯ã•ã‚Œã¦ãŸãƒ­ãƒ¼ãƒ«ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã‚‹ ã¾ã¨ã‚ ã‚„ã‚‹ã“ã¨ Terraform ã§ OpenSearch Service ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å®šç¾©ã™ã‚‹ ã‚¨ãƒ³ã‚¸ãƒ³ã¯ OpenSearch v1.x ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ã§ OpenSearch ã«å¯¾ã—ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ¶é™ã™ã‚‹ æ§‹ç¯‰ã—ãŸ OpenSearch ã‚¯ãƒ©ã‚¹ã‚¿ã« OpenSearch CLI ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã‚‹ ç•°ãªã‚‹ IAM ãƒ­ãƒ¼ãƒ«ã§èªè¨¼ã—ã¦ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ã®æŒ™å‹•ã‚’ç¢ºèªã™ã‚‹ ã¨ã‚Šã‚ãˆãšè©¦ã—ãŸã„ ä»¥é™ã¯â†‘ã®å†…å®¹ã‚’é †ç•ªã«æ›¸ã„ã¦ã„ãã ã‘ãªã®ã§ã€ã‚‚ã—å®Ÿéš›ã«è©¦ã—ãŸã„ã¨ã„ã†æ–¹ã¯ä¸‹è¨˜ãƒªãƒã‚¸ãƒˆãƒªã‚’ clone ã—ã¦è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ terraform/README.md ã‚’èª­ã‚“ã§ã‚‚ã‚‰ãˆã‚Œã°è«¸ã€…è©¦ã›ã¾ã™ã€‚\nmichimani/get-started-opensearch: Hello OpenSearch. Terraform ã§ OpenSearch Service ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å®šç¾©ã™ã‚‹ ä¸‹è¨˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã€ OpenSearch Service ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å®šç¾©ã—ã¾ã™ã€‚\naws_opensearch_domain | Resources | hashicorp/aws | Terraform Registry ãƒ‰ãƒ¡ã‚¤ãƒ³ æœ€å°æ§‹æˆã ã¨ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚\nresource \u0026#34;aws_opensearch_domain\u0026#34; \u0026#34;first_opensearch\u0026#34; { domain_name = \u0026#34;first-opensearch\u0026#34; engine_version = \u0026#34;OpenSearch_1.2\u0026#34; cluster_config { instance_type = \u0026#34;t3.small.search\u0026#34; } ebs_options { ebs_enabled = true volume_size = 10 } } OpenSearch Service ã§æŒ‡å®šã§ãã‚‹ã‚¨ãƒ³ã‚¸ãƒ³ã¯ aws opensearch list-versions ã§ç¢ºèªã§ãã¾ã™ã€‚2022/07/04 ç¾åœ¨ã ã¨ä¸‹è¨˜ã®ã‚¨ãƒ³ã‚¸ãƒ³ãŒæŒ‡å®šå¯èƒ½ã§ã™ã€‚\n{ \u0026#34;Versions\u0026#34;: [ \u0026#34;OpenSearch_1.2\u0026#34;, \u0026#34;OpenSearch_1.1\u0026#34;, \u0026#34;OpenSearch_1.0\u0026#34;, \u0026#34;Elasticsearch_7.10\u0026#34;, \u0026#34;Elasticsearch_7.9\u0026#34;, \u0026#34;Elasticsearch_7.8\u0026#34;, \u0026#34;Elasticsearch_7.7\u0026#34;, \u0026#34;Elasticsearch_7.4\u0026#34;, \u0026#34;Elasticsearch_7.1\u0026#34;, \u0026#34;Elasticsearch_6.8\u0026#34;, \u0026#34;Elasticsearch_6.7\u0026#34;, \u0026#34;Elasticsearch_6.5\u0026#34;, \u0026#34;Elasticsearch_6.4\u0026#34;, \u0026#34;Elasticsearch_6.3\u0026#34;, \u0026#34;Elasticsearch_6.2\u0026#34;, \u0026#34;Elasticsearch_6.0\u0026#34;, \u0026#34;Elasticsearch_5.6\u0026#34;, \u0026#34;Elasticsearch_5.5\u0026#34;, \u0026#34;Elasticsearch_5.3\u0026#34;, \u0026#34;Elasticsearch_5.1\u0026#34;, \u0026#34;Elasticsearch_2.3\u0026#34;, \u0026#34;Elasticsearch_1.5\u0026#34; ] } ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ ä»Šå›ã¯ã€æ§‹ç¯‰ã™ã‚‹ OpenSearch ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«å¯¾ã—ã¦ Read (GET ã‚¢ã‚¯ã‚»ã‚¹) ã®ã¿å¯èƒ½ãª IAM ãƒ­ãƒ¼ãƒ«ã¨ Write (POST, PUT, DELETE ã‚¢ã‚¯ã‚»ã‚¹) ã‚‚å¯èƒ½ãª IAM ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã€ãã‚Œã‚‰ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¡Œã†ãŸã‚ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚ Terraform ã§ã®å®šç¾©ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\nresource \u0026#34;aws_opensearch_domain_policy\u0026#34; \u0026#34;first_domain_policy\u0026#34; { domain_name = aws_opensearch_domain.first_opensearch.domain_name access_policies = \u0026lt;\u0026lt;POLICIES { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Sid\u0026#34;: \u0026#34;AccessByAdministrator\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;AWS\u0026#34;: [ \u0026#34;arn:aws:iam::${data.aws_caller_identity.current.account_id}:role/demo/opensearch-admin\u0026#34; ] }, \u0026#34;Action\u0026#34;: [ \u0026#34;es:*\u0026#34; ], \u0026#34;Condition\u0026#34;: { \u0026#34;IpAddress\u0026#34;: { \u0026#34;aws:SourceIp\u0026#34;: [ \u0026#34;${var.my_ip}\u0026#34; ] } }, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:es:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:domain/first-opensearch/*\u0026#34; }, { \u0026#34;Sid\u0026#34;: \u0026#34;AccessByReadOnlyUser\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;AWS\u0026#34;: [ \u0026#34;arn:aws:iam::${data.aws_caller_identity.current.account_id}:role/demo/opensearch-read-only\u0026#34; ] }, \u0026#34;Action\u0026#34;: [ \u0026#34;es:ESHttpGet\u0026#34; ], \u0026#34;Condition\u0026#34;: { \u0026#34;IpAddress\u0026#34;: { \u0026#34;aws:SourceIp\u0026#34;: [ \u0026#34;${var.my_ip}\u0026#34; ] } }, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:es:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:domain/first-opensearch/*\u0026#34; } ] } POLICIES } opensearch-admin ã¨ã„ã†ãƒ­ãƒ¼ãƒ«ã«ã¯ es:* ã§ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨±å¯ã—ã€ opensearch-read-only ãƒ­ãƒ¼ãƒ«ã«ã¯ es:ESHttpGet ã§ GET ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿è¨±å¯ã—ã¾ã™ã€‚ã¾ãŸã€ä»Šå›ã¯ Condition ã§ç‰¹å®šã® IP ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿è¨±å¯ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚\nIAM ãƒ­ãƒ¼ãƒ«ã®æ–¹ã®å®šç¾©ã¯ã“ã¡ã‚‰ã€‚\nresource \u0026#34;aws_iam_role\u0026#34; \u0026#34;opensearch_ro_role\u0026#34; { name = \u0026#34;opensearch-read-only\u0026#34; path = \u0026#34;/demo/\u0026#34; assume_role_policy = \u0026lt;\u0026lt;POLICY { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;AWS\u0026#34;: \u0026#34;${var.iam_user_arn}\u0026#34; }, \u0026#34;Action\u0026#34;: \u0026#34;sts:AssumeRole\u0026#34; } ] } POLICY } resource \u0026#34;aws_iam_role\u0026#34; \u0026#34;opensearch_admin_role\u0026#34; { name = \u0026#34;opensearch-admin\u0026#34; path = \u0026#34;/demo/\u0026#34; assume_role_policy = \u0026lt;\u0026lt;POLICY { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;AWS\u0026#34;: \u0026#34;${var.iam_user_arn}\u0026#34; }, \u0026#34;Action\u0026#34;: \u0026#34;sts:AssumeRole\u0026#34; } ] } POLICY } ç‰¹å®šã® IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã—ã¦ä½¿ã†ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚ ${var.iam_user_arn} ã«ã¯ã€å®Ÿéš›ã«ã“ã‚Œã‚‰ã®ãƒ­ãƒ¼ãƒ«ã«ã‚¹ã‚¤ãƒƒãƒã™ã‚‹ IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® ARN ã‚’ variable ã§æŒ‡å®šã—ã¾ã™ã€‚\nvariables.tf ã‚’ä½œæˆã—ã¦ apply variables.tf ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªå½¢ã§ä½œæˆã—ã¦ãŠãã¾ã™ã€‚\nvariable \u0026#34;my_ip\u0026#34; { default = \u0026#34;203.0.113.0\u0026#34; // Your machine\u0026#39;s global IP address. } variable \u0026#34;iam_user_arn\u0026#34; { default = \u0026#34;arn:aws:iam::000000000000:user/hoge\u0026#34; // ARN of the IAM User for which AWS CLI credentials have been set up. } è‡ªèº«ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèªã«ã¯ã€\ncurl -X GET \u0026#39;https://checkip.amazonaws.com/\u0026#39; ãŒã‚·ãƒ³ãƒ—ãƒ«ãªã®ã§ãŠã™ã™ã‚ã§ã™ã€‚\nã‚ã¨ã¯ terraform apply ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚åˆå›ã® apply ã«ã¯ 15 åˆ†ç¨‹åº¦ã‹ã‹ã‚Šã¾ã™ã€‚\nOpenSearch CLI ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã‚‹ OpenSearch ã®ã‚¯ãƒ©ã‚¹ã‚¿ãŒæ§‹ç¯‰ã§ããŸã‚‰ã€ OpenSearch CLI ã‚’ä½¿ã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã¾ã™ã€‚\nOpenSearch CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ä¸‹è¨˜ãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚\nOpensearch 2.0.1 Â· OpenSearch macOS ã®å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ© (pkg) å½¢å¼ãªã®ã§ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ã®æŒ‡ç¤ºã«å¾“ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚\nãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š OpenSearch CLI ã¯ã„ãã¤ã‹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ä½¿ã„åˆ†ã‘ã‚‹äº‹ãŒã§ãã¾ã™ã€‚ AWS CLI ã§ã„ã† --profile ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¿ãŸã„ãªã®ãŒã‚ã‚Šã¾ã™ã€‚\nãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«ã¯ OpenSearch ã‚¯ãƒ©ã‚¹ã‚¿ã® URL ã¨ã€èªè¨¼æ–¹æ³•ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\nã¾ãšã€ OpenSearch ã‚¯ãƒ©ã‚¹ã‚¿ã® URL ã‚’å–å¾—ã—ã¾ã™ã€‚\nä»Šå›ã¯ first-opensearch ã¨ã„ã†åå‰ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½œæˆã—ãŸã®ã§ã€ä¸‹è¨˜ã® AWS CLI ã‚³ãƒãƒ³ãƒ‰ã§ URL (ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ) ã‚’å–å¾—ã—ã¾ã™ã€‚\nENDPOINT=$( aws opensearch describe-domain \\ --domain-name \u0026#39;first-opensearch\u0026#39; \\ --query \u0026#39;DomainStatus.join(``,[`https://`,Endpoint])\u0026#39; \\ --output text ) \u0026amp;\u0026amp; echo \u0026#34;${ENDPOINT}\u0026#34; ç¶šã„ã¦èªè¨¼æ–¹æ³•ã«ã¤ã„ã¦ã§ã™ãŒã€ OpenSearch CLI ã§ã¯ä¸‹è¨˜ã® 3 ã®èªè¨¼æ–¹æ³•ãŒæŒ‡å®šã§ãã¾ã™ã€‚\ndisabled basic cert aws-iam ä»Šå›ã¯ã€ IAM ãƒ­ãƒ¼ãƒ«ã§ã®èªè¨¼ã‚’è¡Œã†ã®ã§ aws-iam ã‚’èªè¨¼æ–¹æ³•ã¨ã—ã¦æŒ‡å®šã—ã¾ã™ã€‚\nãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«ã¯ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\nopensearch-cli profile create \\ --auth-type aws-iam \\ --endpoint \u0026#34;${ENDPOINT}\u0026#34; \\ --name env-role aws-iam ã‚’æŒ‡å®šã—ãŸå ´åˆã€èªè¨¼ã«ä½¿ç”¨ã™ã‚‹ AWS ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¨ AWS ã®ã‚µãƒ¼ãƒ“ã‚¹åã‚’èã‹ã‚Œã¾ã™ã€‚\nãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢ã—ã¦ã¯ç‰¹å®šã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹äº‹ã‚‚ã§ãã¾ã™ãŒã€æŒ‡å®šã—ãªã„å ´åˆã¯å®Ÿè¡Œç’°å¢ƒã®ç’°å¢ƒå¤‰æ•°ã‚’ã‚‚ã¨ã«èªè¨¼ã«ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã™ã€‚ä»Šå›ã¯ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã£ã¦ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã„åˆ†ã‘ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚\nAWS ã®ã‚µãƒ¼ãƒ“ã‚¹åã¯ã€ es ã¾ãŸã¯ ec2 ã§æŒ‡å®šã—ã¾ã™ã€‚ä»Šå›ã¯ es ã‚’æŒ‡å®šã—ã¾ã™ã€‚ (OpenSearch Service ã§ã™ãŒ es ã§ã™)\nRead Only ãªãƒ­ãƒ¼ãƒ«ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã‚‹ ã¾ãšã¯ Read Only ãªãƒ­ãƒ¼ãƒ« opensearch-read-only ã«ã‚¹ã‚¤ãƒƒãƒã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã¾ã™ã€‚\nã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã™ã‚‹ã«ã¯ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\nSWITCH_CMD=$( \\ aws sts assume-role \\ --role-arn $(aws iam list-roles \\ --path-prefix \u0026#39;/demo\u0026#39; \\ --query \u0026#39;Roles[?contains(to_string(RoleName), `opensearch-read-only`)].Arn\u0026#39; \\ --output text) \\ --role-session-name \u0026#39;opensearch-read-only\u0026#39; \\ --query \u0026#39;Credentials.join(``,[`export AWS_ACCESS_KEY_ID=\\\u0026#34;`,AccessKeyId,`\\\u0026#34; AWS_SECRET_ACCESS_KEY=\\\u0026#34;`,SecretAccessKey,`\\\u0026#34; AWS_SESSION_TOKEN=\\\u0026#34;`,SessionToken,`\\\u0026#34;`])\u0026#39; \\ --output text) \\ \u0026amp;\u0026amp; eval ${SWITCH_CMD} \\ \u0026amp;\u0026amp; aws sts get-caller-identity ã¡ãªã¿ã«ã€ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ AWS CLI ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¨ã—ã¦ã„ã„æ„Ÿã˜ã«è¨­å®šã—ã¦ãŠãã“ã¨ã§ã€ AWS CLI ã§ã®ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ãŒã‚ã¡ã‚ƒãã¡ã‚ƒç°¡å˜ã«ãªã‚‹ã‚ˆ ã¨ã„ã†ã®ã‚’åˆ¥è¨˜äº‹ã§æ›¸ã„ã¦ã„ã‚‹ã®ã§å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚\nAWS CLI ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½¿ã£ã¦ãƒ¡ãƒãƒ£ã‚¯ãƒãƒ£ç°¡å˜ã«ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¿ãŸ - michimani.net opensearch-read-only ãƒ­ãƒ¼ãƒ«ã«ã‚¹ã‚¤ãƒƒãƒã§ããŸã‚‰ã€ GET ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã¾ã™ã€‚\n$ opensearch-cli curl get \\ --path \u0026#39;_cluster/health\u0026#39; \\ --output-format yaml \\ --profile env-role --- cluster_name: \u0026#34;000000000000:first-opensearch\u0026#34; status: \u0026#34;green\u0026#34; timed_out: false number_of_nodes: 1 number_of_data_nodes: 1 discovered_master: true active_primary_shards: 1 active_shards: 1 relocating_shards: 0 initializing_shards: 0 unassigned_shards: 0 delayed_unassigned_shards: 0 number_of_pending_tasks: 0 number_of_in_flight_fetch: 0 task_max_waiting_in_queue_millis: 0 active_shards_percent_as_number: 100.0 ç¶šã„ã¦ PUT ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã¾ã™ã€‚\n$ opensearch-cli curl put \\ --path \u0026#39;demoindex\u0026#39; \\ --profile env-role { \u0026#34;Message\u0026#34;: \u0026#34;User: arn:aws:sts::000000000000:assumed-role/opensearch-read-only/opensearch-read-only is not authorized to perform: es:ESHttpPut because no identity-based policy allows the es:ESHttpPut action\u0026#34; } ã“ã¡ã‚‰ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã—ãŸã€‚\nã“ã“ã¾ã§çµ‚ã‚ã£ãŸã‚‰ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã‚’è§£é™¤ã™ã‚‹ãŸã‚ã«ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\nunset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN Write ã‚‚è¨±å¯ã•ã‚Œã¦ãŸãƒ­ãƒ¼ãƒ«ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã‚‹ æ¬¡ã« Write ã‚‚è¨±å¯ã•ã‚ŒãŸãƒ­ãƒ¼ãƒ« opensearch-admin ã«ã‚¹ã‚¤ãƒƒãƒã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã¾ã™ã€‚\nopensearch-admin ã«ã‚¹ã‚¤ãƒƒãƒã™ã‚‹ã«ã¯ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\nSWITCH_CMD=$( \\ aws sts assume-role \\ --role-arn $(aws iam list-roles \\ --path-prefix \u0026#39;/demo\u0026#39; \\ --query \u0026#39;Roles[?contains(to_string(RoleName), `opensearch-admin`)].Arn\u0026#39; \\ --output text) \\ --role-session-name \u0026#39;opensearch-admin\u0026#39; \\ --query \u0026#39;Credentials.join(``,[`export AWS_ACCESS_KEY_ID=\\\u0026#34;`,AccessKeyId,`\\\u0026#34; AWS_SECRET_ACCESS_KEY=\\\u0026#34;`,SecretAccessKey,`\\\u0026#34; AWS_SESSION_TOKEN=\\\u0026#34;`,SessionToken,`\\\u0026#34;`])\u0026#39; \\ --output text) \\ \u0026amp;\u0026amp; eval ${SWITCH_CMD} \\ \u0026amp;\u0026amp; aws sts get-caller-identity Read Only ã®ã¨ãã«å¤±æ•—ã—ãŸ PUT ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã¾ã™ã€‚\n$ opensearch-cli curl put \\ --path \u0026#39;demoindex\u0026#39; \\ --profile env-role {\u0026#34;acknowledged\u0026#34;:true,\u0026#34;shards_acknowledged\u0026#34;:true,\u0026#34;index\u0026#34;:\u0026#34;demoindex\u0026#34;} ä»Šåº¦ã¯æˆåŠŸã—ã¾ã—ãŸã€‚ç¶šã„ã¦ DELETE ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚‚æŠ•ã’ã¦ã¿ã¾ã™ã€‚\n$ opensearch-cli curl delete \\ --path \u0026#39;demoindex\u0026#39; \\ --profile env-role {\u0026#34;acknowledged\u0026#34;:true} ã“ã¡ã‚‰ã‚‚æˆåŠŸã—ã¾ã—ãŸã€‚\nã“ã“ã¾ã§çµ‚ã‚ã£ãŸã‚‰ã€å¿˜ã‚Œãšã«ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã‚’è§£é™¤ã—ã¦ãŠãã¾ã™ã€‚\nunset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN ã¾ã¨ã‚ Terraform ã§ OpenSearch Service ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒãƒªã‚·ãƒ¼ã‚’å®šç¾©ã—ãŸ OpenSearch CLI ã§ OpenSearch ã®ã‚¯ãƒ©ã‚¹ã‚¿ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ãŸ å‰¯ä½œç”¨ã¨ã—ã¦ AWS CLI ã§ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã™ã‚‹ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ãŒç”Ÿã¾ã‚ŒãŸ ",
    "permalink": "https://michimani.net/post/aws-get-started-opensearch-service-via-terraform/",
    "title": "Terraform ã¨ OpenSearch CLI ã§ OpenSearch Service ã«å…¥é–€ã™ã‚‹"
  },
  {
    "contents": "AWS CLI ã§ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã™ã‚‹å ´åˆã€ sts assume-role ã§èªè¨¼æƒ…å ±ã‚’å–å¾—ã—ã€ãã‚Œã‚’ç’°å¢ƒå¤‰æ•°ãªã‚Š ~/.aws/credentials ã«è¿½è¨˜ã—ãŸã‚Šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã•ãã£ã¨ã‚¹ã‚¤ãƒƒãƒã—ãŸã„ã ã‘ãªã®ã«å°‘ã€…æ‰‹é–“ãŒã‹ã‹ã‚‹ã®ã§ã€ AWS CLI ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½¿ã£ã¦ã‚³ãƒãƒ³ãƒ‰ä¸€ã¤ã§ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚\nçµè«– ã“ã‚Œã§ã™ã€‚\nawscli-aliases/alias at 9edd908f2d27c8a4acf07a6dc31ce7d19dc6ced3 Â· michimani/awscli-aliases AWS CLI ã§ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã™ã‚‹æµã‚Œ ãã‚‚ãã‚‚ã®ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã®ä»•çµ„ã¿ã¨ AWS CLI ã§ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¯ä¸‹è¨˜ã® AWS Blog ã®è¨˜äº‹ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚\nIAM ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«: AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé–“ã® IAM ãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ã®å§”ä»» - AWS Identity and Access Management AWS CLI ã§ã®æµã‚Œã‚’è¦ç´„ã™ã‚‹ã¨ä¸‹è¨˜ã®é€šã‚Šã¨ãªã‚Šã¾ã™ã€‚\naws sts assume-role ã‚³ãƒãƒ³ãƒ‰ã§ã€ã‚¹ã‚¤ãƒƒãƒã—ãŸã„ãƒ­ãƒ¼ãƒ«ã®ä¸€æ™‚èªè¨¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹ å–å¾—ã—ãŸèªè¨¼æƒ…å ±ã‹ã‚‰ã€å¿…è¦ãªå€¤ã‚’ä¸‹è¨˜ã®ç’°å¢ƒå¤‰æ•°ã«ãã‚Œãã‚Œè¨­å®šã™ã‚‹ AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN ãŸã£ãŸã“ã‚Œã ã‘ã§ã™ãŒã€ 2 ã®éƒ¨åˆ†ãŒå¤šå°‘æ‰‹é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚ã¨ã„ã†ã®ã‚‚ã€æ™®é€šã«ã‚„ã‚‹ã¨ sts assume-role ã®å®Ÿè¡Œçµæœã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’ã‚³ãƒ”ãƒšã—ã¦ãã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚\nã“ã®æ‰‹é † 1, 2 ã‚’ --query ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã„ã„æ„Ÿã˜ã«ã—ã¦ã¿ã¾ã™ã€‚\nquery ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã§æ›¸ã ã¾ãšã¯ã€æ‰‹é † 1 ã§å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰ã€‚\nä»Šå›ã¯ã€ä¾‹ã¨ã—ã¦ä¸‹è¨˜ã®ã‚ˆã†ãª IAM ãƒ­ãƒ¼ãƒ«ã«ã‚¹ã‚¤ãƒƒãƒã—ãŸã„ã¨ã—ã¾ã™ã€‚ (iam get-role ã®å‡ºåŠ›ã®ä¸€éƒ¨ã‚’æŠœç²‹)\n{ \u0026#34;Role\u0026#34;: { \u0026#34;Path\u0026#34;: \u0026#34;/demo/\u0026#34;, \u0026#34;RoleName\u0026#34;: \u0026#34;target-role\u0026#34;, \u0026#34;RoleId\u0026#34;: \u0026#34;AROA2XXXXXXXXXXXXXXXX\u0026#34;, \u0026#34;Arn\u0026#34;: \u0026#34;arn:aws:iam::00000000:role/demo/target-role\u0026#34;, } } ä¸Šè¨˜ã®ãƒ­ãƒ¼ãƒ«ã«ã‚¹ã‚¤ãƒƒãƒã™ã‚‹ãŸã‚ã«ã¯ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\naws sts assume-role \\ --role-arn \u0026#39;arn:aws:iam::00000000:role/demo/target-role\u0026#39; --role-session-name \u0026#39;switch-to-target-role\u0026#39; æ­£å¸¸ã«å®Ÿè¡Œã§ãã‚Œã°ã€ä¸‹è¨˜ã®ã‚ˆã†ãªå‡ºåŠ›ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚\n{ \u0026#34;Credentials\u0026#34;: { \u0026#34;AccessKeyId\u0026#34;: \u0026#34;ASIAXXXXXXXXXXXXXXXX\u0026#34;, \u0026#34;SecretAccessKey\u0026#34;: \u0026#34;FbNIxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\u0026#34;, \u0026#34;SessionToken\u0026#34;: \u0026#34;IQxxxxx...............xxxxx+4w==\u0026#34;, \u0026#34;Expiration\u0026#34;: \u0026#34;2022-06-30T16:05:13+00:00\u0026#34; }, \u0026#34;AssumedRoleUser\u0026#34;: { \u0026#34;AssumedRoleId\u0026#34;: \u0026#34;AROA2XXXXXXXXXXXXXXXX:switch-to-target-role\u0026#34;, \u0026#34;Arn\u0026#34;: \u0026#34;arn:aws:sts::00000000:assumed-role/target-role/switch-to-target-role\u0026#34; } } ã“ã®ä¸­ã‹ã‚‰ã€ AccessKeyId ã€ SecretAccessKey ã€SessionToken ã‚’ãã‚Œãã‚Œç’°å¢ƒå¤‰æ•° AWS_ACCESS_KEY_ID ã€ AWS_SECRET_ACCESS_KEY ã€ AWS_SESSION_TOKEN ã«è¨­å®šã™ã‚‹ã“ã¨ã§ã‚¹ã‚¤ãƒƒãƒã—ãŸãƒ­ãƒ¼ãƒ«ã§ AWS CLI ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\nLinux ã¾ãŸã¯ macOS ã§ã¯ç’°å¢ƒå¤‰æ•°ã®è¨­å®šã«ã¯ export ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ã€ --query ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ç’°å¢ƒå¤‰æ•°è¨­å®šç”¨ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚\naws sts assume-role \\ --role-arn \u0026#39;arn:aws:iam::00000000:role/demo/target-role\u0026#39; --role-session-name \u0026#39;switch-to-target-role\u0026#39; --query \u0026#39;Credentials.join(``,[`export AWS_ACCESS_KEY_ID=\\\u0026#34;`,AccessKeyId,`\\\u0026#34; AWS_SECRET_ACCESS_KEY=\\\u0026#34;`,SecretAccessKey,`\\\u0026#34; AWS_SESSION_TOKEN=\\\u0026#34;`,SessionToken,`\\\u0026#34;`])\u0026#39; \\ --output text å‡ºåŠ›ã¨ã—ã¦ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\nexport AWS_ACCESS_KEY_ID=\u0026#34;FbNIxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\u0026#34; AWS_SECRET_ACCESS_KEY=\u0026#34;IQxxxxx...............xxxxx+4w==\u0026#34; AWS_SESSION_TOKEN=\u0026#34;IQxxxxx...............xxxxx+4w==\u0026#34; ã“ã‚Œã‚’ã‚³ãƒ”ãƒšã—ã¦å®Ÿè¡Œã™ã‚Œã°ã„ã„ã®ã§ã™ãŒã€ãã‚Œã‚‚ã‚³ãƒãƒ³ãƒ‰ã§ã‚„ã£ã¦ã—ã¾ã„ã¾ã™ã€‚\nã“ã®å‡ºåŠ›ã‚’ä¸€æ—¦å¤‰æ•°ã«å…¥ã‚Œã€ãã‚Œã‚’ eval ã§å±•é–‹ã—ã¦å®Ÿè¡Œã—ã¾ã™ã€‚\nSWITCH_CMD=$( \\ aws sts assume-role \\ --role-arn $( \\ aws iam get-role \\ --role-name \u0026#39;target-role\u0026#39; \\ --query \u0026#39;Role.Arn\u0026#39; \\ --output text) \\ --role-session-name \u0026#39;switch-to-target-role\u0026#39; \\ --query \u0026#39;Credentials.join(``,[`export AWS_ACCESS_KEY_ID=\\\u0026#34;`,AccessKeyId,`\\\u0026#34; AWS_SECRET_ACCESS_KEY=\\\u0026#34;`,SecretAccessKey,`\\\u0026#34; AWS_SESSION_TOKEN=\\\u0026#34;`,SessionToken,`\\\u0026#34;`])\u0026#39; \\ --output text) \\ \u0026amp;\u0026amp; eval ${SWITCH_CMD} \\ \u0026amp;\u0026amp; aws sts get-caller-identity eval ã§ export ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‚ã¨ã¯ã€æ­£å¸¸ã«ã‚¹ã‚¤ãƒƒãƒã§ãã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã« aws sts get-caller-identity ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚\nå®Ÿè¡Œçµæœã¨ã—ã¦ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚\n{ \u0026#34;UserId\u0026#34;: \u0026#34;AROA2XXXXXXXXXXXX:switch-to-target-role\u0026#34;, \u0026#34;Account\u0026#34;: \u0026#34;000000000000\u0026#34;, \u0026#34;Arn\u0026#34;: \u0026#34;arn:aws:sts::000000000000:assumed-role/target-role/switch-to-target-role\u0026#34; } ä»¥ä¸Šã§ã€ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã§ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚æœ€å¾Œã«ã€ã“ã‚Œã‚’ AWS CLI ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦è¨­å®šã—ã€ã‚ˆã‚Šç°¡å˜ã«ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã™ã€‚\nAWS CLI ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚³ãƒãƒ³ãƒ‰ã‚’è¨­å®šã™ã‚‹ AWS CLI ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãŒä»»æ„ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚³ãƒãƒ³ãƒ‰ã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚\nAWS CLI ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®ä½œæˆã¨ä½¿ç”¨ - AWS Command Line Interface ä¾‹ãˆã°ã€ä¸‹è¨˜ã®ã‚ˆã†ãªã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¨­å®šã—ã¦ãŠã‘ã° aws id ã¨å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ ID ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\nid = sts get-caller-identity \\ --query \u0026#39;Account\u0026#39; \\ --output text ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã«ã¯å¼•æ•°ã§å€¤ã‚’æ¸¡ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ä»Šå›ã§ã‚ã‚Œã°å¯å¤‰ãªã®ã¯ãƒ­ãƒ¼ãƒ«åã®ã¿ãªã®ã§ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®å¼•æ•°ã«ãƒ­ãƒ¼ãƒ«åã‚’æ¸¡ã™ã‚ˆã†ã«ã™ã‚Œã°ã‚ˆã„ã®ã§ã€ä¸‹è¨˜ã®ã‚ˆã†ãªã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¨­å®šã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚\nswitch-role = !f() { SWITCH_CMD=$( \\ aws sts assume-role \\ --role-arn $( \\ aws iam get-role \\ --role-name \u0026#34;${1}\u0026#34; \\ --query \u0026#39;Role.Arn\u0026#39; \\ --output text) \\ --role-session-name \u0026#34;switch-to-${1}\u0026#34; \\ --query \u0026#39;Credentials.join(``,[`export AWS_ACCESS_KEY_ID=\\\u0026#34;`,AccessKeyId,`\\\u0026#34; AWS_SECRET_ACCESS_KEY=\\\u0026#34;`,SecretAccessKey,`\\\u0026#34; AWS_SESSION_TOKEN=\\\u0026#34;`,SessionToken,`\\\u0026#34;`])\u0026#39; \\ --output text) \\ \u0026amp;\u0026amp; eval ${SWITCH_CMD} \\ \u0026amp;\u0026amp; aws sts get-caller-identity }; f ã‚ã¨ã¯ aws switch-role 'target-role' ã¨å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã§ãã¾ã™ã€‚\nã•ã„ã”ã« AWS CLI ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã„ã„ã ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼æœ€é«˜ ã©ã‚“ã©ã‚“ã‚¹ã‚¤ãƒƒãƒã—ãŸããªã‚‹ ã¡ãªã¿ã«ã€å…ƒã®ãƒ­ãƒ¼ãƒ«ã«æˆ»ã‚ŠãŸã„å ´åˆã¯ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦å„ç’°å¢ƒå¤‰æ•°ã®å€¤ã‚’ã‚¯ãƒªã‚¢ã™ã‚Œã° OK ã§ã™ã€‚\nunset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN ",
    "permalink": "https://michimani.net/post/aws-switch-role-via-aws-cli/",
    "title": "AWS CLI ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½¿ã£ã¦ãƒ¡ãƒãƒ£ã‚¯ãƒãƒ£ç°¡å˜ã«ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¿ãŸ"
  },
  {
    "contents": "Google Analytics ã®ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ (UA) ãŒ 2023å¹´ 7æœˆã«å»ƒæ­¢ã•ã‚Œã€ãã‚Œä»¥é™ã¯ Google Analytics 4 (GA4) ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ã  UA å»ƒæ­¢ã¾ã§ã®çŒ¶äºˆã¯ã‚ã‚Šã¾ã™ãŒã€PV ç­‰ã®å„å€¤ã‚’æ¯”è¼ƒã—ãŸããªã£ãŸã¨ãã« 1 å¹´å‰ã®ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„ã¨å›°ã‚‹ã®ã§ã€ãªã‚‹ã¯ã‚„ã§ç§»è¡Œã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»Šå›ã¯ã€ã¨ã‚Šã‚ãˆãšã“ã®ãƒ–ãƒ­ã‚°ã‚’ UA ã‹ã‚‰ GA4 ã«ç§»è¡Œã—ã¦ã¿ã¾ã™ã€‚\nãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ« ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã®ã‚µãƒãƒ¼ãƒˆã¯çµ‚äº†ã—ã¾ã™ - ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ ãƒ˜ãƒ«ãƒ— ã‚„ã‚‹ã“ã¨ GA4 ã«åˆ‡ã‚Šæ›¿ãˆã¦ã„ãªã„çŠ¶æ…‹ã§å¯¾è±¡ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ç”»é¢ã‚’é–‹ãã¨ã€ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã«ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚\nã“ã“ã® [é–‹å§‹] ã‹ã‚‰ GA4 ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®šã—ã¦ã„ãã¾ã™ã€‚\nãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®è¨­å®šãŒã§ããŸã‚‰ã€ç™ºè¡Œã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ–ãƒ­ã‚°ã® \u0026lt;head\u0026gt; ã‚¿ã‚°å†…ã«é…ç½®ã—ã¾ã™ã€‚\nä»Šå›ã¯ã€ç´°ã‹ã„è¨­å®šã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ ã¨ã‚Šã‚ãˆãš GA4 ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ PV ã ã‘ã§ã‚‚è¨ˆæ¸¬ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ã‚’ã‚´ãƒ¼ãƒ«ã¨ã—ã¾ã™ã€‚\nGA4 ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®è¨­å®š å…ˆã»ã©ã® [é–‹å§‹] ã‚’æŠ¼ã™ã¨ä¸‹è¨˜ã®ã‚ˆã†ãªç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚\nä»Šå›ã¯æ–°ãŸã« GA4 ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½œæˆã—ã¾ã™ã€‚\næ–°ã—ã„ Google ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ 4 ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½œæˆã™ã‚‹ GA4 è¨­å®šã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®ç”»é¢ã‹ã‚‰ æ–°ã—ã„ Google ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ 4 ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ä½œæˆ ã‚’é–‹å§‹ã™ã‚‹ã¨ã€ä¸‹è¨˜ã®ã‚ˆã†ãªã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚\nã“ã“ã§ [ä½œæˆ] ã‚’æŠ¼ã™ã¨ã€ GA4 è¨­å®šã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®ç”»é¢ã«æˆ»ã‚Šã€ä¸‹è¨˜ã®ã‚ˆã†ãªè¡¨ç¤ºã«ãªã‚‹ã€‚\nGA4 ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒä½œæˆã•ã‚ŒãŸã€‚\nGA4 ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®æ©Ÿèƒ½ã®ç¢ºèªã¨è¨­å®šã‚’è¡Œã† [GA4 ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç¢ºèª] ã‚’æŠ¼ã™ã¨ GA4 ã®è¨­å®šç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚\næ­£ç›´ã€è¨­å®šé …ç›®ãŒå¤šã™ãã¦ã‚ˆãã‚ã‹ã‚‰ã‚“ã€‚ã®ã§ã€æ¬²ã‚’å‡ºã•ãšã« PV ã ã‘ã§ã‚‚è¨ˆæ¸¬ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ ã‚’ç›®æŒ‡ã™ã€‚\nãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒ  ã®é …ç›®ã‚’è¦‹ã‚‹ã¨ã€ä¸‹è¨˜ã®ã‚ˆã†ã«ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒå—ä¿¡ã§ãã¦ã„ã¾ã›ã‚“ã€‚(ãã‚Œã¯ãã†)\nã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ä¸€è¦§ã‹ã‚‰å¯¾è±¡ã®è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ä¸‹è¨˜ã®ã‚ˆã†ãªè©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚\nã‚¿ã‚°ã®è¨­å®šæ‰‹é † ã«ã‚ã‚‹é€šã‚Šã€ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§å„å€¤ã‚’è¨ˆæ¸¬ã™ã‚‹ã«ã¯ã„ãšã‚Œã‹ã®æ–¹æ³•ã§ãƒšãƒ¼ã‚¸ä¸Šã«ã‚¿ã‚°ã‚’åŸ‹ã‚è¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\nä»Šå›ã¯ æ–°ã—ã„ãƒšãƒ¼ã‚¸ä¸Šã®ã‚¿ã‚°ã‚’è¿½åŠ ã™ã‚‹ ã€ä¸”ã¤ GTM ã‚’ä½¿ã£ã¦ã„ãªã„ãŸã‚ gtag.js ã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•ã§é€²ã‚ã¾ã™ã€‚\nåŸ‹ã‚è¾¼ã‚€ã‚¿ã‚°ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªå½¢å¼ã§ã™ã€‚\n\u0026lt;!-- Global site tag (gtag.js) - Google Analytics --\u0026gt; \u0026lt;script async src=\u0026#34;https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXX\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script\u0026gt; window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag(\u0026#39;js\u0026#39;, new Date()); gtag(\u0026#39;config\u0026#39;, \u0026#39;G-XXXXXXXXX\u0026#39;); \u0026lt;/script\u0026gt; ã“ã‚Œã‚’ã“ã®ãƒ–ãƒ­ã‚°ã® \u0026lt;head\u0026gt;\u0026lt;/head\u0026gt; å†…ã«é…ç½®ã—ã¾ã™ã€‚\nGA4 ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¿ã‚°ã‚’ãƒ–ãƒ­ã‚°ã«è¨­ç½®ã™ã‚‹ ã“ã®ãƒ–ãƒ­ã‚°ã¯ Hugo ã§ç”Ÿæˆã—ã¦ãŠã‚Šã€ãƒ†ãƒ¼ãƒã«ã¯ Simplog ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚\nSimplog ã¯ UA ã®ã‚¿ã‚°åŸ‹ã‚è¾¼ã¿ã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã™ (UA-XXXXXX ã‚’ config.toml ã«è¿½è¨˜ã™ã‚‹ã ã‘ã§ OK) ãŒã€ GA4 ã®åŸ‹ã‚è¾¼ã¿ã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚ãŸã ã€ partials/additional-custom-head.html ã‚’ä½œæˆã™ã‚Œã° head å†…ã«ãã®å†…å®¹ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ partials/additional-custom-head.html ã«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¿ã‚°ã‚’è¨˜è¿°ã™ã‚‹æ–¹æ³•ã§å¯¾å¿œã—ã¾ã™ã€‚\nsimplog/head.html at c6940745f5b0751a408f3fc959f231b9ec624e5a Â· michimani/simplog ã‚†ãã‚†ãã¯ G-XXXXXXXXX ã®ã‚¿ã‚°ã‚’ config.toml ã«è¨˜è¿°ã™ã‚‹ã ã‘ã§ã‚¿ã‚°ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸã„ã€‚(ã—ã¦ãã‚Œã‚‹æ–¹ãŒã„ãŸã‚‰ PR ãŠå¾…ã¡ã—ã¦ã„ã¾ã™)\nè¨­ç½®ã—ã¦æ§˜å­ã‚’è¦‹ã‚‹ GA4 ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¿ã‚°ã‚’è¨­ç½®ã—ãŸã‚‰ã—ã°ã‚‰ãæ§˜å­ã‚’è¦‹ã¦ã€å…ˆã»ã©ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ç¢ºèªã—ã¾ã™ã€‚\nä»–ã«ã‚„ã‚‹ã“ã¨ GA4 ã®è¨­å®šã‚’è¦‹ã‚‹é™ã‚Šã ã¨\nGoogle Search Console ã¨ã®çµ±åˆ Google AdSense ã¨ã®çµ±åˆ ã‚ãŸã‚Šã¯è¨­å®šãŒå¿…è¦ãã†ã§ã™ã€‚\n",
    "permalink": "https://michimani.net/post/development-migrate-google-analytics-gav4/",
    "title": "Hugo ã§ç”Ÿæˆã—ã¦ã„ã‚‹ãƒ–ãƒ­ã‚°ã‚’ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã‹ã‚‰ Google Analytics 4 ã«ç§»è¡Œã™ã‚‹"
  }
]